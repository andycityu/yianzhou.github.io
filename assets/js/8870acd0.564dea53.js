"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2499],{652:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>r,contentTitle:()=>s,default:()=>c,frontMatter:()=>a,metadata:()=>l,toc:()=>g});var n=o(87462),i=(o(67294),o(3905));o(61839);const a={},s="Unified Logging",l={unversionedId:"unified-logging",id:"unified-logging",title:"Unified Logging",description:"WWDC 2016 - Unified Logging and Activity Tracing",source:"@site/docs/apple/unified-logging.md",sourceDirName:".",slug:"/unified-logging",permalink:"/docs/apple/unified-logging",draft:!1,editUrl:"https://github.com/yianzhou/yianzhou.github.io/docs/apple/unified-logging.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"UIScene",permalink:"/docs/apple/uiscene"},next:{title:"Uniform Type Identifiers",permalink:"/docs/apple/uniform-type-identifiers"}},r={},g=[{value:"Generating Log Messages",id:"generating-log-messages",level:2},{value:"Viewing Log Messages",id:"viewing-log-messages",level:2},{value:"Activity Tracing",id:"activity-tracing",level:2},{value:"Signpost Events",id:"signpost-events",level:2},{value:"Architecture",id:"architecture",level:2}],p={toc:g};function c(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"unified-logging"},"Unified Logging"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2016/721"},"WWDC 2016 - Unified Logging and Activity Tracing"))),(0,i.kt)("p",null,"Capture telemetry from your app for ",(0,i.kt)("strong",{parentName:"p"},"debugging")," and ",(0,i.kt)("strong",{parentName:"p"},"performance analysis")," using the ",(0,i.kt)("strong",{parentName:"p"},"unified logging system"),"."),(0,i.kt)("h2",{id:"generating-log-messages"},"Generating Log Messages"),(0,i.kt)("p",null,"You specify both strings when creating the log object, using values that are relevant to your app:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("strong",{parentName:"li"},"subsystem")," string identifies a large functional area within your app or apps. Use reverse-DNS notation for each subsystem string."),(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("strong",{parentName:"li"},"category")," string identifies a particular component or module in a given subsystem. For example, user interface, data model, and networking.")),(0,i.kt)("p",null,"You might use the default log to record messages that don\u2019t require a specific subsystem and category."),(0,i.kt)("p",null,"The system stores all messages in memory initially, and it writes messages with more severe log levels to disk. \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"debug"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"info")," \u5b58\u50a8\u5728\u5185\u5b58\uff1b",(0,i.kt)("inlineCode",{parentName:"p"},"default"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"error"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"fault")," \u6301\u4e45\u5316\u5230\u786c\u76d8\u3002"),(0,i.kt)("p",null,"Objc \u7528\u6cd5\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-objc"},'os_log_t log = os_log_create("com.yianzhou.DemoOSLog", "Objective-C");\nos_log(log, "Hello world! %d", 100);\nos_log_error(log, "Error %d", 404);\nos_log_with_type(log, OS_LOG_TYPE_ERROR, "Error %d", 404);\n')),(0,i.kt)("p",null,"Swift API\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-swift"},"@available(macOS 10.14, iOS 12.0, watchOS 5.0, tvOS 12.0, *)\npublic func os_log(_ type: OSLogType, dso: UnsafeRawPointer = #dsohandle, log: OSLog = .default, _ message: StaticString, _ args: CVarArg...)\n\n@available(macOS 10.12, iOS 10.0, watchOS 3.0, tvOS 10.0, *)\npublic func os_log(_ message: StaticString, dso: UnsafeRawPointer? = #dsohandle, log: OSLog = .default, type: OSLogType = .default, _ args: CVarArg...)\n\n@available(macOS 11.0, iOS 14.0, watchOS 7.0, tvOS 14.0, *)\npublic func os_log(_ message: OSLogMessage)\n\n@available(macOS 11.0, iOS 14.0, watchOS 7.0, tvOS 14.0, *)\npublic func os_log(_ logLevel: OSLogType = .default, log logObject: OSLog = .default, _ message: OSLogMessage)\n\n@available(macOS 11.0, iOS 14.0, watchOS 7.0, tvOS 14.0, *)\npublic struct Logger {\n    public func log(level: OSLogType, _ message: OSLogMessage)\n}\n")),(0,i.kt)("p",null,"Swift \u7528\u6cd5\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-swift"},'if #available(iOS 10.0, *) {\n    let log = OSLog(subsystem: "com.yianzhou.DemoOSLog", category: "swift")\n    os_log("Error! %d", log: log, type: .error, 404)\n    if #available(iOS 12.0, *) {\n        os_log(.default, log: log, "Hello world! %d", 100) // \u53c2\u6570\u987a\u5e8f\u4e0d\u4e00\u6837\uff0c\u5176\u5b83\u90fd\u4e00\u6837\n    }\n    if #available(iOS 14.0, *) {\n        let x = 100\n        os_log(.default, log: log, "A string interpolation \\(x)") // \u53ef\u4ee5\u4f7f\u7528 string interpolation\n        let logger = Logger(subsystem: "com.yianzhou.DemoOSLog", category: "swift")\n        logger.log(level: .error, "Error \\(x)")\n    }\n}\n')),(0,i.kt)("h2",{id:"viewing-log-messages"},"Viewing Log Messages"),(0,i.kt)("p",null,"The unified log system stores log messages in a ",(0,i.kt)("strong",{parentName:"p"},"binary compressed format"),", ",(0,i.kt)("strong",{parentName:"p"},"deferring")," much of the work to turn them into human-readable text messages."),(0,i.kt)("p",null,"You view log messages using the ",(0,i.kt)("strong",{parentName:"p"},"Console app"),", ",(0,i.kt)("strong",{parentName:"p"},"log command-line tool"),", or ",(0,i.kt)("strong",{parentName:"p"},"Xcode debug console"),"."),(0,i.kt)("p",null,"You can also access log messages programmatically using the ",(0,i.kt)("inlineCode",{parentName:"p"},"OSLog")," framework."),(0,i.kt)("p",null,"Log data is kept in a compressed binary format: ",(0,i.kt)("inlineCode",{parentName:"p"},".tracev3")," files stored under ",(0,i.kt)("inlineCode",{parentName:"p"},"/var/db/diagnostics/")," with support in ",(0,i.kt)("inlineCode",{parentName:"p"},"/var/db/uuidtext"),"."),(0,i.kt)("p",null,"New ",(0,i.kt)("inlineCode",{parentName:"p"},".logarchive")," format for portability of logs. Essentially a ",(0,i.kt)("inlineCode",{parentName:"p"},".logarchive")," is a collection of information out of ",(0,i.kt)("inlineCode",{parentName:"p"},"/var/db/diagnostics")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"/var/db/uuidtext")," collected together into a single file that's easier to transfer to email or to attach to bug reports."),(0,i.kt)("h2",{id:"activity-tracing"},"Activity Tracing"),(0,i.kt)("p",null,"Activities associates log messages with user actions or other app-defined events."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-objc"},'- (IBAction)treeButtonTapped:(UIButton *)sender {\n    os_activity_t init_activity = os_activity_create("Init", OS_ACTIVITY_CURRENT, OS_ACTIVITY_FLAG_DEFAULT);\n    os_activity_t verify_activity = os_activity_create("Verify", init_activity, OS_ACTIVITY_FLAG_DEFAULT); // \u521b\u5efa\u5c42\u7ea7\u5173\u7cfb\n    os_activity_scope(init_activity);\n    os_log(OS_LOG_DEFAULT, "init something...");\n    if (true) {\n        os_activity_scope(verify_activity); // All of the rest of the code is considered in scope of `verify_activity` until hits the closing brace.\n        os_log(OS_LOG_DEFAULT, "verifying something...");\n    }\n    // And as soon as you leave that scope, you\'re now no longer part of `verify_activity`.\n}\n')),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"img-70",src:o(66510).Z})),(0,i.kt)("h2",{id:"signpost-events"},"Signpost Events"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2018/405"},"WWDC 2018 - Measuring Performance Using Logging"))),(0,i.kt)("p",null,"Signposts extend the ",(0,i.kt)("inlineCode",{parentName:"p"},"OSLog")," API, but they do it for the ",(0,i.kt)("strong",{parentName:"p"},"performance")," use case. That means they are conveying performance related information. You can annotate your code with signposts and find them in Instruments."),(0,i.kt)("p",null,"Instruments - Template: Blank - Add Library: os_signpost."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-objc"},'if (@available(iOS 12.0, *)) {\n    NSURL *url = [NSURL URLWithString:@"https://www.baidu.com/"];\n    os_log_t server_log = os_log_create("com.yianzhou.DemoOSLog", "Network");\n    // If two operations overlap but they have different signpost IDs, the system will know that they\'re two different intervals.\n    //  os_signpost_id_t signpostID = os_signpost_id_generate(server_log);\n    os_signpost_id_t signpostID = os_signpost_id_make_with_pointer(server_log, (__bridge const void * _Nullable)(url));\n    os_signpost_interval_begin(server_log, signpostID, "server request");\n    [[[NSURLSession sharedSession]dataTaskWithURL:url completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {\n        os_signpost_event_emit(server_log, signpostID, "data fetched");\n        if (response != nil) {\n            os_log_debug(server_log, "%@", [response description]);\n        }\n        os_signpost_interval_end(server_log, signpostID, "server request");\n    }] resume];\n}\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Points of interest")," with Time Profiler:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-objc"},'os_log_t poi_log = os_log_create("com.yianzhou.DemoOSLog", OS_LOG_CATEGORY_POINTS_OF_INTEREST);\nos_signpost_event_emit(poi_log, signpostID, "data fetched");\n')),(0,i.kt)("h2",{id:"architecture"},"Architecture"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"img",src:o(96837).Z})),(0,i.kt)("p",null,"Within each process there's a collection of small buffers into which we log messages. These buffers are actually in memory that's shared with the logging daemon. As these buffers are filled up the logging daemon is triggered to compress that data into a set of larger buffers that it maintains. As those larger buffers are filled up we either save them out to disk or we recycle them as part of the memory only buffers."),(0,i.kt)("p",null,"If you request livestreaming of log data, we immediately do an IPC over to the diagnostic daemon who then distributes those log messages out to all the clients (e.g. Console.app)."))}c.isMDXComponent=!0},96837:(e,t,o)=>{o.d(t,{Z:()=>n});const n="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6Yjg5MjRiMTA1ZWU1ZTg3MTQ0NDA3MTZhYWU3NDRmOWU3YWQxYTI1YzQ3MTM1N2EwN2I1N2ZmOTNlNTQ2OTVmZQpzaXplIDcwOTM5Cg=="},66510:(e,t,o)=>{o.d(t,{Z:()=>n});const n="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6OTYwMGViN2EwOGNiMDIxMDRmZTdlNjliNWE4MmQ5NzU5NTJiMGNhYzQ0MmFiZGJhZjE3MWFmZTY5OTZjNGFmNwpzaXplIDY0MjkK"}}]);