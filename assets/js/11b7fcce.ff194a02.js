"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9852],{51379:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>m,frontMatter:()=>s,metadata:()=>o,toc:()=>r});var a=t(87462),l=(t(67294),t(3905));t(61839);const s={sidebar_position:1},i="NSObject",o={unversionedId:"Objective-C/nsobject",id:"Objective-C/nsobject",title:"NSObject",description:"NSObject \u5185\u5b58\u5e03\u5c40",source:"@site/docs/language/Objective-C/nsobject.md",sourceDirName:"Objective-C",slug:"/Objective-C/nsobject",permalink:"/docs/language/Objective-C/nsobject",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"JavaScript",permalink:"/docs/language/JavaScript"},next:{title:"KVO",permalink:"/docs/language/Objective-C/kvo"}},c={},r=[{value:"NSObject \u5185\u5b58\u5e03\u5c40",id:"nsobject-\u5185\u5b58\u5e03\u5c40",level:2},{value:"\u67e5\u770b\u5185\u5b58",id:"\u67e5\u770b\u5185\u5b58",level:2},{value:"Person \u5185\u5b58\u5e03\u5c40",id:"person-\u5185\u5b58\u5e03\u5c40",level:2},{value:"self \u662f\u4ec0\u4e48",id:"self-\u662f\u4ec0\u4e48",level:2},{value:"Student \u5185\u5b58\u5e03\u5c40",id:"student-\u5185\u5b58\u5e03\u5c40",level:2},{value:"\u5185\u5b58\u5206\u914d",id:"\u5185\u5b58\u5206\u914d",level:2},{value:"isa \u548c superclass \u6307\u9488",id:"isa-\u548c-superclass-\u6307\u9488",level:2},{value:"\u5185\u5b58\u5bf9\u9f50",id:"\u5185\u5b58\u5bf9\u9f50",level:2},{value:"\u7c7b\u5bf9\u8c61\u4e0e\u5143\u7c7b\u5bf9\u8c61",id:"\u7c7b\u5bf9\u8c61\u4e0e\u5143\u7c7b\u5bf9\u8c61",level:2}],p={toc:r};function m(e){let{components:n,...s}=e;return(0,l.kt)("wrapper",(0,a.Z)({},p,s,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"nsobject"},"NSObject"),(0,l.kt)("h2",{id:"nsobject-\u5185\u5b58\u5e03\u5c40"},"NSObject \u5185\u5b58\u5e03\u5c40"),(0,l.kt)("p",null,"\u4e0b\u8f7d objc \u6e90\u7801\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://opensource.apple.com/tarballs/objc4/"},"https://opensource.apple.com/tarballs/objc4/"),"\uff0cgithub \u4ed3\u5e93\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://github.com/opensource-apple/objc4"},"https://github.com/opensource-apple/objc4")),(0,l.kt)("p",null,"\u4e0b\u8f7d CoreFoundation \u6e90\u7801\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://opensource.apple.com/tarballs/CF/"},"https://opensource.apple.com/tarballs/CF/"),"\uff0cgithub \u4ed3\u5e93\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://github.com/opensource-apple/CF"},"https://github.com/opensource-apple/CF")),(0,l.kt)("p",null,"OC \u4ee3\u7801\u7ecf\u8fc7\u7f16\u8bd1\u5668\u7684 rewrite \u540e\uff0c\u4f1a\u53d8\u6210 C/C++\u4ee3\u7801\uff0c\u8fd9\u662f OC \u7684\u5e95\u5c42\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m\n")),(0,l.kt)("p",null,"\u91cd\u5199 ",(0,l.kt)("inlineCode",{parentName:"p"},"main.m")," \u6587\u4ef6\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp"},"int main(int argc, char * argv[]) {\n    NSObject *obj = [[NSObject alloc] init];\n    return 0;\n}\n")),(0,l.kt)("p",null,"\u4ea7\u51fa ",(0,l.kt)("inlineCode",{parentName:"p"},"main.cpp")," \u6587\u4ef6\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp"},'int main(int argc, char * argv[]) {\n    NSObject *obj = ((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass("NSObject"), sel_registerName("alloc")), sel_registerName("init"));\n    return 0;\n}\n')),(0,l.kt)("p",null,"OC \u7684\u9762\u5411\u5bf9\u8c61\u662f\u57fa\u4e8e C/C++ \u7684\u6570\u636e\u7ed3\u6784\u5b9e\u73b0\u7684\uff0c\u5728\u4e0a\u9762 ",(0,l.kt)("inlineCode",{parentName:"p"},"main.cpp")," \u6587\u4ef6\u4e2d\uff0c\u627e\u5230\u7684\u91cd\u5199\u540e\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"NSObject"),"\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},"struct NSObject_IMPL {\n    Class isa;\n}\n")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"Class")," \u662f\u4ec0\u4e48\uff1f\u627e\u5230\u5b83\u7684\u5b9a\u4e49\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},"/// An opaque type that represents an Objective-C class.\ntypedef struct objc_class *Class;\n")),(0,l.kt)("p",null,"\u53d1\u73b0\u5b83\u662f\u4e00\u4e2a\u6307\u9488\uff0c\u6307\u9488\u5728 64 \u4f4d\u7cfb\u7edf\u6240\u5360\u5185\u5b58\u7a7a\u95f4\u662f 8 \u4e2a\u5b57\u8282\u3002"),(0,l.kt)("p",null,"\u7ed3\u6784\u4f53\u7684\u5730\u5740\uff0c\u5c31\u662f\u5b83\u91cc\u9762\u7b2c\u4e00\u4e2a\u6210\u5458\u7684\u5730\u5740\u3002",(0,l.kt)("inlineCode",{parentName:"p"},"isa")," \u6307\u9488\u7684\u5730\u5740\uff0c\u4e5f\u5c31\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"NSObject_IMPL")," \u7ed3\u6784\u4f53\u7684\u5730\u5740\u3002",(0,l.kt)("inlineCode",{parentName:"p"},"isa")," \u5b58\u50a8\u7684\u503c\uff0c\u5c31\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"NSObject")," \u7c7b\u5bf9\u8c61\u7684\u5730\u5740\u3002"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u6307\u9488\u5b58\u50a8\u7684\u503c\u662f\u522b\u4eba\u7684\u5185\u5b58\u5730\u5740\u3002\u6307\u9488\u5b58\u50a8\u4e86\u8c01\u7684\u5185\u5b58\u5730\u5740\uff0c\u5c31\u79f0\u4e3a\u6307\u9488\u6307\u5411\u4e86\u8c01\u3002\u6b64\u65f6\u8bbf\u95ee\u8fd9\u4e2a\u6307\u9488\uff0c\u5c31\u7b49\u540c\u4e8e\u8bbf\u95ee\u6307\u9488\u6307\u5411\u7684\u90a3\u5757\u5185\u5b58\u3002")),(0,l.kt)("p",null,"\u4e0b\u9762\u63a2\u7a76 ",(0,l.kt)("inlineCode",{parentName:"p"},"NSObject")," \u5360\u7528\u591a\u5c11\u5185\u5b58\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},'#import <malloc/malloc.h>\n#import <objc/runtime.h>\n\nNSLog(@"%zd", class_getInstanceSize([NSObject class])); // 8\n\n// `sizeof(type)` yields the size in bytes of the object representation of type.\nNSLog(@"%zd", sizeof([NSObject class])); // 8\n\n// Returns size of given ptr\nNSObject *obj = [[NSObject alloc] init];\nNSLog(@"%zd", malloc_size((__bridge const void *)obj)); // 16\n')),(0,l.kt)("p",null,"\u5728 objc \u6e90\u7801\u4e2d\u627e\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"class_getInstanceSize")," \u7684\u5b9e\u73b0\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp",metastring:"title='objc-class.mm'",title:"'objc-class.mm'"},"size_t class_getInstanceSize(Class cls)\n{\n    if (!cls) return 0;\n    return cls->alignedInstanceSize();\n}\n\n// Class's ivar size rounded up to a pointer-size boundary.\nuint32_t alignedInstanceSize() const {\n    return word_align(unalignedInstanceSize());\n}\n\n// \u4f20\u5165\u672a\u5bf9\u9f50\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u8fd4\u56de\u5bf9\u9f50\u540e\u7684\u5185\u5b58\u5927\u5c0f\nstatic inline uint32_t word_align(uint32_t x) {\n    return (x + WORD_MASK) & ~WORD_MASK;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"class_getInstanceSize")," \u5f97\u5230\u7684\u503c\u662f\u4e00\u4e2a\u5bf9\u8c61\u7684\u6240\u6709\u5b9e\u4f8b\u53d8\u91cf",(0,l.kt)("strong",{parentName:"li"},"\u7ecf\u8fc7\u5185\u5b58\u5bf9\u9f50\u540e"),"\u6240\u9700\u7684\u5185\u5b58\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"sizeof")," \u662f\u7f16\u8bd1\u671f\u7684\u8fd0\u7b97\u7b26\uff0c\u5728\u7f16\u8bd1\u671f\u8ba1\u7b97\u51fa\u64cd\u4f5c\u6570\u7684\u6240\u9700\u5185\u5b58\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"malloc_size")," \u5f97\u5230\u7684\u503c\u662f\u8fd0\u884c\u65f6\u7cfb\u7edf\u5b9e\u9645\u5206\u914d\u7684\u503c\u3002")),(0,l.kt)("p",null,"\u4e0b\u9762\u770b\u770b\u5bf9\u8c61\u662f\u600e\u4e48\u5206\u914d\u5185\u5b58\u7684\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"alloc")," \u65b9\u6cd5\u7684\u63cf\u8ff0\uff1aFor historical reasons, ",(0,l.kt)("inlineCode",{parentName:"p"},"alloc")," invokes ",(0,l.kt)("inlineCode",{parentName:"p"},"allocWithZone:"),"."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp",metastring:"title='NSObject.mm'",title:"'NSObject.mm'"},"+ (id)allocWithZone:(struct _NSZone *)zone {\n    return _objc_rootAllocWithZone(self, (malloc_zone_t *)zone);\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp",metastring:"title='objc-runtime-new.mm'",title:"'objc-runtime-new.mm'"},"NEVER_INLINE\nid _objc_rootAllocWithZone(Class cls, malloc_zone_t *zone __unused)\n{\n    // allocWithZone under __OBJC2__ ignores the zone parameter\n    return _class_createInstanceFromZone(cls, 0, nil,\n                                         OBJECT_CONSTRUCT_CALL_BADALLOC);\n}\n\nstatic ALWAYS_INLINE id\n_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone,\n                              int construct_flags = OBJECT_CONSTRUCT_NONE,\n                              bool cxxConstruct = true,\n                              size_t *outAllocatedSize = nil)\n{\n    size = cls->instanceSize(extraBytes); // \u83b7\u53d6\u5e94\u8be5\u5206\u914d\u7684\u5185\u5b58\u5927\u5c0f\n    obj = (id)calloc(1, size); // \u5206\u914d\u5185\u5b58\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp",metastring:"title='objc-runtime-new.h'",title:"'objc-runtime-new.h'"},"inline size_t instanceSize(size_t extraBytes) const {\n    size_t size = alignedInstanceSize() + extraBytes;\n    // CF requires all objects be at least 16 bytes.\n    if (size < 16) size = 16;\n    return size;\n}\n")),(0,l.kt)("p",null,"\u901a\u8fc7\u9605\u8bfb\u6e90\u7801\u5f97\u77e5\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"CoreFoundation")," \u8981\u6c42\u6240\u6709\u5bf9\u8c61\u81f3\u5c11\u5206\u914d 16 \u4e2a\u5b57\u8282\uff0c\u5c5e\u4e8e\u6846\u67b6\u7684\u786c\u6027\u89c4\u5b9a\u3002\u56e0\u6b64\uff0c64 \u4f4d\u7cfb\u7edf\u4e0a\uff0c ",(0,l.kt)("inlineCode",{parentName:"p"},"NSObject")," \u5206\u914d\u4e86 16 \u5b57\u8282\u5185\u5b58\uff0c\u4f46\u5176\u5185\u90e8\u53ea\u7528\u4e86 8 \u5b57\u8282\u3002"),(0,l.kt)("h2",{id:"\u67e5\u770b\u5185\u5b58"},"\u67e5\u770b\u5185\u5b58"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img",src:t(4380).Z})),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img",src:t(85025).Z})),(0,l.kt)("p",null,"\u8fd9\u91cc\u663e\u793a\u7684\u6570\u5b57\u662f 16 \u8fdb\u5236\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"16 * 16 = 2 ^ 8 = 256"),"\uff0c",(0,l.kt)("strong",{parentName:"p"},"\u4e24\u4e2a 16 \u8fdb\u5236\u6570\u8868\u793a\u4e00\u4e2a\u5b57\u8282"),"\uff0c\u53ef\u4ee5\u770b\u5230\u524d 8 \u4e2a\u5b57\u8282\u662f\u5bf9\u8c61\u7684\u5185\u5bb9\uff0c\u540e 8 \u4e2a\u5b57\u8282\u6ca1\u6709\u5185\u5bb9\u3001\u5168\u662f 0\u3002"),(0,l.kt)("p",null,"lldb \u6307\u4ee4 ",(0,l.kt)("inlineCode",{parentName:"p"},"memory read")," \u53ef\u4ee5\u8bfb\u53d6\u5185\u5b58\u4e2d\u7684\u6570\u636e\uff0c\u7b80\u5199 ",(0,l.kt)("inlineCode",{parentName:"p"},"x"),"\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},"Printing description of obj:\n<NSObject: 0x600002764480>\n(lldb) x 0x600002764480\n0x600002764480: e8 b6 4b 86 ff 7f 00 00 00 00 00 00 00 00 00 00  ..K.............\n0x600002764490: 90 44 ac 54 17 31 00 00 4b 00 49 00 00 00 00 00  .D.T.1..K.I.....\n")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"x/nuf <addr>"),":"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"n \u8868\u793a\u8981\u663e\u793a\u7684\u5185\u5b58\u5355\u5143\u7684\u4e2a\u6570"),(0,l.kt)("li",{parentName:"ul"},"u \u8868\u793a\u4e00\u4e2a\u5185\u5b58\u5355\u5143\u7684\u957f\u5ea6\uff0cg \u5bf9\u5e94 8 \u4e2a\u5b57\u8282"),(0,l.kt)("li",{parentName:"ul"},"f \u8868\u793a\u663e\u793a\u65b9\u5f0f\uff0cx \u4ee3\u8868 16 \u8fdb\u5236")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},"Printing description of obj:\n<NSObject: 0x1060ac280>\n(lldb) x/4g 0x1060ac280\n0x1060ac280: 0x010000021de7e331 0x0000000000000000\n0x1060ac290: 0x6b636950534e5b2d 0x426863756f547265\n")),(0,l.kt)("h2",{id:"person-\u5185\u5b58\u5e03\u5c40"},"Person \u5185\u5b58\u5e03\u5c40"),(0,l.kt)("p",null,"\u73b0\u6269\u5c55\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"Person")," \u7c7b\uff0c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-objc"},"@interface Person : NSObject {\n    @public\n    int _age;\n}\n@end\n")),(0,l.kt)("p",null,"\u540c\u6837\u5730\u5c06 ",(0,l.kt)("inlineCode",{parentName:"p"},"main.cpp")," \u91cd\u5199\u4e3a C++ \u4ee3\u7801\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},"struct Person_IMPL {\n    struct NSObject_IMPL NSObject_IVARS; // 8\u4e2a\u5b57\u8282\n    int _age; // 4\u4e2a\u5b57\u8282\n}\n")),(0,l.kt)("p",null,"\u660e\u660e\u53ea\u9700\u8981 12 \u4e2a\u5b57\u8282\uff0c\u4e3a\u4ec0\u4e48\u83b7\u53d6\u5b9e\u4f8b\u5927\u5c0f\u8fd4\u56de 16 \u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5185\u5b58\u5bf9\u9f50\u3002\u5185\u5b58\u5bf9\u9f50\u8981\u6c42\uff0c\u7ed3\u6784\u4f53\u7684\u5185\u5b58\u5927\u5c0f\u5fc5\u987b\u662f\u5176",(0,l.kt)("strong",{parentName:"p"},"\u6700\u5927\u6210\u5458\u7684\u5927\u5c0f\u7684\u6574\u6570\u500d"),"\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},'NSLog(@"%zd", class_getInstanceSize([Person class])); // 16\n')),(0,l.kt)("p",null,"\u7ed9 ",(0,l.kt)("inlineCode",{parentName:"p"},"_age")," \u8d4b\u503c\u4e3a 4\uff0c\u7136\u540e\u67e5\u770b\u5185\u5b58\uff0c"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img",src:t(59350).Z})),(0,l.kt)("p",null,"\u73b0\u4ee3\u8ba1\u7b97\u673a\u90fd\u662f",(0,l.kt)("strong",{parentName:"p"},"\u5c0f\u7aef\u5e8f")," (Little-Endian)\uff0c\u5373\uff0c\u4e00\u4e2a\u591a\u4f4d\u6570\u7684\u4f4e\u4f4d\u653e\u5728\u8f83\u5c0f\u7684\u5730\u5740\u5904\uff0c\u9ad8\u4f4d\u653e\u5728\u8f83\u5927\u7684\u5730\u5740\u5904\u3002"),(0,l.kt)("p",null,"\u6240\u4ee5\u8fd9\u91cc\u7684\u5185\u5b58\u8bfb\u53d6\u51fa\u6765\u4e0d\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"0x40000000"),"\uff0c\u800c\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"0x00000004"),"\u3002"),(0,l.kt)("p",null,"\u5c06 ",(0,l.kt)("inlineCode",{parentName:"p"},"Person")," \u91cc\u7684\u5b9e\u4f8b\u53d8\u91cf\u6539\u4e3a\u5c5e\u6027\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-objc"},"@interface Person : NSObject\n@property (nonatomic, assign) int age;\n@end\n")),(0,l.kt)("p",null,"\u5b83\u91cd\u5199\u540e\u7684\u7ed3\u6784\u4f53\u8fd8\u662f\u548c\u4e0a\u9762\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"Person_IMPL")," \u4e00\u6837\uff0c\u4e0d\u4f1a\u6709\u53d8\u5316\u3002\u800c ",(0,l.kt)("inlineCode",{parentName:"p"},"getter")," \u548c ",(0,l.kt)("inlineCode",{parentName:"p"},"setter")," \u5219\u53d8\u6210\u4e86\u51fd\u6570\uff0c\u8fd9\u4e9b\u51fd\u6570\u4f1a\u5b58\u5728\u7c7b\u5bf9\u8c61\u7684\u65b9\u6cd5\u5217\u8868\u91cc\u9762\uff0c\u4ee5\u4f9b\u8c03\u7528\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp"},"static int _I_Person_age(Person * self, SEL _cmd) { return (*(int *)((char *)self + OBJC_IVAR_$_Person$_age)); } // self \u6307\u9488\u504f\u79fb 8 \u4e2a\u5b57\u8282\nstatic void _I_Person_setAge_(Person * self, SEL _cmd, int age) { (*(int *)((char *)self + OBJC_IVAR_$_Person$_age)) = age; }\n")),(0,l.kt)("p",null,"\u7c7b\u53ef\u4ee5\u88ab\u5b9e\u4f8b\u5316\u6210\u65e0\u6570\u5bf9\u8c61\uff0c\u56e0\u6b64\u7ed3\u6784\u4f53\u91cc\u9762\u53ea\u5b58\u6210\u5458\u53d8\u91cf\uff0c\u5b9e\u4f8b\u65b9\u6cd5\u5728\u5185\u5b58\u4e2d\u6709\u4e00\u4efd\u5c31\u591f\u4e86\uff0c\u5b9e\u4f8b\u65b9\u6cd5\u662f\u4e0d\u53ef\u80fd\u653e\u5728\u7ed3\u6784\u4f53\u91cc\u5b58\u7684\u3002"),(0,l.kt)("h2",{id:"self-\u662f\u4ec0\u4e48"},"self \u662f\u4ec0\u4e48"),(0,l.kt)("p",null,"\u4ece\u4e0a\u9762\u91cd\u5199\u540e\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"getAge")," \u548c ",(0,l.kt)("inlineCode",{parentName:"p"},"setAge")," \u51fd\u6570\u53ef\u4ee5\u770b\u5230\uff0c\u51fd\u6570\u7684\u53c2\u6570\u6709\u4e24\u4e2a\uff0c\u5206\u522b\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"self")," \u548c ",(0,l.kt)("inlineCode",{parentName:"p"},"_cmd"),"\u3002\u6240\u6709\u7684 OC \u65b9\u6cd5\uff0c\u5176\u5e95\u5c42\u51fd\u6570\u90fd\u6709\u8fd9\u4e24\u4e2a\u53c2\u6570\u3002"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"self")," \u5b9e\u9645\u4e0a\u5c31\u662f\u4e00\u4e2a",(0,l.kt)("strong",{parentName:"li"},"\u5c40\u90e8\u53d8\u91cf"),"\uff0c\u5b83\u662f\u6307\u5411\u5f53\u524d\u5bf9\u8c61\u7684\u6307\u9488\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"_cmd")," \u8868\u793a\u5f53\u524d\u65b9\u6cd5\u7684 selector\uff0c\u5373 ",(0,l.kt)("inlineCode",{parentName:"li"},"_cmd == @selector(age)"))),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u73b0\u4ee3\u8ba1\u7b97\u673a\uff0c\u51fd\u6570\u7684\u5b9e\u53c2\u5e76\u4e0d\u662f\u653e\u5728\u6808\u7a7a\u95f4\uff0c\u800c\u662f\u653e\u5728 CPU \u7684\u5bc4\u5b58\u5668\uff0c\u8fd9\u6837\u6548\u7387\u66f4\u9ad8\uff0c\u8fd9\u70b9\u8981\u6ce8\u610f\u3002")),(0,l.kt)("h2",{id:"student-\u5185\u5b58\u5e03\u5c40"},"Student \u5185\u5b58\u5e03\u5c40"),(0,l.kt)("p",null,"\u518d\u6269\u5c55\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"Student")," \u7c7b\uff0c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-objc"},"@interface Student : Person {\n    @public\n    int _no;\n}\n@end\n")),(0,l.kt)("p",null,"\u5176\u5e95\u5c42\u5b9e\u73b0\u4e3a\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},"struct Student_IMPL {\n    struct Person_IMPL Person_IVARS; // 12\u4e2a\u5b57\u8282\n    int _no; // 4\u4e2a\u5b57\u8282\n}\n")),(0,l.kt)("p",null,"\u6b64\u65f6 ",(0,l.kt)("inlineCode",{parentName:"p"},"Student")," \u5360\u7528 16 \u4e2a\u5b57\u8282\uff0c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-objc"},'Student *stu = [[Student alloc] init];\nNSLog(@"%zd", malloc_size((__bridge const void *)stu)); // 16\n')),(0,l.kt)("p",null,"\u9898\u5916\u8bdd\uff1a\u6211\u4eec\u53ef\u4ee5\u5c06 oc \u5bf9\u8c61\u7684\u6307\u9488\u8f6c\u4e3a\u5176\u5e95\u5c42\u7ed3\u6784\u4f53\u7684\u6307\u9488\uff0c\u56e0\u4e3a\u5185\u5b58\u5e03\u5c40\u76f8\u540c\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-objc"},'Student *stu = [[Student alloc] init];\nstu->_no = 100;\nstruct Student_IMPL *stuIMP = (__bridge struct Student_IMPL *)stu;\nNSLog(@"%d", stuIMP->_no);\n')),(0,l.kt)("p",null,"\u5982\u679c\u7ed9 ",(0,l.kt)("inlineCode",{parentName:"p"},"Student")," \u518d\u589e\u52a0\u4e00\u4e2a\u6210\u5458\u53d8\u91cf ",(0,l.kt)("inlineCode",{parentName:"p"},"int _gender"),"\uff0c\u90a3\u4e48\u6211\u4eec\u4f1a\u53d1\u73b0\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c"},'Student *stu = [[Student alloc] init];\nNSLog(@"%zd", class_getInstanceSize([Student class])); // 24\nNSLog(@"%zd", sizeof([Student class])); // 24\nNSLog(@"%zd", malloc_size((__bridge const void *)stu)); // 32\n')),(0,l.kt)("p",null,"\u7531\u4e8e\u5185\u5b58\u5bf9\u9f50\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"Student_IMPL")," \u7ed3\u6784\u4f53\u7684\u5927\u5c0f\u662f\u5b83\u7684\u6700\u5927\u7684\u6210\u5458\u53d8\u91cf\u5927\u5c0f\uff0c\u5373 ",(0,l.kt)("inlineCode",{parentName:"p"},"struct Person_IMPL")," 12 \u4e2a\u5b57\u8282\u7684\u6574\u6570\u500d\uff0c\u56e0\u6b64\u662f 24 \u4e2a\u5b57\u8282\u3002"),(0,l.kt)("p",null,"\u4f46\u5b9e\u9645\u4e0a\u7cfb\u7edf\u4e3a\u5176\u5206\u914d\u4e86 32 \u4e2a\u5b57\u8282\uff0c\u8fd9\u662f\u4e3a\u4ec0\u4e48\u5462\uff1f\u8981\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"calloc")," \u7684\u6e90\u7801\u91cc\u627e\u7b54\u6848\u3002"),(0,l.kt)("h2",{id:"\u5185\u5b58\u5206\u914d"},"\u5185\u5b58\u5206\u914d"),(0,l.kt)("p",null,"\u4e0b\u8f7d libmalloc \u6e90\u7801\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://opensource.apple.com/tarballs/libmalloc/"},"https://opensource.apple.com/tarballs/libmalloc/")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c",metastring:"title='malloc.c'",title:"'malloc.c'"},"void *calloc(size_t num_items, size_t size)\n{\n    return _malloc_zone_calloc(default_zone, num_items, size, MZ_POSIX);\n}\n")),(0,l.kt)("p",null,"\u8fd9\u91cc\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"size"),"\uff0c\u8c03\u7528\u65b9\u4f20\u591a\u5c11\uff0c\u7cfb\u7edf\u5c31\u7ed9\u591a\u5c11\u5417\uff1f\u4f8b\u5982\u8c03\u7528\u65b9\u4f20 17\uff0c\u7cfb\u7edf\u5c31\u4f1a\u5206\u914d 17 \u4e2a\u5b57\u8282\u7684\u8fde\u7eed\u5185\u5b58\u5417\uff1f\u663e\u7136\u4e0d\u662f\u7684\u3002\u5728 64 \u4f4d\u7cfb\u7edf\u91cc\uff0c\u6307\u9488\u7684\u5730\u5740\u662f 64 \u4f4d\u5373 8 \u4e2a\u5b57\u8282\uff0cCPU \u5728\u5bfb\u5740\u7684\u65f6\u5019\uff0c\u81ea\u7136\u662f\u6309\u7167 8 \u7684\u500d\u6570\u6765\u5bfb\u5740\u6bd4\u8f83\u65b9\u4fbf\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u7cfb\u7edf\u5728\u5206\u914d\u5185\u5b58\u65f6\uff0c\u4e5f\u4f1a\u8003\u8651\u5185\u5b58\u5bf9\u9f50\u3002"),(0,l.kt)("p",null,"\u7531\u4e8e\u6e90\u7801\u6bd4\u8f83\u590d\u6742\uff0c\u8fd9\u91cc\u53ea\u8bf4\u7ed3\u8bba\uff0c\u770b\u8fd9\u6bb5\u4ee3\u7801\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp",metastring:"title='nano_zone_common.h'",title:"'nano_zone_common.h'"},"#define NANO_MAX_SIZE           256 /* Buckets sized {16, 32, 48, ..., 256} */\n")),(0,l.kt)("p",null,"\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u628a\u7cfb\u7edf\u7ba1\u7406\u7684",(0,l.kt)("strong",{parentName:"p"},"\u5806\u533a\u5185\u5b58"),"\uff0c\u60f3\u8c61\u6210\u4e00\u4e2a\u4e2a\u7684\u6876 (bucket)\uff0c\u6bcf\u4e2a\u6876\u7684\u5927\u5c0f\u90fd\u662f 16 \u7684\u500d\u6570\uff0c\u5f53\u5411\u7cfb\u7edf\u7533\u8bf7\u5185\u5b58\u65f6\uff0c\u7cfb\u7edf\u4f1a\u627e\u4e00\u4e2a\u80fd\u88c5\u4e0b\u4f60\u7533\u8bf7\u7684 size \u7684\u6700\u5c0f\u7684\u6876\u5206\u914d\u7ed9\u4f60\u3002"),(0,l.kt)("p",null,'\u5e76\u4e14\uff0c\u6211\u4eec\u7b5b\u9009 "malloc.c" \u6587\u4ef6\uff0c\u4f1a\u53d1\u73b0\u6709\u597d\u591a\u4e2a\u8fd9\u6837\u7684\u6587\u4ef6\uff0c\u5176\u5b9e\u662f\u5728\u4e0d\u540c\u7684\u60c5\u51b5\u4e0b\uff0c\u7cfb\u7edf\u4f1a\u8c03\u7528\u4e0d\u540c\u7684 ',(0,l.kt)("inlineCode",{parentName:"p"},"malloc")," \u65b9\u6cd5\u5206\u914d\u5185\u5b58\uff1a"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img",src:t(22764).Z})),(0,l.kt)("p",null,'\u5b9e\u9645\u4e0a "nano" \u8fd9\u79cd\u5206\u914d\u65b9\u5f0f\u6700\u5927\u80fd\u5206\u914d\u7684\u5185\u5b58\u5927\u5c0f\u5c31\u662f ',(0,l.kt)("inlineCode",{parentName:"p"},"NANO_MAX_SIZE"),"\uff0c\u5373 256 \u5b57\u8282\uff0c\u8d85\u51fa\u8fd9\u4e2a\u5927\u5c0f\u7684\uff0c\u5c31\u7528\u5176\u5b83\u7684\u5206\u914d\u65b9\u5f0f\u3002"),(0,l.kt)("h2",{id:"isa-\u548c-superclass-\u6307\u9488"},"isa \u548c superclass \u6307\u9488"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img",src:t(74721).Z})),(0,l.kt)("p",null,"\u4efb\u4f55\u7c7b\u7684\u5143\u7c7b\u5bf9\u8c61\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"isa")," \u6307\u9488\uff0c\u90fd\u6307\u5411 ",(0,l.kt)("inlineCode",{parentName:"p"},"NSObject")," \u7684\u5143\u7c7b\u5bf9\u8c61\u3002"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"superclass")," \u6307\u9488\u5411\u4e0a\u6307\u5411\u7236\u7c7b\uff0c\u9664\u4e86 ",(0,l.kt)("inlineCode",{parentName:"p"},"NSObject")," \u7684\u5143\u7c7b\u5bf9\u8c61\u6307\u5411 ",(0,l.kt)("inlineCode",{parentName:"p"},"NSObject")," \u7684\u7c7b\u5bf9\u8c61\u3002"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img",src:t(84715).Z})),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("inlineCode",{parentName:"p"},"p/x")," \u8868\u793a\u6309\u5341\u516d\u8fdb\u5236\u8f93\u51fa")),(0,l.kt)("p",null,"\u770b\u4e0a\u56fe\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"obj")," \u5b9e\u4f8b\u5bf9\u8c61\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"isa")," \u6307\u9488\uff0c\u5e94\u8be5\u5b58\u653e\u7c7b\u5bf9\u8c61\u7684\u5185\u5b58\u5730\u5740 ",(0,l.kt)("inlineCode",{parentName:"p"},"0x1da9a6710"),"\uff0c\u4f46\u5b9e\u9645\u4e0a\u5b83\u7684\u503c\u5374\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"0x01000001da9a6711"),"\uff0c\u8fd9\u662f\u4e3a\u4ec0\u4e48\u5462\uff1f"),(0,l.kt)("p",null,"\u6ce8\u610f\uff0c\u5728 64 \u4f4d\u673a\u5668\u4e0a\uff0cisa \u9700\u8981\u8fdb\u884c\u4e00\u6b21\u4f4d\u8fd0\u7b97\uff0c\u624d\u80fd\u5f97\u5230\u771f\u5b9e\u7684\u5730\u5740\u3002\u6253\u5f00 objc \u6e90\u7801\u53ef\u4ee5\u627e\u5230\u8fd9\u4e2a ",(0,l.kt)("inlineCode",{parentName:"p"},"ISA_MASK"),"\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-objc",metastring:"title='isa.h'",title:"'isa.h'"},"# if __arm64__\n#   if __has_feature(ptrauth_calls) || TARGET_OS_SIMULATOR\n#     define ISA_MASK        0x007ffffffffffff8ULL\n#   else\n#     define ISA_MASK        0x0000000ffffffff8ULL\n# elif __x86_64__\n#   define ISA_MASK        0x00007ffffffffff8ULL\n# else\n#   error unknown architecture for packed isa\n# endif\n")),(0,l.kt)("p",null,"\u5373\uff0c\u9700\u8981\u5c06 ",(0,l.kt)("inlineCode",{parentName:"p"},"isa")," \u6307\u9488\u7684\u5730\u5740\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"& ISA_MASK")," \u8fd0\u7b97\u4e4b\u540e\uff0c\u624d\u80fd\u5f97\u5230\u771f\u6b63\u7684\u7c7b\u5bf9\u8c61\u7684\u5730\u5740\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-log"},"(lldb) expr 0x01000001da9a6711 & 0x007ffffffffffff8ULL\n(unsigned long long) $1 = 7962519312\n(lldb) p/x 7962519312\n(long) $2 = 0x00000001da9a6710\n")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"super_class")," \u6307\u9488\u7684\u5730\u5740\u5219\u4e0d\u7528\u8fdb\u884c\u8fd9\u6837\u7684\u4f4d\u8fd0\u7b97\u8f6c\u6362\u3002"),(0,l.kt)("h2",{id:"\u5185\u5b58\u5bf9\u9f50"},"\u5185\u5b58\u5bf9\u9f50"),(0,l.kt)("p",null,"\u5185\u5b58\u662f\u4e00\u4e2a\u5de8\u5927\u7684\u5b57\u8282\u6570\u7ec4\uff0c\u7406\u8bba\u4e0a\uff0c\u5bf9\u53d8\u91cf\u7684\u8bbf\u95ee\u53ef\u4ee5\u4ece\u4efb\u4f55\u5730\u5740\u5f00\u59cb\u3002\u4f46\u662f\u5b9e\u9645\u4e0a\uff0c\u8ba1\u7b97\u673a\u5e76\u4e0d\u80fd\u76f4\u63a5\u6309\u4efb\u610f\u5730\u5740\u6765\u8bfb\u5199\u5185\u5b58\uff0c\u800c\u662f\u4ee5 4 \u5b57\u8282\u30018 \u5b57\u8282\u300116 \u5b57\u8282\u8fd9\u6837\u7684\u5355\u4f4d\u6765\u8bfb\u5199\u5185\u5b58\uff0c\u79f0\u4e3a",(0,l.kt)("strong",{parentName:"p"},"\u5185\u5b58\u5b58\u53d6\u7c92\u5ea6"),"\u3002"),(0,l.kt)("p",null,"\u4ee5 4 \u5b57\u8282\u7684\u7c92\u5ea6\u4e3a\u4f8b\uff0c\u5982\u679c\u6211\u4eec\u5b58\u653e\u4e86\u4e00\u4e2a 4 \u5b57\u8282\u7684\u6570\u636e\u5728\u5730\u5740 0\uff0c\u90a3\u4e48\u8ba1\u7b97\u673a\u53ea\u9700\u4e00\u6b21\u8bbf\u95ee\u5c31\u80fd\u8bfb\u53d6\u5230\uff1b\u4f46\u5982\u679c\u6211\u4eec\u5b58\u653e\u4e00\u4e2a 4 \u5b57\u8282\u7684\u6570\u636e\u5728\u5730\u5740 1\uff0c\u8ba1\u7b97\u673a\u5c31\u9700\u8981\u4e24\u6b21\u8bfb\u53d6\u3001\u518d\u79fb\u4f4d\u3001\u5408\u5e76\uff0c\u624d\u80fd\u8bfb\u53d6\u5230\u8fd9\u4e2a\u6570\u636e\uff0c\u8ba1\u7b97\u91cf\u589e\u52a0\u4e86\u5f88\u591a\u3002"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img",src:t(19379).Z})),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img",src:t(46979).Z})),(0,l.kt)("p",null,"\u56e0\u6b64\uff0c\u7f16\u8bd1\u5668\u4f1a\u5bf9\u57fa\u672c\u6570\u636e\u7c7b\u578b\u7684\u5408\u6cd5\u5730\u5740\u4f5c\u51fa\u4e00\u4e9b\u9650\u5236\uff0c\u5373\u5185\u5b58\u5730\u5740\u5fc5\u987b\u662f 4\u30018\u300116 \u7684\u500d\u6570\uff0c\u79f0\u4e3a",(0,l.kt)("strong",{parentName:"p"},"\u5185\u5b58\u5bf9\u9f50"),"\uff0c\u8fd9\u4e2a\u500d\u6570\u79f0\u4e3a",(0,l.kt)("strong",{parentName:"p"},"\u5bf9\u9f50\u7cfb\u6570"),"\u3002"),(0,l.kt)("p",null,"\u4e3a\u4e86\u5b66\u4e60\u5185\u5b58\u5bf9\u9f50\uff0c\u9664\u4e86\u82f9\u679c\u7cfb\u7edf\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u770b\u770b Linux \u7cfb\u7edf\u7684\u5b9e\u73b0\u3002Linux \u7cfb\u7edf\u4f7f\u7528\u7684\u662f GNU \u5f00\u6e90\u7684\u4ee3\u7801\uff0cGNU \u8fd9\u4e2a\u7ec4\u7ec7\u5f00\u6e90\u4e86\u5927\u91cf\u4f18\u79c0\u7684\u4ee3\u7801\u3002"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"GNU is a recursive acronym for \"GNU's Not Unix!\", chosen because GNU's design is Unix-like, but differs from Unix by being free software and containing no Unix code.")),(0,l.kt)("p",null,"\u4e0b\u8f7d glibc \u6e90\u7801\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://www.gnu.org/software/libc/sources.html"},"https://www.gnu.org/software/libc/sources.html")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c",metastring:"title='sysdeps/i386/malloc-alignment.h'",title:"'sysdeps/i386/malloc-alignment.h'"},"// \u5728 i386 \u67b6\u6784\u4e0b\uff0c\u5185\u5b58\u5bf9\u9f50\u7cfb\u6570\u662f 16\n#define MALLOC_ALIGNMENT 16\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c",metastring:"title='sysdeps/generic/malloc-alignment.h'",title:"'sysdeps/generic/malloc-alignment.h'"},"/* MALLOC_ALIGNMENT is the minimum alignment for malloc'ed chunks.  It\n   must be a power of two at least 2 * SIZE_SZ, even on machines for\n   which smaller alignments would suffice. It may be defined as larger\n   than this though. Note however that code and data structures are\n   optimized for the case of 8-byte alignment.  */\n#define MALLOC_ALIGNMENT (2 * SIZE_SZ < __alignof__ (long double) \\\n              ? __alignof__ (long double) : 2 * SIZE_SZ)\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c",metastring:"title='sysdeps/generic/malloc-size.h'",title:"'sysdeps/generic/malloc-size.h'"},"#ifndef INTERNAL_SIZE_T\n# define INTERNAL_SIZE_T size_t\n#endif\n\n/* The corresponding word size.  */\n#define SIZE_SZ (sizeof (INTERNAL_SIZE_T))\n")),(0,l.kt)("p",null,"\u867d\u7136 glibc \u7684\u6e90\u7801\u6211\u4eec\u6ca1\u6cd5\u8dd1\uff0c\u4f46\u6211\u4eec\u53ef\u4ee5\u653e\u5230 Xcode \u91cc\u5c1d\u8bd5\u8dd1\u4e00\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-objc"},'NSLog(@"%zd", sizeof(size_t)); // 8\nNSLog(@"%zd", __alignof__(long double)); // 16\n')),(0,l.kt)("p",null,"\u57fa\u672c\u53ef\u4ee5\u80af\u5b9a\uff0c\u5728\u901a\u7528\u67b6\u6784\u4e0b\uff0c\u5185\u5b58\u5bf9\u9f50\u7cfb\u6570\u90fd\u662f 16\u3002"),(0,l.kt)("h2",{id:"\u7c7b\u5bf9\u8c61\u4e0e\u5143\u7c7b\u5bf9\u8c61"},"\u7c7b\u5bf9\u8c61\u4e0e\u5143\u7c7b\u5bf9\u8c61"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp",metastring:"title='NSObject.mm'",title:"'NSObject.mm'"},"+ (Class)class {\n    return self;\n}\n\n- (Class)class {\n    return object_getClass(self);\n}\n")),(0,l.kt)("p",null,"\u4ece objc \u6e90\u7801\u5b9e\u73b0\u53ef\u77e5\uff0c\u65e0\u8bba\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"-class")," \u8fd8\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"+class"),"\uff0c\u8fd4\u56de\u7684\u90fd\u662f\u7c7b\u5bf9\u8c61\uff0c\u5b83\u4e0d\u4f1a\u8fd4\u56de\u5143\u7c7b\u5bf9\u8c61\uff0c\u6240\u4ee5\u4e0d\u7ba1\u4f60\u600e\u4e48\u8c03\u3001\u8c03\u591a\u5c11\u6b21\uff0c\u7ed3\u679c\u90fd\u4e00\u6837\u7684\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-objc"},'#import <objc/runtime.h>\n\n@implementation ViewController\n\n+ (void)load {\n    NSLog(@"%p", self); // 0x10468c4c0\n    NSLog(@"%p", [self class]); // 0x10468c4c0\n}\n\n- (void)viewDidLoad {\n    [super viewDidLoad];\n\n    Class classObj1 = [self class];\n    Class classObj2 = [ViewController class];\n    Class classObj3 = [[[ViewController class] class] class];\n    Class classObj4 = object_getClass(self);\n    Class classObj5 = NSClassFromString(@"ViewController");\n    NSLog(@"%p %p %p %p %p", classObj1, classObj2, classObj3, classObj4, classObj5); // 0x1040992d0\n\n    // \u8981\u53d6\u5230\u5143\u7c7b\u5bf9\u8c61\uff0c\u9700\u8c03\u7528 object_getClass \u5e76\u4f20\u5165\u7c7b\u5bf9\u8c61\n    Class meta_class_obj = object_getClass(classObj1);\n    NSLog(@"%p", meta_class_obj);\n\n    NSLog(@"%d", class_isMetaClass(classObj1));\n    NSLog(@"%d", class_isMetaClass(meta_class_obj));\n}\n\n@end\n')),(0,l.kt)("p",null,"instance object: \u5b9e\u4f8b\u5bf9\u8c61\u3002\u5b9e\u4f8b\u5bf9\u8c61\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"isa")," \u6307\u9488\uff0c\u6307\u5411\u7c7b\u5bf9\u8c61\u3002"),(0,l.kt)("p",null,"class object: \u7c7b\u5bf9\u8c61\uff0c\u5b9e\u4f8b\u65b9\u6cd5\u5b58\u653e\u5728\u8fd9\u3002\u7c7b\u5bf9\u8c61\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"isa")," \u6307\u9488\uff0c\u6307\u5411\u5143\u7c7b\u5bf9\u8c61\u3002"),(0,l.kt)("p",null,"meta-class object: \u5143\u7c7b\u5bf9\u8c61\uff0c\u7c7b\u65b9\u6cd5\u5b58\u653e\u5728\u8fd9\u3002",(0,l.kt)("strong",{parentName:"p"},"\u5143\u7c7b\u5bf9\u8c61\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u7c7b\u5bf9\u8c61"),"\u3002"),(0,l.kt)("p",null,"class object \u548c meta-class object \u7684\u5185\u5b58\u7ed3\u6784\u662f\u4e00\u6837\u7684\uff0c\u5b83\u4eec\u90fd\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"struct objc_class"),"\uff0c\u4f46\u662f\u4e24\u8005\u7528\u9014\u4e0d\u4e00\u6837\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-c",metastring:"title='objc.h'",title:"'objc.h'"},"typedef struct objc_class *Class;\n\nstruct objc_object {\n    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;\n};\n\ntypedef struct objc_object *id;\n")),(0,l.kt)("p",null,"\u65e7\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"objc_class")," \u7ed3\u6784\u4f53\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"runtime.h")," \u6587\u4ef6\uff0c\u5728 objc2 \u4e4b\u540e\u5df2\u7ecf\u5e9f\u5f03\u4e86\uff0c\u65b0\u7684\u4f1a\u590d\u6742\u5f88\u591a\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp",metastring:"title='objc-runtime-new.h'",title:"'objc-runtime-new.h'"},"struct objc_class : objc_object { // cpp\u7684\u8bed\u6cd5\uff0c\u7ed3\u6784\u4f53\u7ee7\u627f\n    // Class ISA; // isa \u6307\u9488\uff0c\u7ee7\u627f\u81ea\u7236\u7c7b\n    Class superclass; // superclass \u6307\u9488\n    cache_t cache;             // formerly cache pointer and vtable\n    class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags\n\n    class_rw_t *data() const { // class read-write table\n        return bits.data();\n    }\n}\n\nstruct class_rw_t {\n    const class_ro_t *ro() const { // class readonly table\n    }\n    const method_array_t methods() const { // \u65b9\u6cd5\u5217\u8868\uff08\u4e8c\u7ef4\u6570\u7ec4\uff09\n    }\n    const property_array_t properties() const { // \u5c5e\u6027\u5217\u8868\uff08\u4e8c\u7ef4\u6570\u7ec4\uff09\n    }\n    const protocol_array_t protocols() const { // \u534f\u8bae\u5217\u8868\uff08\u4e8c\u7ef4\u6570\u7ec4\uff09\n    }\n}\n\n/// \u5728\u8fd9\u4e2a\u53ea\u8bfb\u7684\u7ed3\u6784\u4f53\u4e2d\u5b58\u4e86\u4e00\u4efd\u7c7b\u672c\u8eab\u7684\u3001\u672a\u7ecf\u8fc7 Runtime \u9644\u52a0\u5404\u79cd\u5206\u7c7b\u65b9\u6cd5\u7684\u539f\u59cb\u65b9\u6cd5\u5217\u8868\nstruct class_ro_t {\n    uint32_t instanceSize; // \u5b9e\u4f8b\u5bf9\u8c61\u5927\u5c0f\n    explicit_atomic<const char *> name; // \u7c7b\u540d\n    void *baseMethodList;\n    protocol_list_t * baseProtocols;\n    const ivar_list_t * ivars;\n    property_list_t *baseProperties;\n}\n\nstruct class_data_bits_t {\n    uintptr_t bits;\n    class_rw_t* data() const {\n        return (class_rw_t *)(bits & FAST_DATA_MASK);\n    }\n}\n")),(0,l.kt)("p",null,"\u7c7b\u7f16\u8bd1\u597d\u4e86\u4e4b\u540e\uff0c\u5176\u6210\u5458\u53d8\u91cf\u3001\u5c5e\u6027\u3001\u534f\u8bae\u3001\u65b9\u6cd5\u4fe1\u606f\u5b58\u50a8\u5728\u53ea\u8bfb\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"class_ro_t")," \u91cc\uff0c\u8fd0\u884c\u65f6\u53d6\u51fa ",(0,l.kt)("inlineCode",{parentName:"p"},"class_ro_t")," \u7684\u4fe1\u606f\uff0c\u4e0e\u5206\u7c7b\u3001\u52a8\u6001\u6dfb\u52a0\u65b9\u6cd5\u7b49\u4fe1\u606f\u5408\u5e76\uff0c\u53d8\u6210 ",(0,l.kt)("inlineCode",{parentName:"p"},"class_rw_t"),"\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp",metastring:"title='objc-runtime-new.mm'",title:"'objc-runtime-new.mm'"},"static Class realizeClassWithoutSwift(Class cls, Class previously)\n{\n    auto ro = (const class_ro_t *)cls->data();\n    // Normal class. Allocate writeable class data.\n    rw = objc::zalloc<class_rw_t>();\n    rw->set_ro(ro);\n    rw->flags = RW_REALIZED|RW_REALIZING|isMeta;\n    cls->setData(rw);\n}\n")))}m.isMDXComponent=!0},59350:(e,n,t)=>{t.d(n,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NGE2OWJlMzE4ZTgxZGI1ZWQ4MDdhNzZhYTNkODNjNzc5MzA1YjU5MGI0ZjMyNzNmZDNjNTdjMzVjNzcwMTYwYwpzaXplIDM4ODU5Ngo="},4380:(e,n,t)=>{t.d(n,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6ZDFlZTU2N2E4Nzk4YzA2YTJkNjc4NWE3M2FkY2NlZjg4ZGI3MjVkMGIyN2FlOGZkNDQ1YjVmZDE1MmExMjRhNQpzaXplIDYyMDU2NAo="},85025:(e,n,t)=>{t.d(n,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6ZGMyNzY4YTNhZTRmNDA1MDc4MmNjNjMxOTM5MGM1MDFmMTJkY2EwMWJlNzBiZjc3OGIzMzNhZDlmMWNjMjg1MApzaXplIDQ2MjA2MQo="},46979:(e,n,t)=>{t.d(n,{Z:()=>a});const a="data:image/jpeg;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NWJhOWY3YTM3OWYxMTJkZTE1MWRhOGI1MGE0ZmZmY2Q1Y2NlMjgzYThkODE4ZDhhMWVjMDJlYTg2MjUxYmMxMgpzaXplIDExMTE5Cg=="},84715:(e,n,t)=>{t.d(n,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6ZGJmY2E0ZWVkZGE4YTA3OGUxZmIzNjcyNDFmNGUxZjBiZjNhN2IyOWYzOGYyNDIxOGE2ODkwYTE1YTkwNWYxOApzaXplIDEyODQ2Ngo="},22764:(e,n,t)=>{t.d(n,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6MDAxN2QwOGNhMzllMzFiOTEzNTczMmU5ZWUxYzFmZDE1YzQ4YjM3ZTQ3MDgyMzM1NmZmZjAxMzYwOTcwMDI0OQpzaXplIDQ3ODI5Cg=="},74721:(e,n,t)=>{t.d(n,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6OWY3ZGI5MDY5NjliNTJmYjVlOGI0Yzg2MjEzYWJlYTY3YjZhYjEzNDk2YzllNGQ1MDA1MmVjMTBmYzhkMWZlNwpzaXplIDYwNDUxCg=="},19379:(e,n,t)=>{t.d(n,{Z:()=>a});const a="data:image/jpeg;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6YWUwYWM1MjY1ZmYyMDdkNzJkNzg0MjE3ZDRkOTdjODg3Yzg0YzZhNTgxM2JmMjMwZjkyZTkxYTZkZTU2YTYwNwpzaXplIDg2MDUK"}}]);