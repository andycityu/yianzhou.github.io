"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9842],{55649:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var a=n(87462),o=(n(67294),n(3905));n(61839);const i={},r="Apple Networking",s={unversionedId:"networking",id:"networking",title:"Apple Networking",description:"URLSession",source:"@site/docs/apple/networking.md",sourceDirName:".",slug:"/networking",permalink:"/docs/apple/networking",draft:!1,editUrl:"https://github.com/yianzhou/yianzhou.github.io/docs/apple/networking.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u591a\u7ebf\u7a0b",permalink:"/docs/apple/multithread"},next:{title:"\u6027\u80fd\u4f18\u5316",permalink:"/docs/apple/performance"}},l={},p=[{value:"URLSession",id:"urlsession",level:2},{value:"URLSessionConfiguration",id:"urlsessionconfiguration",level:3},{value:"waitsForConnectivity",id:"waitsforconnectivity",level:3},{value:"URLSessionStreamTask",id:"urlsessionstreamtask",level:3},{value:"Progress",id:"progress",level:3},{value:"HTTP/2",id:"http2",level:2},{value:"Optimistic DNS",id:"optimistic-dns",level:2},{value:"Encrypted DNS",id:"encrypted-dns",level:2},{value:"Brotli",id:"brotli",level:2},{value:"WebSocket",id:"websocket",level:2},{value:"Cookie",id:"cookie",level:2},{value:"Caching",id:"caching",level:2},{value:"Statistics",id:"statistics",level:2},{value:"Wi-Fi Assist",id:"wi-fi-assist",level:2},{value:"Multipath TCP",id:"multipath-tcp",level:2},{value:"Network Service Type",id:"network-service-type",level:2},{value:"ECN",id:"ecn",level:2},{value:"TCP_NOTSENT_LOWAT",id:"tcp_notsent_lowat",level:2},{value:"TCP Fast Open",id:"tcp-fast-open",level:2},{value:"Supporting IPv6",id:"supporting-ipv6",level:2},{value:"Optimize for 5G networks",id:"optimize-for-5g-networks",level:2},{value:"Network Security",id:"network-security",level:2},{value:"App Transport Security",id:"app-transport-security",level:3},{value:"Certificate Revocation",id:"certificate-revocation",level:3},{value:"Certificate Transparency",id:"certificate-transparency",level:3},{value:"TLS 1.3",id:"tls-13",level:3},{value:"Forward Secrecy",id:"forward-secrecy",level:3},{value:"Bonjour and Local Network",id:"bonjour-and-local-network",level:2},{value:"Network.framework",id:"networkframework",level:2},{value:"Network Extension",id:"network-extension",level:2},{value:"NEHotspotHelper",id:"nehotspothelper",level:3},{value:"NEHotspotConfiguration",id:"nehotspotconfiguration",level:3},{value:"NEVPNManager",id:"nevpnmanager",level:3},{value:"NEPacketTunnelProvider",id:"nepackettunnelprovider",level:3},{value:"NEFilterProvider",id:"nefilterprovider",level:3},{value:"NEDNSProxyProvider",id:"nednsproxyprovider",level:3},{value:"Local Push Connectivity",id:"local-push-connectivity",level:3},{value:"Network Link Conditioner",id:"network-link-conditioner",level:2},{value:"Designing for Adverse Temperature Conditions",id:"designing-for-adverse-temperature-conditions",level:2},{value:"UTF-8",id:"utf-8",level:2}],c={toc:p};function d(e){let{components:t,...i}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"apple-networking"},"Apple Networking"),(0,o.kt)("h2",{id:"urlsession"},"URLSession"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2016/711"},"WWDC 2016 - NSURLSession: New Features and Best Practices")),(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2015/711/"},"WWDC 2015 - Networking with NSURLSession"))),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," kick-off: init a configuration, init a session, init a task, resume."),(0,o.kt)("p",null,"Best practice: one session to support many (many!) tasks!"),(0,o.kt)("p",null,"Every ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," object has a ",(0,o.kt)("strong",{parentName:"p"},"connection pool")," and when you create multiple of these ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," objects, you don't get any benefit of connection reusing. It's also important to note that the ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," objects are fairly expensive to create and have a non-trivial memory footprint."),(0,o.kt)("p",null,"For almost all of your apps what you should have is just one ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession"),", which can then have as many tasks as you want. The only time you would want more than one ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," is when you have groups of different operations that have radically different requirements. And in that case you might create two different configuration objects to init two different ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession"),"s. One example is private browsing in Safari where each private browsing window is its own separate ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," so that it doesn't share cookies and other states with the other sessions."),(0,o.kt)("p",null,"Most apps can just have one statically-allocated ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession"),". But if you do allocate ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession"),"s dynamically, remember to clean up afterwards. Either ",(0,o.kt)("inlineCode",{parentName:"p"},"finishTasksAndInvalidate")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"invalidateAndCancel"),". If you don't clean up, you'll leak memory."),(0,o.kt)("p",null,"Delegate callbacks and convenience methods: Delegate callbacks give you detailed step-by-step progress information on the state of your task. The convenience methods, by comparison, are a quick and easy way of using the API that you don't get all the intermediate delegate callbacks, you just get the final result reported to the completion handler. Don't mix and match both on the same ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession"),", pick one style and be consistent."),(0,o.kt)("h3",{id:"urlsessionconfiguration"},"URLSessionConfiguration"),(0,o.kt)("p",null,"It is important to configure your ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionConfiguration")," object appropriately before using it to initialize a session object. Once configured, the session object ignores any changes you make to the configuration object. If you need to modify your transfer policies, you must update the session configuration object and use it to create a new ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," object."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionConfiguration"),":"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"TLS version"),(0,o.kt)("li",{parentName:"ul"},"Cookie policy"),(0,o.kt)("li",{parentName:"ul"},"Cache policy"),(0,o.kt)("li",{parentName:"ul"},"Storage objects")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"networkServiceType"),": provides a hint to the operating system about what the underlying traffic is used for. See ",(0,o.kt)("a",{parentName:"p",href:"#networkservicetype"},"networkServiceType"),"."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"multipathServiceType"),": specifies the Multipath TCP connection policy for transmitting data over Wi-Fi and cellular interfaces. See ",(0,o.kt)("a",{parentName:"p",href:"#multipath-tcp"},"Multipath TCP"),"."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"timeoutIntervalForResource"),": The resource timer starts when the request is initiated and counts until either the request completes or this timeout interval is reached, whichever comes first."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"timeoutIntervalForRequest"),": The timer only starts once the transfer starts. It controls how long a task should wait for ",(0,o.kt)("strong",{parentName:"p"},"additional data")," to arrive before giving up. The timer associated with this value is reset whenever new data arrives."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"allowsCellularAccess"),": allowed to make connections over a cellular network."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"allowsConstrainedNetworkAccess"),": whether connections may use the network when the user has specified ",(0,o.kt)("strong",{parentName:"p"},"Low Data Mode"),"."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"allowsExpensiveNetworkAccess"),": whether connections may use a network interface that the system considers expensive. (iOS 13 considers most cellular networks and personal hotspots expensive)"),(0,o.kt)("h3",{id:"waitsforconnectivity"},"waitsForConnectivity"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"var waitsForConnectivity: Bool")),(0,o.kt)("p",null,"\u201cPlease fetch me this resource when the network is available.\u201d No longer a need to monitor connectivity and manually retry requests."),(0,o.kt)("p",null,"You would create and resume the ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionTask")," as before. If the device can't connect to the server, we'd call a delegate callback if you implemented it, once for each task."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-swift"},"let config = USLSessionConfiguration.default\nconfig.waitsForConnectivity = true\n// ...\nfunc urlSession(_ session: URLSession, taskIsWaitingForConnectivity task: URLSessionTask) {}\n")),(0,o.kt)("p",null,"This API only has an effect for non-background sessions, it's not necessary for background ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," who does this automatically."),(0,o.kt)("h3",{id:"urlsessionstreamtask"},"URLSessionStreamTask"),(0,o.kt)("p",null,"There are some cases where you need a protocol other than HTTP or HTTPS, and you want to do something custom directly on top of TCP/IP networking. ",(0,o.kt)("inlineCode",{parentName:"p"},"NSURLSessionStreamTask")," is a Foundation extraction, directly over a TCP connection."),(0,o.kt)("p",null,"What we have new for you in iOS 11 is automatic navigation of authenticating proxies. If the proxy requires credentials, then we will automatically extract those from the key chain or promptly the user on your behalf."),(0,o.kt)("h3",{id:"progress"},"Progress"),(0,o.kt)("p",null,"Now in iOS 11 ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionTask")," has adopted the ",(0,o.kt)("inlineCode",{parentName:"p"},"ProgressReporting")," protocol. You can get a progress object from the ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionTask"),"."),(0,o.kt)("p",null,"You can attach that progress object to a ",(0,o.kt)("inlineCode",{parentName:"p"},"UIProgressView")," or an ",(0,o.kt)("inlineCode",{parentName:"p"},"NSProgressIndicator")," to get an automatic progress bar."),(0,o.kt)("p",null,"You can also combine multiple progress objects into a parent progress object when you're performing multiple tasks."),(0,o.kt)("p",null,"The binding between a ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionTask")," and the progress object is bidirectional. So if you pause a ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionTask"),", that is the same as pausing the progress object. If you pause the progress object, that is the same as pause the ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionTask"),"."),(0,o.kt)("h2",{id:"http2"},"HTTP/2"),(0,o.kt)("p",null,"Using ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," on the client will negotiate HTTP/2 by default if it is enabled on the server.\nSo double-check your server settings to make sure HTTP/2 is enabled. By the way, ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," supports HTTP/2 protocol only over an encrypted connection."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," \u8fd0\u884c\u5728 HTTP/1.1 \u65f6\uff0c\u5bf9\u540c\u4e00\u4e2a IP \u5730\u5740\u7684\u8bf7\u6c42\uff0c\u4f1a\u521b\u5efa\u591a\u4e2a\u5e76\u884c\u7684 TCP \u8fde\u63a5\uff0c\u6bcf\u4e2a\u8fde\u63a5\u7684\u5efa\u7acb\u90fd\u4f1a\u5e26\u6765\u8d44\u6e90\u6d88\u8017\uff08\u89c1 ",(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/foundation/urlsessionconfiguration/1407597-httpmaximumconnectionsperhost"},(0,o.kt)("inlineCode",{parentName:"a"},"httpMaximumConnectionsPerHost")),"\uff09\uff1b\u800c\u5728 HTTP/2\uff0c\u7531\u4e8e\u5206\u5e27\u548c\u591a\u8def\u590d\u7528\uff0c\u4e00\u4e2a TCP \u8fde\u63a5\u5c31\u53ef\u4ee5\u5904\u7406\u591a\u4e2a\u8d44\u6e90\u8bf7\u6c42\u3002"),(0,o.kt)("p",null,"In ",(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2018/714"},"iOS 12"),", we have something new in ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession"),", ",(0,o.kt)("strong",{parentName:"p"},"HTTP/2 Connection Coalescing"),". It is going to be automatically done on for all your apps using ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession"),". \u76f8\u540c\u8bc1\u4e66\u3001\u76f8\u540c IP \u5730\u5740\u7684\u670d\u52a1\u5668\uff0c\u53ef\u4ee5\u590d\u7528 TCP \u8fde\u63a5\u3002"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img-80",src:n(78221).Z})),(0,o.kt)("p",null,"The first certificate presented to us covers all the subdomains under example.com. Also notice that delivery.example.com, it results to the same IP address as the first connection. It's safe to assume we're talking to the same endpoint and reuse the connection instead of opening a new one when we want to fetch the second resource."),(0,o.kt)("p",null,"Two to three times faster if you configure the ",(0,o.kt)("strong",{parentName:"p"},"Server Push")," on your HTTP/2 server! And you don't even have to change any code in your app! The data for your ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionDataTask")," will be delivered out of the Server Push storage directly to your application."),(0,o.kt)("h2",{id:"optimistic-dns"},"Optimistic DNS"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2018/"},"WWDC 2018 - Optimizing Your App for Today\u2019s Internet"))),(0,o.kt)("p",null,"Many servers have a very short time-to-live configured on their DNS records. And they do this such that if a server goes down or the server wants to load balance over another IP address, it can quickly change the IP address record and have clients adjust and start using the new address."),(0,o.kt)("p",null,"The downside, though, is that this really can hurt client performance. With a short time-to-live, a client will almost always have to take the round trip to do DNS, to request the address for the host name that you are connecting to. Most of the time, the server address has not changed at all, and so this is a wasted round trip."),(0,o.kt)("p",null,"So, optimistic DNS is a solution that we released last year that solves this problem. Optimistic DNS allows your connection to optimistically connect to the ",(0,o.kt)("strong",{parentName:"p"},"last known")," good IP address for that host name, in parallel with issuing a new query for the host name's current address. If nothing has changed, which is almost always the case, the connection will just establish to the old IP address. But if something has changed you'll still get the new IP address and connect to it instead."),(0,o.kt)("p",null,"It is on by default for connections using Network.framework and ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession"),"."),(0,o.kt)("h2",{id:"encrypted-dns"},"Encrypted DNS"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2020/10047"},"WWDC 2020 - Enable encrypted DNS"))),(0,o.kt)("p",null,"Encrypted DNS is a key technology for improving internet privacy. The privacy concern is that DNS requests and responses are sent over an unencrypted transport, UDP. That means that other devices on the network can not only see what names you're looking up, but they can even interfere with the responses."),(0,o.kt)("p",null,"Starting this year, Apple platforms natively support encrypted DNS. There are two supported protocols. ",(0,o.kt)("strong",{parentName:"p"},"DNS over TLS"),", also called DoT, and ",(0,o.kt)("strong",{parentName:"p"},"DNS over HTTPS"),", also called DoH."),(0,o.kt)("p",null,"There are two ways that encrypted DNS can be enabled:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The first way is to choose a single DNS server as the default resolver for all apps on the system. If you provide a public DNS server, you can now write a NetworkExtension app that configures the system to use your server. Or, if you use mobile device management, MDM, to configure enterprise settings on devices, you can push down a profile to configure encrypted DNS settings for your networks."),(0,o.kt)("li",{parentName:"ul"},"The second way is to select a specific server to use for some or all of your app's connections.")),(0,o.kt)("p",null,"To use encrypted DNS throughout your app:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-swift"},'import Network\n\nif let url = URL(string: "https://dnsserver.example.net/dns-query") {\n    let address = NWEndpoint.hostPort(host: "2001:db8::2", port: 443)\n    NWParameters.PrivacyContext.default.requireEncryptedNameResolution(true,\n        fallbackResolver: .http(url, serverAddresses: [ address ]))\n}\n\nlet task = URLSession.shared.dataTask(with: ...)\ntask.resume()\n\ngetaddrinfo(...)\n')),(0,o.kt)("p",null,"This applies your configuration to every DNS resolution initiated by your app, either when you use ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionTask"),", or when you use lower-layer APIs like ",(0,o.kt)("inlineCode",{parentName:"p"},"getaddrinfo"),"."),(0,o.kt)("h2",{id:"brotli"},"Brotli"),(0,o.kt)("p",null,"Brotli compression algorithm is about 15% better than gzip."),(0,o.kt)("p",null,"HTTPS response header ",(0,o.kt)("inlineCode",{parentName:"p"},"Content-Encoding: br")," supported in ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession"),". Requires HTTPS (TLS)."),(0,o.kt)("h2",{id:"websocket"},"WebSocket"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2019/712/?time=1614"},"WWDC 2019 - Advances in Networking, Part 1"))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"WebSocket")," allows bidirectional communication over a single HTTP connection. This enables developers to write applications like chat, multiplayer games, and other real-time applications."),(0,o.kt)("p",null,"Web applications were originally developed around a client/server model, where the Web client is always the initiator of transactions, requesting data from the server. Thus, there was no mechanism for the server to independently send, or push, data to the client without the client first making a request."),(0,o.kt)("p",null,"To overcome this deficiency, Web app developers can implement a technique called ",(0,o.kt)("strong",{parentName:"p"},"HTTP Long-Polling"),". When a client wants to receive a response from the server, it sends out a request. The server responds with a 200 status code immediately, but it does not send out the response body because it doesn't have one at this point. Sometime in the future, once the server has a response ready for the client, it sends it out to the client. At which point, the client sends a new request, indicating that it wants to receive the next message."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img-80",src:n(8605).Z})),(0,o.kt)("p",null,"There are some disadvantages associated with long polling. Both the end points when they want to send messages have to either send an HTTP request or an HTTP response, which is a lot of overhead. Additionally, complexity has to be maintained at the server to enable long polling."),(0,o.kt)("p",null,"Let's see how WebSockets can solve this problem. The first step of the WebSocket handshake, the client sends out a request to the server, indicating that it wants to upgrade this connection to WebSocket. The server responds with the 101 switching protocol to response, at which point we have a bidirectional stream between the two end points. Both the end points are now free to send messages in either direction without any HTTP overhead."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img-80",src:n(92011).Z})),(0,o.kt)("p",null,"WebSocket works over the well-known HTTP ports and is fully compatible with the existing web infrastructure, allowing you to connect to proxies, CDNs, and firewalls."),(0,o.kt)("p",null,"Historically, the WebSocket protocol has been available as a JavaScript API in web browsers, now we've decided to extend this API to our networking framework. This year we are excited to announce new ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionWebSocketTask")," API!"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-swift"},'// Create with URL\nlet task = URLSession.shared.webSocketTask(with: URL(string: "wss://websocket.example")!)\ntask.resume()\n// Send a message\ntask.send(.string("Hello")) { error in /* Handle error */ }\n// Receive a message\ntask.receive { result in /* Handle result */ }\n')),(0,o.kt)("p",null,"You can send data or string messages on the task. You can also receive messages on the task by passing a completion handler, which will be called asynchronously once we receive the entire message from the server."),(0,o.kt)("p",null,"The APIs available for you to add WebSockets to your apps today:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img-80",src:n(50479).Z})),(0,o.kt)("h2",{id:"cookie"},"Cookie"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"HTTPCookieStorage")," is a container that manages the storage of cookies."),(0,o.kt)("p",null,"The persistent cookie storage returned by ",(0,o.kt)("inlineCode",{parentName:"p"},"sharedHTTPCookieStorage")," may be available to app extensions or other apps."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Best Practices"),": Cookies, are not free and have a non-trivial cost in storing and looking them up."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Cookies are attached to all the requests that match the ",(0,o.kt)("strong",{parentName:"li"},"domain and path")," attribute. Please use that attribute wisely to make sure cookies required by the servers are attached to your requests."),(0,o.kt)("li",{parentName:"ul"},"Cooike can quickly increase your request size. Use of smaller cookies when possible, and delete those cookies you no longer need."),(0,o.kt)("li",{parentName:"ul"},"Try to save some state on the server so you can reduce the number of client-side cookies.")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Security"),": One thing we don't want to allow is for a website to set a cookie on the .com domain, which is then accessible to any other .com company. ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," can now receive ",(0,o.kt)("a",{parentName:"p",href:"https://publicsuffix.org/"},"Public Suffix List")," updates over the air. This is important for determining where administrative boundaries occur in the namespace of the Internet. Better security for users against cookie attacks."),(0,o.kt)("h2",{id:"caching"},"Caching"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2018/"},"WWDC 2018 - Optimizing Your App for Today\u2019s Internet"))),(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/foundation/url_loading_system"},"URL Loading System")," caches responses both in memory and on disk, improving performance and reducing network traffic."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionConfiguration")," has a property called ",(0,o.kt)("inlineCode",{parentName:"p"},"requestCachePolicy"),"; Each ",(0,o.kt)("inlineCode",{parentName:"p"},"URLRequest")," instance contains a ",(0,o.kt)("inlineCode",{parentName:"p"},"URLRequest.CachePolicy")," object to indicate if and how caching should be performed."),(0,o.kt)("p",null,"Currently, only HTTP and HTTPS responses are cached."),(0,o.kt)("p",null,"Caching is a great way of reducing latency but it's important to note that caching might result in disk IO. Also, ",(0,o.kt)("inlineCode",{parentName:"p"},"usePrococolCachePolicy")," caches HTTPS responses to disk, which may be undesirable for securing user data. Consider adopting the delegate method to decide what resources should be cached:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-swift"},'func urlSession(_ session: URLSession, dataTask: URLSessionDataTask,\n                willCacheResponse proposedResponse: CachedURLResponse,\n                completionHandler: @escaping (CachedURLResponse?) -> Void) {\n    if proposedResponse.response.url?.scheme == "https" {\n        let updatedResponse = CachedURLResponse(response: proposedResponse.response,\n                                                data: proposedResponse.data,\n                                                userInfo: proposedResponse.userInfo,\n                                                storagePolicy: .allowedInMemoryOnly)\n        completionHandler(updatedResponse)\n    } else {\n        completionHandler(proposedResponse)\n    }\n}\n')),(0,o.kt)("p",null,"For servers, please consider using cache control headers ",(0,o.kt)("inlineCode",{parentName:"p"},"Cache-Control: no-store")," to decide what resources should be cacheable."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"URLCache"),": An object that maps ",(0,o.kt)("inlineCode",{parentName:"p"},"URLRequest")," objects to ",(0,o.kt)("inlineCode",{parentName:"p"},"CachedURLResponse")," objects. ",(0,o.kt)("inlineCode",{parentName:"p"},"URLCache")," is thread safe."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-objc"},"NSURLCache *URLCache = [[NSURLCache alloc] initWithMemoryCapacity:4 * 1024 * 1024 diskCapacity:20 * 1024 * 1024 diskPath:nil];\n[NSURLCache setSharedURLCache:URLCache];\n")),(0,o.kt)("h2",{id:"statistics"},"Statistics"),(0,o.kt)("p",null,"Another evolution to the ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," API is the addition of network statistics."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"urlSession(_:task:didFinishCollecting:)")," tells the delegate that the session finished collecting metrics for the task."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"URLSessionTaskMetrics"),":"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"taskInterval: DateInterval")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"redirectCount: Int")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"transactionMetrics: [URLSessionTaskTransactionMetrics]"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Request and Response"),(0,o.kt)("li",{parentName:"ul"},"Protocol and Connection"),(0,o.kt)("li",{parentName:"ul"},"Load Info"),(0,o.kt)("li",{parentName:"ul"},"Connection Establishment and Transmission"),(0,o.kt)("li",{parentName:"ul"},"Address and port"),(0,o.kt)("li",{parentName:"ul"},"TLS version")))),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://docs-assets.developer.apple.com/published/573ade75c6/77f6bef0-3201-49ab-bed8-33ce7ec1072f.png",alt:"img"})),(0,o.kt)("h2",{id:"wi-fi-assist"},"Wi-Fi Assist"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2017/707/"},"WWDC 2017 - Advances in Networking, Part 1"))),(0,o.kt)("p",null,"We have Wi-Fi Assist since iOS 9 (2015). Wi-Fi Assist is triggered whenever we are in a marginal Wi-Fi scenario, which means the signal strength of Wi-Fi is very low. Whenever iOS is detecting this, it will play a contest between Wi-Fi and cellular data. So when you are creating a new connection, we will first attempt to create the connection on Wi-Fi. And shortly after that where if this connection hasn't been established, we will go on and create a connection over cell so that if cellular data wins, we will start using the cellular link."),(0,o.kt)("p",null,"In iOS 13, even when a flow has already been established on Wi-Fi and has started to exchange data, if later on the signal quality is reducing, we are able to move the next request over to cell."),(0,o.kt)("p",null,"If Wi-Fi associated once again, You get automatic reliable network fallback if you use ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," and CFNetwork-layer APIs. What you can do is pay attention to the better route notification so that you migrate back to Wi-Fi when it's available."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-swift"},"func urlSession(_ session: URLSession, betterRouteDiscoveredFor streamTask: URLSessionStreamTask) {}\n")),(0,o.kt)("h2",{id:"multipath-tcp"},"Multipath TCP"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2017/707/"},"WWDC 2017 - Advances in Networking, Part 1"))),(0,o.kt)("p",null,"Now in iOS 11, we are adding Multipath TCP (MPTCP) into Wi-Fi Assist. You will need to add the capability Multipath in Xcode."),(0,o.kt)("p",null,"Multipath TCP is the protocol that has been designed specifically for mobile devices. It is specified by the IETF as a standard (March 2020, RFC 8684), and it provides the exact same service as TCP."),(0,o.kt)("p",null,"What it does on top of TCP is that it provides a way to seamlessly move traffic from the Wi-Fi interface over to the cellular interface whenever it realizes that Wi-Fi is not good enough, and it also allows to move the traffic back again so that your application is not consuming cellular data. It is also able to choose the best interface if you have a latency-sensitive and interactive flow."),(0,o.kt)("p",null,"If you are building your application on top of the ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," API, Multipath TCP sits just below this. It creates the so-called TCP subflows. Those TCP subflows, one for each interface are actually full-fledged TCP connections, and MPTCP is in charge of making sure that the data gets sent over either of them."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(78551).Z})),(0,o.kt)("p",null,"You will need to update or change your server infrastructure to start supporting Multipath TCP.\uff08\u54a8\u8be2\u4f60\u7684\u670d\u52a1\u5668\u4f9b\u5e94\u5546\u662f\u5426\u652f\u6301\u8fd9\u4e2a\u534f\u8bae\uff1b\u6216\u8005\u66f4\u65b0\u670d\u52a1\u5668 Linux \u5185\u6838\u4ee5\u652f\u6301\u8fd9\u4e2a\u534f\u8bae\uff0cAWE/GCE \u90fd\u5df2\u7ecf\u6709\u53ef\u7528\u7684\u955c\u50cf\uff09"),(0,o.kt)("p",null,"We are exposing ",(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/foundation/urlsessionconfiguration/multipathservicetype"},"two types of different services")," using MPTCP."),(0,o.kt)("p",null,"The first one is the handover mode which provides a high reliability for your long-length, hard-to-recover connections. In Wi-Fi Assist we have limits that try to limit the amount of data that we are sending on the cellular link. So we encourage you to use the handover mode only for low volume connections."),(0,o.kt)("p",null,"The second is the interactive mode, this one provides a low latency response for your interactive and latency sensitive connections. Whenever you're using the interactive mode, we will bring up both Wi-Fi and cell right away, even if Wi-Fi is in a good state, just like what we are doing on Siri."),(0,o.kt)("h2",{id:"network-service-type"},"Network Service Type"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2016/714/"},"WWDC 2016 - Networking for the Modern Internet"))),(0,o.kt)("p",null,"You might be familiar with five QoS classes associated with dispatch queues and ",(0,o.kt)("inlineCode",{parentName:"p"},"Operation")," objects. ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," is QoS-aware which means it will capture the QoS off the queue on which you call ",(0,o.kt)("inlineCode",{parentName:"p"},"task.resume()"),". And all the messages that it sends to your delegates will respect this QoS. For example, if your app wants to fetch some data which is not time critical, consider resuming that task on a queue which has background QoS to make sure this task does not contend for CPU with other higher priority work that your app might be doing."),(0,o.kt)("p",null,"Starting in iOS 5 we had the ",(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/foundation/nsurlrequest/networkservicetype"},(0,o.kt)("inlineCode",{parentName:"a"},"networkServiceType"))," API allowing you to classify your network traffic that helps the system prioritize the data leaving the device. It's a way expressing whether you want low throughput and low latency or high throughput and moderate latency."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Service Type"),(0,o.kt)("th",{parentName:"tr",align:null},"Availability"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"default"),(0,o.kt)("td",{parentName:"tr",align:null},"iOS 4.0+"),(0,o.kt)("td",{parentName:"tr",align:null},"standard network traffic")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"video"),(0,o.kt)("td",{parentName:"tr",align:null},"iOS 5.0+"),(0,o.kt)("td",{parentName:"tr",align:null},"video traffic")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"voice"),(0,o.kt)("td",{parentName:"tr",align:null},"iOS 5.0+"),(0,o.kt)("td",{parentName:"tr",align:null},"voice traffic")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"background"),(0,o.kt)("td",{parentName:"tr",align:null},"iOS 5.0+"),(0,o.kt)("td",{parentName:"tr",align:null},"background traffic, e.g. discretionary download")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"avStreaming"),(0,o.kt)("td",{parentName:"tr",align:null},"iOS 7.0+"),(0,o.kt)("td",{parentName:"tr",align:null},"streaming audio/video data")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"responsiveAV"),(0,o.kt)("td",{parentName:"tr",align:null},"iOS 7.0+"),(0,o.kt)("td",{parentName:"tr",align:null},"responsive (time-sensitive) audio/video data.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"callSignaling"),(0,o.kt)("td",{parentName:"tr",align:null},"iOS 10.0+"),(0,o.kt)("td",{parentName:"tr",align:null},"network traffic that establishes, maintains, or tears down a VoIP call")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"responsiveData"),(0,o.kt)("td",{parentName:"tr",align:null},"iOS 12.0+"),(0,o.kt)("td",{parentName:"tr",align:null},"This service type\u2019s priority is higher than 'default'. Use this service type for interactive situations where the user is anticipating a quick response, like instant messaging or completing a purchase.")))),(0,o.kt)("p",null,"voice > callSignaling > video > responsiveData > default > background"),(0,o.kt)("p",null,"\u7b14\u8bb0\uff1a\u5bf9\u5e94\u7528\u5185\u7684\u4e0d\u540c\u7f51\u7edc\u8bf7\u6c42\u533a\u5206\u670d\u52a1\u7c7b\u578b\u3002\u5927\u90e8\u5206\u7684\u7f51\u7edc\u8bf7\u6c42\u90fd\u53ef\u4ee5\u5f52\u7c7b\u5230 ",(0,o.kt)("inlineCode",{parentName:"p"},"default")," \u548c ",(0,o.kt)("inlineCode",{parentName:"p"},"background"),"\u3002\u5176\u5b83\u7684\u60c5\u51b5\u4f8b\u5982\uff0c\u5bf9\u9700\u8981\u957f\u65f6\u95f4\u4fdd\u6301\u8fde\u63a5\u7684\u201c\u5fc3\u8df3\u201d\u670d\u52a1\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u4e00\u4e2a\u4f4e\u5ef6\u65f6\u4f4e\u541e\u5410\u91cf\u7684\u670d\u52a1\u7c7b\u578b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5728\u7f51\u7edc\u5c42\u3001\u94fe\u8def\u5c42\u505a\u4e86\u4e00\u7cfb\u5217\u7684\u5de5\u4f5c\uff0c\u63d0\u4f9b\u6211\u4eec\u60f3\u8981\u7684\u670d\u52a1\u3002"),(0,o.kt)("p",null,"IP-Layer DSCP QoS Marking: In August of 2015, Apple and Cisco announced a partnership to create a fast lane for iOS business apps. With iOS 10 we are introducing new Quality of Service features to optimize enterprise iOS apps with Cisco networks. Traffic marked with the network service type property will maintain this tag across all the hops when on a Cisco Fast Lane network. Recognizes Cisco fast lane network and sets Differentiated Services Code Point (DSCP) marking appropriately. Useful for: Telephony apps; Backup and other bulk upload apps."),(0,o.kt)("p",null,"Link-Layer QoS Marking: Controls packet queuing and scheduling on network interface. When you set these options, a couple of things happen. On the device itself, there are multiple outband queues, and the type of service you set for your traffic controls which queue it uses. On Wi-Fi interfaces, it will also set the wireless multi-media access category."),(0,o.kt)("h2",{id:"ecn"},"ECN"),(0,o.kt)("p",null,"On any path between two devices there will be one link that has the lowest throughput, that's the ",(0,o.kt)("strong",{parentName:"p"},"bottleneck")," link. The job of the transport protocol is to work out its share of the bottleneck link."),(0,o.kt)("p",null,"\u6ca1\u6709\u4f7f\u7528 ECN \u4e4b\u524d\uff0cTCP \u4f1a\u4e0d\u65ad\u589e\u52a0\u62e5\u585e\u7a97\u53e3\u5927\u5c0f\u53bb\u5c3d\u53ef\u80fd\u5229\u7528\u66f4\u591a\u7684\u5e26\u5bbd\u3001\u7136\u540e\u53d1\u751f\u4e22\u5305\u3001\u51cf\u5c0f\u62e5\u585e\u7a97\u53e3\u5927\u5c0f\u5e76\u91cd\u4f20\uff0c\u5982\u6b64\u5faa\u73af\u3002\u4e00\u76f4\u4ee5\u6765\u8fd9\u4e2a\u673a\u5236\u90fd\u8fd0\u884c\u5f97\u5f88\u597d\u3002Historically, packet loss and retransmission has not caused big problems for the traditional networking applications like file transfer and sending email. But when you are watching streaming video, you really want the packets come in order. So in-order delivery has become a much more pressing problem."),(0,o.kt)("p",null,"Dropping packets is an expensive way to signal congestion. Marking packets \u201cCongestion Experienced\u201d is less destructive."),(0,o.kt)("p",null,'CoDel (pronounced "coddle") for controlled delay is a scheduling algorithm designed to overcome bufferbloat in networking hardware, such as routers. CoDel (or similar Smart Queue Management) plus ECN does helps to reduce network delay and packet loss!'),(0,o.kt)("p",null,"It is in Linux and turned on by default, more than half of the top million web servers in the world already support ECN. ECN now enabled in OS X 10.11 and iOS 9 for all TCP connection."),(0,o.kt)("p",null,"One common misunderstanding about ECN is that it has to be supported end to end on the entire path across the internet, and that's not true. There is only one place that needs to support ECN for you to get the benefit. For your residential network access, you may have paid for 20 or 50 megabits of service and your ISP artificially throttle your data to the rate you've paid for. So the bottleneck is always the one that exists at your ISP's headend equipment. That is the only place on the path that needs to mark congestion."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2021/10239/"},"Reduce network delays for your app - WWDC 2021"))),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(41159).Z})),(0,o.kt)("p",null,"Packets spend a lot of time sitting in excessively large buffers in the network. This phenomenon of excessively large buffers is called bufferbloat."),(0,o.kt)("p",null,"There's software and hardware processing time. As CPUs get ever faster, this processing time continues to shrink."),(0,o.kt)("p",null,"There's the actual data transmission time. As data rates increase from kilobits to megabits to gigabits per second, transmission time continues to shrink."),(0,o.kt)("p",null,"Then there's the time delay due to buffering in the network. We're working with the industry on reducing these delays."),(0,o.kt)("p",null,"But there's always going to be the speed-of-light signal propagation delay. Back in the 1990s, the Stanford-to-MIT ping time, round-trip, coast-to-coast, across the United States, was already under 100 milliseconds. That's pretty close to the speed-of-light limit already, so it's not going to get much better."),(0,o.kt)("p",null,"As an app developer, there's not a lot you can do to improve the underlying network round-trip time, but you can control how many round trips your app requires. Every developer who wants great network performance should pay attention to the number of round trips. (HTTP3 + QUIC saves round trips against TCP + TLS1.2!)"),(0,o.kt)("h2",{id:"tcp_notsent_lowat"},"TCP_NOTSENT_LOWAT"),(0,o.kt)("p",null,"Screen Sharing problem. The default socket send buffer at that time was 120 kilobytes, my throughput was about 50 kilobytes a second (DSL access network was very slow at upstream direction), so that's about 2.5 seconds delay I was seeing."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"setsockopt(skt, IPPROTO_TCP, TCP_NOTSENT_LOWAT, &threshold, sizeof(threshold));")),(0,o.kt)("p",null,"When you set that socket option, the socket send buffer remains unchanged (in this example, 128kB). The difference is that your runloop will not report the socket as being writable until the unsent data has drained to some fairly low threshold, typically 8 or 16 kilobytes. When the socket becomes writable, you then write a single useful atomic chunk into the buffer."),(0,o.kt)("p",null,"\u8fd9\u4e2a\u9009\u9879\u5bf9\u5c4f\u5e55\u5171\u4eab\u8fd9\u7c7b\u5b9e\u65f6\u5e94\u7528\u975e\u5e38\u6709\u7528\uff01\u5728\u8fd9\u4e2a\u6848\u4f8b\u4e2d\uff0c\u4e0a\u884c\u5e26\u5bbd\u5f88\u5c0f\u3001\u5927\u91cf\u6570\u636e\u505c\u6ede\u5728 TCP send buffer \u4e2d\u7b49\u5f85\u4f20\u8f93\uff0c\u901a\u8fc7\u8bbe\u7f6e\u8fd9\u4e2a\u9009\u9879\uff0c\u5e94\u7528\u5c42\u5c31\u4e0d\u4f1a\u6bcf\u4ea7\u751f\u4e00\u4e2a\u5c4f\u5e55\u5e27\u5c31\u5f80 socket \u4f20\u9012\u6570\u636e\u3001\u585e\u6ee1\u7f13\u51b2\u533a\uff0c\u800c\u603b\u662f\u7b49\u5f85\u7f13\u51b2\u533a\u76f8\u5bf9\u8f83\u5c0f\u65f6\u3001\u518d\u628a\u6700\u65b0\u7684\u5c4f\u5e55\u5e27\u4f20\u7ed9 socket\uff0c\u81f3\u4e8e\u4e2d\u95f4\u8fd9\u4e9b\u5e27\u600e\u4e48\u529e\u5462\uff1f\u76f4\u63a5\u4e22\u6389\u5c31\u53ef\u4ee5\u4e86\uff0c\u53cd\u6b63\u6211\u4eec\u5e76\u4e0d\u5728\u4e4e\uff01"),(0,o.kt)("p",null,"It's available in Linux too because this option applies at the source of the data on the sending side. So for those of you who are running Linux servers, this option is available too. This option will be turned on automatically for all connections using the higher layer ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," and CFNetwork APIs."),(0,o.kt)("p",null,"But most servers on the internet run on Linux and use BSD Sockets. Contact your server operators to ensure that they are using the TCP not sent low watermark socket option to reduce the delays at the source."),(0,o.kt)("h2",{id:"tcp-fast-open"},"TCP Fast Open"),(0,o.kt)("p",null,"TCP Fast Open combines the connection setup and the data exchange into one packet exchange."),(0,o.kt)("p",null,"This is not turned on by default. The reason is, if one of those packets is delayed and shows up much later, then to the server that looks like a perfectly valid TFO request, and whatever the operation was, it will do it again. If that operation was sending you a JPEG image, doing it twice may be no big deal. If that operation was sending you a pair of shoes from Zappos, then doing it twice might not be what you want."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(43458).Z})),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2021/10239/"},"Reduce network delays for your app - WWDC 2021")),(0,o.kt)("p",null,"TCP Fast Open is supported in Network framework and Sockets."),(0,o.kt)("p",null,"To use it with ",(0,o.kt)("inlineCode",{parentName:"p"},"NWConnection"),", there are two options:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"First, your app provides the initial data to be sent out with the handshake."),(0,o.kt)("li",{parentName:"ul"},"Second, send the TLS handshake message as the initial data.")),(0,o.kt)("p",null,"When using TCP Fast Open, you have to be careful that you only send idempotent requests with the handshake. Idempotent basically means that the data is safe to be replayed over the network."),(0,o.kt)("h2",{id:"supporting-ipv6"},"Supporting IPv6"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2015/719/"},"WWDC 2015 - Your App and Next Generation Networks"))),(0,o.kt)("p",null,"Test IPv6: ",(0,o.kt)("a",{parentName:"p",href:"https://test-ipv6.com/index.html.zh_CN"},"https://test-ipv6.com/index.html.zh_CN")),(0,o.kt)("p",null,"Test IPv6 network: Mac - System Preferences - Sharing - Internet Sharing - Create NAT64 Network."),(0,o.kt)("p",null,"We realized that we were running out of IPv4 addresses way too fast. So we added a NAT in the middle. This works, but the larger scale NAT device is both expensive and fragile. LinkedIn reports that the page load time over IPv6 is 10 to 40 percent ",(0,o.kt)("strong",{parentName:"p"},"faster")," than over IPv4. They theorize that that is due to less overhead setting up connections through overloaded large scale NATs."),(0,o.kt)("p",null,"Subscribers are now connecting to cellular data networks over IPv6. The cellular carriers now have to support both IPv4 and IPv6 in their network. But what they really want to do is to drop IPv4 from their access network. So now they have deployed ",(0,o.kt)("strong",{parentName:"p"},"DNS64")," and ",(0,o.kt)("strong",{parentName:"p"},"NAT64")," in their network, and the way it works is when the application on the client device makes a hostname query to get the IPv6 address for an IPv4-only server, DNS64 and the network synthesizes an IPv6 address and gives it back to the client device. Now that the client device has this IPv6 address to work with, it can start writing traffic to the network."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img-80",src:n(1607).Z})),(0,o.kt)("p",null,"If you are working with an IPv4 address literal, new in OS X 10.11 and iOS 9, higher-layer networking frameworks (",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," and CFNetwork-layer APIs) will works in even in IPv6-only network! The OS synthesizes IPv6 address for you. BUT, using literal IPv4 addresses will prevent direct IPv6 connection to a dual-stack server.\uff08\u670d\u52a1\u5668\u540c\u65f6\u652f\u6301 IPv4 \u548c IPv6\uff0c\u4f7f\u7528\u5b57\u9762 IPv4 \u5730\u5740\u4f1a\u8fde\u63a5\u5230\u670d\u52a1\u5668 IPv4 \u7684\u670d\u52a1\uff09"),(0,o.kt)("p",null,"We recommend you use hostnames. That way you can get a v4 address on a v4 network and a v6 address on a v6 network."),(0,o.kt)("h2",{id:"optimize-for-5g-networks"},"Optimize for 5G networks"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2021/10103/"},"Optimize for 5G networks - WWDC 2021"))),(0,o.kt)("p",null,"Each step in network evolution has brought dramatically new capabilities to mobile devices."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(3708).Z})),(0,o.kt)("p",null,"5G come primarily in two varieties, commonly referred to as Non-Standalone (NSA) and Standalone (SA)."),(0,o.kt)("p",null,"Non-Standalone is built on the existing LTE core and can use both LTE and 5G links to schedule traffic, operates at frequencies below 7 GHz, and includes support for millimeter wave."),(0,o.kt)("p",null,"Standalone is built entirely on the new 5G core, also operates at frequencies below 7 GHz, and includes support for millimeter wave, and delivers improved latency performance over LTE."),(0,o.kt)("p",null,'We pick the best network using two techniques called "Automatic Switch to 5G" and "Smart Data Mode". Both technologies look at a combination of performance, security, and power characteristics to enable the best wireless connection for your app.'),(0,o.kt)("p",null,"Best Practices:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"With the system choosing the best network on your behalf, you should stop considering the network type."),(0,o.kt)("li",{parentName:"ul"},"Use our frameworks to take full advantage of 5G. (AVFoundation, CallKit, URLSession, Network.framework)"),(0,o.kt)("li",{parentName:"ul"},"Tune your application for ",(0,o.kt)("strong",{parentName:"li"},"constrained")," and ",(0,o.kt)("strong",{parentName:"li"},"expensive"),' paths. "Allow More Data on 5G" indicating an inexpensive path, similar to Wi-Fi; "Standard mode" is usually considered as expensive; and "Low Data Mode" is considered constrained.')),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/foundation/urlerror/3329607-networkunavailablereason/"},"networkUnavailableReason")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/avfoundation/avurlassetallowscellularaccesskey?language=objc"},"AVURLAssetAllowsCellularAccessKey")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/avfoundation/avurlassetallowsconstrainednetworkaccesskey?language=objc"},"AVURLAssetAllowsConstrainedNetworkAccessKey")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/avfoundation/avurlassetallowsexpensivenetworkaccesskey?language=objc"},"AVURLAssetAllowsExpensiveNetworkAccessKey")),(0,o.kt)("h2",{id:"network-security"},"Network Security"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2017/701/"},"WWDC 2017 - Your Apps and Evolving Network Security Standards")),(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2018/714/"},"WWDC 2018 - Optimizing Your App for Today\u2019s Internet"))),(0,o.kt)("h3",{id:"app-transport-security"},"App Transport Security"),(0,o.kt)("p",null,"App Transport Security is a new feature from Apple in iOS 9. ATS places restrictions on TLS versions, cipher suites used, certificate trusts, and certificate key sizes that are used in that transaction."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"CFNETWORK_DIAGNOSTICS=1")," to help you to find out TLS issues in your app. (Xcode -> Edit Scheme -> Arguments -> Environment Variables)"),(0,o.kt)("p",null,"There is a command line tool on macOS called ",(0,o.kt)("inlineCode",{parentName:"p"},"nscurl"),"."),(0,o.kt)("h3",{id:"certificate-revocation"},"Certificate Revocation"),(0,o.kt)("p",null,"The most common reason for revocation of certificate is the user no longer being in sole possession of the private key (e.g., the token containing the private key has been lost or stolen)."),(0,o.kt)("p",null,'In cryptography, a certificate revocation list (or CRL) is "a list of digital certificates that have been revoked by the issuing certificate authority (CA) before their scheduled expiration date and should no longer be trusted".'),(0,o.kt)("p",null,'The Online Certificate Status Protocol (OCSP) stapling is a standard for checking the revocation status of X.509 digital certificates. It allows the presenter of a certificate to bear the resource cost involved in providing OCSP responses by appending ("stapling") a time-stamped OCSP response signed by the CA to the initial TLS handshake, eliminating the need for clients to contact the CA, with the aim of improving both security and performance.'),(0,o.kt)("p",null,"But OCSP stapling actually doesn't protect users against malicious servers. In particular, the malicious server just need omit the stapled OCSP response and the client will never know that that malicious server has a revoked certificate."),(0,o.kt)("p",null,"Apple is enhanceing this. First, we gather information from certificate transparency logs. CT logs contain cryptographic proofs of the existence of a certificate. We request all of the revocation information from certificate authorities. We aggregate it into a single efficient bundle, and then make it available to all of our clients. Those clients check in periodically with us to get that bundled revocation information, and use that latest status revocation information when checking server certificates that they are using. If the client hits a certificate that is listed there and your servers are not using OCSP Stapling, the client will then perform OCSP."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(46150).Z})),(0,o.kt)("h3",{id:"certificate-transparency"},"Certificate Transparency"),(0,o.kt)("p",null,"You've probably heard cases where certificate authorities, either through malice or incompetence, issue rogue certificates to entities that they should not. The solution to this is something called certificate transparency logs."),(0,o.kt)("p",null,"When a certificate authority issues a certificate to a server, it also records that with the log and the log gives the server a signed affidavit \u5ba3\u8a93\u4e66 that its certificate has been publicly recorded. And then when the client connects, the server can give all that information to the client and the client can verify that not only this is a signed certificate, it is a publicly logged signed certificate. The client will reject those doesn't have the affidavit to attest \u8bc1\u660e it being recorded in a public log."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img-80",src:n(8397).Z})),(0,o.kt)("p",null,"In iOS 12.1, certificates issued after October 15, 2018, from a system-trusted root certificate must be logged in a trusted Certificate Transparency log to be allowed for TLS connections."),(0,o.kt)("h3",{id:"tls-13"},"TLS 1.3"),(0,o.kt)("p",null,"TLS 1.3 is enabled by default for Network.framework and ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," APIs since iOS 13.4."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(57789).Z})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"One round trip (almost always) connection setup"),(0,o.kt)("li",{parentName:"ul"},"Strong cryptography AEAD with Forward Secrecy by default"),(0,o.kt)("li",{parentName:"ul"},"Privacy: certificates and most handshake fields are encrypted")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://youtu.be/yPdJVvSyMqk"},"TLS 1.3 Handshake"))),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(86510).Z})),(0,o.kt)("p",null,"The TLS 1.3 protocol defines ",(0,o.kt)("strong",{parentName:"p"},"early data support"),", which can save yet another round trip by sending idempotent requests along with the TLS handshake message."),(0,o.kt)("h3",{id:"forward-secrecy"},"Forward Secrecy"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://youtu.be/IkM3R-KDu44"},"Perfect Forward Secrecy")),(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://youtu.be/pa4osob1XOk"},"Explaining the Diffie-Hellman Key Exchange"))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Key exchange or key agreement"),": Before a client and server can begin to exchange information protected by TLS, they must securely exchange or agree upon an encryption key and a cipher to use when encrypting data."),(0,o.kt)("p",null,"The client and server need to ",(0,o.kt)("strong",{parentName:"p"},"exchange keys")," and ultimately come to a ",(0,o.kt)("strong",{parentName:"p"},"shared secret key")," to do the encryption. The essence of the Diffie-Hellman Key Exchange is working on how they actually exchange keys. The DHE does not rely on the client and server using the private/public key in order to exchange the premaster key. ",(0,o.kt)("strong",{parentName:"p"},"They generates PMS by their own random number!")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(3474).Z})),(0,o.kt)("p",null,"Forward Secrecy is an outcome if you choose the Diffie-Hellman Key Exchange as the cipher suite of your TLS handshake."),(0,o.kt)("p",null,"Perfect Forward Secrecy is an outcome if you use a ",(0,o.kt)("strong",{parentName:"p"},"brand new")," random number in the Diffie-Hellman Key Exchange every single session."),(0,o.kt)("h2",{id:"bonjour-and-local-network"},"Bonjour and Local Network"),(0,o.kt)("p",null,"Bonjour \u662f\u82f9\u679c\u5f00\u53d1\u7684\u3001\u57fa\u4e8e multicast DNS \u7684\u3001\u5f00\u653e\u6027\u3001\u96f6\u8bbe\u7f6e\u7684\u7f51\u7edc\u6807\u51c6\u3002Bonjour \u80fd\u8ba9 IP \u7f51\u7edc\u4e0a\u7684\u8bbe\u5907\u81ea\u52a8\u53d1\u73b0\u5f7c\u6b64\uff0c\u800c\u4e0d\u9700\u8f93\u5165 IP \u5730\u5740\u6216\u914d\u7f6e DNS \u670d\u52a1\u5668\u3002\u4f7f\u7528 Bonjour \u7684\u8bbe\u5907\u5728\u7f51\u7edc\u4e2d\u81ea\u52a8\u4f20\u64ad\u81ea\u5df1\u7684\u670d\u52a1\u4fe1\u606f\u3001\u5e76\u8046\u542c\u5176\u5b83\u8bbe\u5907\u7684\u670d\u52a1\u4fe1\u606f\uff0c\u8bbe\u5907\u4e4b\u95f4\u5c31\u50cf\u5728\u6253\u62db\u547c\uff0c\u8fd9\u4e5f\u662f\u5176\u547d\u540d\u4e3a Bonjour\uff08\u6cd5\u8bed\uff1a\u4f60\u597d\uff09\u7684\u539f\u56e0\u3002"),(0,o.kt)("p",null,"Bonjour is how you advertise and discover services on the network. It's used anytime you play peer-to-peer games, communicating with printers, cameras and home devices, anytime you are connecting to something without typing in an IP address or a host name. Bonjour is now available on every major platform."),(0,o.kt)("p",null,"We can ",(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2019/713/"},"now")," make peer-to-peer connections and use wide-area discovery."),(0,o.kt)("p",null,"There are several different APIs that allow your app to use Bonjour:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Network.framework (",(0,o.kt)("inlineCode",{parentName:"li"},"NWBrowser"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"NWListener.Service"),")"),(0,o.kt)("li",{parentName:"ul"},"Foundation (NetService)"),(0,o.kt)("li",{parentName:"ul"},"MultipeerConnectivity"),(0,o.kt)("li",{parentName:"ul"},"dnssed APIs")),(0,o.kt)("p",null,"On Apple devices, the best way to use the local network is with Bonjour. Some apps also interact with the local network at a lower level. Your app may configure a Wi-Fi router, or use a custom multicast or broadcast protocol to communicate with legacy hardware."),(0,o.kt)("p",null,"In iOS 14, users can now control which apps are allowed to access and interact with the local network."),(0,o.kt)("p",null,"If your app just accesses resources on the wide internet, you don't need to do anything different. You also don't need to update if you only interact with the local network using a system service, like AirPrint, AirPlay, AirDrop, or HomeKit. These system services handle device discovery without exposing the full list of devices to apps."),(0,o.kt)("p",null,"On the other hand, if your app accesses the local network directly within your app, either with unicast or multicast protocols, your app will require permission."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(58560).Z})),(0,o.kt)("p",null,"There are two new keys you can provide in your app's Info.plist."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(37663).Z})),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"NSLocalNetworkUsageDescription")," explains which features in your app require the local network."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"NSBonjourServices"),": If your app uses Bonjour to browse or advertise, you must provide a list of the service types that you use. Each service type is a unique string registered with IANA (Internet Assigned Numbers Authority), that identifies your application protocol."),(0,o.kt)("h2",{id:"networkframework"},"Network.framework"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2018/715/"},"WWDC 2018 - Introducing Network.framework: A modern alternative to Sockets"))),(0,o.kt)("p",null,"Thirty years ago we had BSD Sockets. It was a great API. But now the Internet has become a lot more complicated."),(0,o.kt)("p",null,"You may have assumed that ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," is also just a wrap around Sockets. Not quite. ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," is actually built using Apple's user space networking code Network.framework. Now in iOS 12, we are exposing that same API that ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession")," uses!"),(0,o.kt)("p",null,"And if you're the developer of third-party libraries that are built on BSD Sockets, we encourage you to look at the Network.framework APIs."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(96187).Z})),(0,o.kt)("p",null,"Use this framework when you need direct access to protocols like TLS, TCP, and UDP for your custom application protocols. Continue to use ",(0,o.kt)("inlineCode",{parentName:"p"},"URLSession"),", which is built upon this framework, for loading HTTP- and URL-based resources."),(0,o.kt)("h2",{id:"network-extension"},"Network Extension"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2015/717/"},"WWDC 2015 - What's New in Network Extension and VPN"))),(0,o.kt)("p",null,"With the NetworkExtension framework, you can customize and extend the core networking features."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(17940).Z})),(0,o.kt)("h3",{id:"nehotspothelper"},"NEHotspotHelper"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"NEHotspotHelper")," API gives your app the ability to perform custom authentication for Wi-Fi Hotspots."),(0,o.kt)("p",null,"This works is you first register your app with the system as a Hotspot helper. Then as the device comes within range of Wi-Fi networks, scanning for Wi-Fi networks or the user selects a Wi-Fi network to connect to, the system run your app in the background, call into your app and give your app the opportunity to claim the Wi-Fi Hotspot with a level of confidence, high, medium or low. If you claim a Hotspot with a high level of confidence, the system will call you to actually perform the authentication with the Wi-Fi Hotspot. And it will periodically call you to maintain the authentication session."),(0,o.kt)("p",null,"The Hotspot helper API also allows you to annotate Wi-Fi networks that show up in the settings app and you can ",(0,o.kt)("strong",{parentName:"p"},"annotate")," these Wi-Fi networks with the name of your app or the name of your company."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img-40",src:n(28631).Z})),(0,o.kt)("h3",{id:"nehotspotconfiguration"},"NEHotspotConfiguration"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"NEHotspotConfiguration"),"\uff1a\u5e94\u7528\u5185\u901a\u8fc7\u8fd9\u4e2a\u63a5\u53e3\u5feb\u6377\u5730\u8fde\u63a5\u5230\u76f8\u673a\u7b49\u8bbe\u5907\u5f00\u542f\u7684 Wi-Fi \u70ed\u70b9\uff0c\u800c\u4e0d\u5fc5\u79bb\u5f00 App\u3001\u5230\u8bbe\u7f6e - Wi-Fi \u53bb\u8fde\u63a5\u3002\u5f53\u7136\uff0c\u5982\u679c\u4f60\u5f00\u53d1\u4e86\u4e00\u4e2a\u661f\u5df4\u514b\u5e94\u7528\uff0c\u4e5f\u53ef\u4ee5\u5728\u7528\u6237\u5230\u5496\u5561\u5e97\u65f6\uff0c\u81ea\u52a8\u63d0\u793a\u4ed6\u4eec\u52a0\u5165\u5e97\u91cc\u7684 Wi-Fi\u3002"),(0,o.kt)("h3",{id:"nevpnmanager"},"NEVPNManager"),(0,o.kt)("p",null,"You can create a single personal VPN configuration for the app, which is represented by a single ",(0,o.kt)("inlineCode",{parentName:"p"},"NEVPNManager")," object. And personal VPN configurations coexist and cooperate with enterprise VPN configurations."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-swift"},'import NetworkExtension\n// Each app gets a single configuration.\nlet manager = NEVPNManager.sharedManager()\n// Connect automatically on a matching network.\nlet connectRule = NEOnDemandRuleConnect()\n// Match all Wi-Fi networks.\nconnectRule.interfaceTypeMatch = .WiFi\n// Set rule in array.\nmanager.onDemandRules = [ connectRule ]\nmanager.saveToPreferencesWithCompletionHandler { error in\n    // Handle error or success.\n}\nmanager.loadFromPreferencesWithCompletionHandler { error in\n    // Protocol is a keyword, so it needs to be quoted.\n    if manager.`protocol` == nil {\n        let newIPSec = NEVPNProtocolIKEv2()\n        newIPSec.serverAddress = "my.personal.vpn"\n        // Set all of the properties on newIPSec.\n        manager.`protocol` = newIPSec\n        manager.enabled = true\n        manager.saveToPreferencesWithCompletionHandler { error in\n            // Handle error or success.\n        }\n    }\n}\n')),(0,o.kt)("div",{class:"mermaid"},"graph LR NETunnelProviderManager --\x3e NSVPNManager NEAppProxyProviderManager --\x3e NETunnelProviderManager"),(0,o.kt)("p",null,"Like its superclass ",(0,o.kt)("inlineCode",{parentName:"p"},"NEVPNManager"),", you use the ",(0,o.kt)("inlineCode",{parentName:"p"},"NETunnelProviderManager")," class to configure and control VPN connections. The difference is that ",(0,o.kt)("inlineCode",{parentName:"p"},"NETunnelProviderManager")," is used to to configure and control VPN connections that use a custom VPN protocol."),(0,o.kt)("h3",{id:"nepackettunnelprovider"},"NEPacketTunnelProvider"),(0,o.kt)("div",{class:"mermaid"},"graph LR NETunnelProvider --\x3e NEProvider NEPacketTunnelProvider --\x3e NETunnelProvider NEAppProxyProvider --\x3e NETunnelProvider"),(0,o.kt)("p",null,"Implement a ",(0,o.kt)("strong",{parentName:"p"},"VPN client")," for a packet-oriented, custom VPN protocol. When the system starts a VPN configuration that uses your packet tunnel provider, it launches your app extension, instantiates your packet tunnel provider subclass within that app extension, and starts forwarding packets to your provider."),(0,o.kt)("h3",{id:"nefilterprovider"},"NEFilterProvider"),(0,o.kt)("p",null,"There are some ways that schools can do network content filtering with iOS devices. They can deploy an on-site content filter, put a device on their local network and route all their Internet traffic through that. The draw back with this is that it's only available on the school's local network. If the students want to take the schools iPads or iPhones home they either can't browse the Internet at all when they are home or browse the Internet unfiltered."),(0,o.kt)("p",null,"The best solution for schools is to filter the network content on the device. Before it leaves the device and just before it's actually delivered to the user."),(0,o.kt)("h3",{id:"nednsproxyprovider"},"NEDNSProxyProvider"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"NEDNSProxyProvider")," allows you to, in its simplest mode, redirect all the inquiries to a resolver that you own. Or you can even use it to get the individual DNS queries and send them over a custom protocol such as DNS over TLS or DNS over HTTP."),(0,o.kt)("h3",{id:"local-push-connectivity"},"Local Push Connectivity"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2020/10113/"},"Build local push connectivity for restricted networks"))),(0,o.kt)("p",null,"Let's review how APNs works. Your provider server sends a push notification request to the APNs. APNs conveys corresponding notification payloads to each targeted device. On receipt of a notification, the system delivers the payload to the appropriate app on the device.\nDepending on the notification type, your app uses either PushKit or the UserNotifications framework to receive the payload."),(0,o.kt)("p",null,"Push notifications is the right solution for your apps when used on networks that have APNs connectivity or the Internet. However, if your app is used in network environments where APNs cannot be reached, the app cannot receive these notifications. For example, places like cruise ships, airlines, camping sites or hospitals may have limited or no APNs connectivity."),(0,o.kt)("p",null,"Local Push Connectivity can be the right solution in scenarios where notifications are essential and network environments have constraints.It is all about direct communication between your provider server and your app extension using your protocol on your specified Wi-Fi networks."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img-70",src:n(34197).Z})),(0,o.kt)("p",null,"APIs:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"NEAppPushManager")," (App)"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"NEAppPushProvider")," (App Extension)")),(0,o.kt)("h2",{id:"network-link-conditioner"},"Network Link Conditioner"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(5152).Z})),(0,o.kt)("h2",{id:"designing-for-adverse-temperature-conditions"},"Designing for Adverse Temperature Conditions"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2019/422/"},"WWDC 2019 - Designing for Adverse Network and Temperature Conditions"))),(0,o.kt)("p",null,"Register for ",(0,o.kt)("inlineCode",{parentName:"p"},"ProcessInfo.thermalStateDidChangeNotification"),", use the ",(0,o.kt)("inlineCode",{parentName:"p"},"ProcessInfo.ThermalState")," cases to react to thermal state changes."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-swift"},"NotificationCenter.default.addObserver(self, selector: #selector(reactToThermalStateChange(_:)),\n                                       name: ProcessInfo.thermalStateDidChangeNotification,\n                                       object: nil\n)\n\n@objc func reactToThermalStateChange(_ notification : Notification) {\n    thermalState = ProcessInfo.processInfo.thermalState\n}\n")),(0,o.kt)("p",null,"New device conditions in Xcode 11 lets to you quickly and easily put your test devices in adverse network or temperature states."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(4713).Z})),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img",src:n(93963).Z})),(0,o.kt)("h2",{id:"utf-8"},"UTF-8"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://developer.apple.com/videos/play/wwdc2016/714/"},"WWDC 2016 - Networking for the Modern Internet"))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Unicode")," is a big list of numbers, and corresponding to each number a human visible character. To use those integers in our computers, we need some way of representing those numbers, in memory, on disk, over the network."),(0,o.kt)("p",null,"One way of representing them is UTF-32, which is just a 32-bit number. You have to be concerned whether it's big endian or little endian. UTF-16 is more compact. It uses 16-bit numbers. But it still has the same problem."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u4ec0\u4e48\u662f\u5b57\u8282\u5e8f\uff1f\u5728\u8ba1\u7b97\u673a\u4e2d\u5355\u5b57\u8282\u53ef\u4ee5\u5b58\u50a8\u7684\u6570\u5b57\u8303\u56f4\u662f 0 - 127\uff0c128 \u6216\u4ee5\u4e0a\u7684\u6570\u5b57\u5fc5\u987b\u6709\u4e24\u4e2a\u6216\u66f4\u591a\u5b57\u8282\u5b58\u50a8\u3002\u4e00\u4e2a\u6570\u5b57\u80af\u5b9a\u662f\u6709\u9ad8\u4f4d\u548c\u4f4e\u4f4d\u7684\uff0c\u4f8b\u5982\u5341\u8fdb\u5236\u6570 13\uff0c1 \u662f\u9ad8\u4f4d\uff0c3 \u662f\u4f4e\u4f4d\u3002\u90a3\u4e48\uff0c\u8ba1\u7b97\u673a\u8fdb\u884c\u6570\u636e\u5b58\u53d6\u662f\u5148\u5904\u7406\u9ad8\u4f4d\u3001\u518d\u5904\u7406\u4f4e\u4f4d\u5462\uff0c\u8fd8\u662f\u5148\u5904\u7406\u4f4e\u4f4d\u3001\u518d\u5904\u7406\u9ad8\u4f4d\uff1f\u4e0d\u540c\u7684\u786c\u4ef6\u67b6\u6784\u53ef\u80fd\u4f7f\u7528\u4e0d\u540c\u7684\u5b57\u8282\u5e8f\u3002\u5148\u5904\u7406\u9ad8\u4f4d\u518d\u5904\u7406\u4f4e\u4f4d\uff0c\u53eb\u505a\u5927\u7aef\u5b57\u8282\u5e8f\uff1b\u5148\u5904\u7406\u4f4e\u4f4d\u518d\u5904\u7406\u9ad8\u4f4d\uff0c\u53eb\u505a\u5c0f\u7aef\u5b57\u8282\u5e8f\u3002")),(0,o.kt)("p",null,"UTF-8 is an 8-bit byte-oriented encoding. Because of that, there are no byte order issues, and this is really what makes it the ideal encoding to use. ",(0,o.kt)("strong",{parentName:"p"},"And when I first heard about that, I immediately saw, this is the answer. This solves the problem for international text.")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img-90",src:n(19203).Z})),(0,o.kt)("p",null,"You can jump into the middle of a UTF-8 file anywhere, and by just looking at any byte, you can tell what you've got. So it's very, very robust to insertion and deletion errors. It's an encoding that is efficient enough to be compact but has just enough redundancy to be very reliable."),(0,o.kt)("p",null,"So, we recommend only use UTF-8, for everything!"))}d.isMDXComponent=!0},58560:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NTk5NDM0Y2JhOGZiOTNlNmNlYjkwYzk4NDQ1MzVlNzY5MzU5YjhmYTI4MDQ4NDc4NTY5MjZiM2EzMWFkZGEyNgpzaXplIDMzNDk3Cg=="},41159:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6Njc4YmM3MGZhYzRkMmNlYmQ0NDQ1YmY1MTI1YjYzYzMyNDhlNmI5ZDlhYTY5NWFkOTg5MzAwZjQ0M2YwMGZlNQpzaXplIDgzMzMwCg=="},96187:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6MDk2MzM3NmExZmU4NTc1NjNkZmZkMzFlOWQ3NGEzZTBhNjlmOTJlNjVhNmMzYzQ1OTQ2YTkwY2NmNTE1MWUzOApzaXplIDMxODI1Cg=="},92011:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6ZTRiOWZjZGI0MTcxOGNjNjVjMGVhZWE5MjY0NzFkMTM1YWJhNzVlNzRkZDFiZmM5OTFiNzMzYzNiOWU1YzFjZQpzaXplIDk0OTIwCg=="},37663:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6YmI2N2FiYzg4Zjc2MzUzNmE1M2Q2ZmIzYzg5YzgxNGJjM2U0NTE0MTY3MGNhOTY4YjM0OTM4NmZiYzdiNTllZgpzaXplIDExOTE5OAo="},3708:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NTNhMDBiN2FhYmM3Mjg5MTgzZTNhYTA2OTg5YjYzMzUwNTBhNWVlMDAyN2RjMDg2ZDQ1OTBkYTI0Zjk1MDJhNwpzaXplIDY0NTcxCg=="},8605:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6M2MyYzRkOGM2NGNkM2JlODYyMzNhNGFhYjU3ZTUzNjYyZjM4N2QzMzRlYTRhY2NlNGE4MTNmZWYxY2EzZDY4YgpzaXplIDk3MzY5Cg=="},34197:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NmNiZDI1YzlhZDIxMjhhZDkzODQ0OWY3YmM0NThkZmM2OGI4ODU0Y2M1YTg2OWIwNDA3MTI2NDE5NjcyYTg1MgpzaXplIDQ1OTE3Cg=="},28631:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6MDIwZGQ3YjlhN2JiMzkyMzk5M2ZkMzgzZDhiNTEyNjNjYjUwZjM3MGU2YjM3NjE2MTI0MDUxYmY5MzE4MDdlYwpzaXplIDEyNDUwNQo="},17940:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6ODA0OTJlYWM4OGFkYTJkMDY5NThmYWI0Yjg2NDgxYzNkZjUwYTI0OTA5YWJjODJiMmZkOGJjMGI2OTdkMWRjYgpzaXplIDMzOTAzCg=="},5152:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6N2U5ODNkYTlkMjEyNTRmNTQ3YmI4Nzg1ODI4NWM1MTY3ZjIzN2U3N2U1MjFlY2Y2NzY1ZTU2ZDQyZGZkMzBlNQpzaXplIDM1NzU4MQo="},43458:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NTBhZTU0ODI4MWQ4YzIxZjlkMTZhZjZhYzEzMDE1ZmE1MThlMmIwNDcxMDVjNzZkYmVkYTMwY2Q2ZDNjZDk4YwpzaXplIDMyODU1Cg=="},50479:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6Yjk5NjdjYjA0YjA1MjhmMmY3MGYzODA5ZGUzNTAxNWI1ODM1MmZiYzk2MmQ5ODExZTUxZGYzYTQ1NWM4NDBlNQpzaXplIDQyOTM5Cg=="},46150:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6ZGE5MzRhN2QwNjU5MWE0NmNiOWM5YWNjZDg5ZWE1MmUyZjMzNmJlODA2NDg0NTAwMjI4NGZmZGQ3OGE4MTIzOApzaXplIDg1NDg2Cg=="},4713:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NDVmZjYwYzBjZDhmOTdjMWY5ZGUzMzI3NjA2OTM5Nzg3Y2MxMjlhZTYyMmJjYzFlMTRmMzZiMDJmYTE1YzZiZApzaXplIDc4Nzk5Cg=="},1607:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NzFjZmY3OGRiNjdjZGZkODMxYmFlMGJjMDI2Nzc1ODU0ZjEzZjExMmYzMzBjZjZiZGFmM2FjMTc3ODAxM2YzZQpzaXplIDI4ODM5OAo="},8397:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6YjQ1ODU2YmI0Yjc1ZWU2YzExYWRmMTY5YTRiOGNmMTc0YWEyMzcyYWM3MmJiZjk0YzdhODM1ZDk0NGI0OTgzNgpzaXplIDc1MjExCg=="},78221:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NzAyOWI5OTRiZjkxNDNjZGVjZjI3YWJmZjMzODJhMzRmM2ZlOTQxNDE0OGI4MDU5MmE4NjJhNDVjYTU2NzEyZApzaXplIDg5NjQzCg=="},19203:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NzIxNmQ1ODFiODUzOWFhY2FjY2RlOTNkNTlkYjgyYjc3M2YzZGFkZWUzZWY0Nzk1ODM0OTkxMGZmMWM5YmExNwpzaXplIDEwMTY1Mwo="},78551:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6YjNkMjNmZjRmZTYzNjQxYTJmNmQ1ZjgwMWUwZjZlODY2YzY5MjIyYTRlNjhmNmI0NGYxZGQwMmJkN2Q1MWQ5NApzaXplIDQ5Mjg4Cg=="},57789:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6N2ZkN2NlNTA2ZTk5ZjVkZTEzOWEyZTFkNGVmMjJlYmQxZjcxY2ZlNzkxYWIyMjMwZDVkN2M0MmMxOTlmODlmNgpzaXplIDg4MDQyCg=="},86510:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6MzE5YjM4MDc2N2VkZTMyMzk0MGFlNzNkMjA5NTY0YmMwNzgxZjM2MjYwZDY5MGYyNjdmODM1YTc1ZGNjYjFmMgpzaXplIDMzNjQzMgo="},93963:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NDdlNWM1ODcxODA3ZjdhNDU1YTRkZGM1Njk5ODdkMzYwYjAxMTliZDQ0NGFhOWY5ZjYyZjlhZjQwZWZkY2VjZQpzaXplIDE4MjEyNgo="},3474:(e,t,n)=>{n.d(t,{Z:()=>a});const a="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6ZmVlOWJmNzIzM2ViZWU0MjY3M2Y1ZDEyYzQ0MTQzNTA2ZTk3ZDM5YmIzNWFhMWViMmY1YmIxMmQyMGI1ODQ4NQpzaXplIDMzMzUyMwo="}}]);