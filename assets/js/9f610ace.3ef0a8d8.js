"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5352],{94513:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var n=a(87462),i=(a(67294),a(3905));a(61839);const r={},o="System Frameworks",s={unversionedId:"Effective Objective-C/effective-oc-7",id:"Effective Objective-C/effective-oc-7",title:"System Frameworks",description:"47. System Frameworks",source:"@site/docs/language/Effective Objective-C/effective-oc-7.md",sourceDirName:"Effective Objective-C",slug:"/Effective Objective-C/effective-oc-7",permalink:"/docs/language/Effective Objective-C/effective-oc-7",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Block and GCD",permalink:"/docs/language/Effective Objective-C/effective-oc-6"},next:{title:"JavaScript",permalink:"/docs/language/JavaScript"}},l={},c=[{value:"47. System Frameworks",id:"47-system-frameworks",level:2},{value:"48: Prefer Block Enumeration to for Loops",id:"48-prefer-block-enumeration-to-for-loops",level:2},{value:"49: Use Toll-Free Bridging for Collections with Custom Memory-Management Semantics",id:"49-use-toll-free-bridging-for-collections-with-custom-memory-management-semantics",level:2},{value:"50: Use NSCache Instead of NSDictionary for Caches",id:"50-use-nscache-instead-of-nsdictionary-for-caches",level:2},{value:"51: Keep load and initialize Implementations Lean",id:"51-keep-load-and-initialize-implementations-lean",level:2},{value:"52: Remember that NSTimer Retains Its Target",id:"52-remember-that-nstimer-retains-its-target",level:2}],d={toc:c};function m(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"system-frameworks"},"System Frameworks"),(0,i.kt)("h2",{id:"47-system-frameworks"},"47. System Frameworks"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"NS \u524d\u7f00\u7684\u662f ",(0,i.kt)("inlineCode",{parentName:"li"},"Foundation")," \u6846\u67b6\u3002"),(0,i.kt)("li",{parentName:"ul"},"UI \u524d\u7f00\u7684\u662f ",(0,i.kt)("inlineCode",{parentName:"li"},"UIKit")," \u6846\u67b6\u3002"),(0,i.kt)("li",{parentName:"ul"},"CF \u524d\u7f00\u7684\u662f ",(0,i.kt)("inlineCode",{parentName:"li"},"CoreFoundation")," \u6846\u67b6\u3002")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"CoreFoundation")," is another important framework, a C API that mirrors much of the functionality of the ",(0,i.kt)("inlineCode",{parentName:"p"},"Foundation")," framework. A feature known as ",(0,i.kt)("strong",{parentName:"p"},"toll-free bridging")," allows seamless casting from the C data structures of ",(0,i.kt)("inlineCode",{parentName:"p"},"CoreFoundation")," to the Objective-C objects of Foundation, and vice versa."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Framework"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"CFNetwork"),(0,i.kt)("td",{parentName:"tr",align:null},"provides C-level networking facilities for talking to networks")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"CoreAudio"),(0,i.kt)("td",{parentName:"tr",align:null},"provides a C-level API for interfacing with audio hardware on a device")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"AVFoundation"),(0,i.kt)("td",{parentName:"tr",align:null},"provides Objective-C objects for dealing with audio and video playback and recording")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"CoreData"),(0,i.kt)("td",{parentName:"tr",align:null},"provides Objective-C interfaces for persisting objects to a database")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"CoreText"),(0,i.kt)("td",{parentName:"tr",align:null},"provides a C interface for high-performance text typesetting and rendering")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"CoreAnimation"),(0,i.kt)("td",{parentName:"tr",align:null},"written in Objective-C and provides the tools that the UI frameworks use to render graphics and perform animations.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Core Graphics"),(0,i.kt)("td",{parentName:"tr",align:null},"written in C and provides data structures and functions that are essential for 2D rendering. e.g ",(0,i.kt)("inlineCode",{parentName:"td"},"CGRect"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"CGSize"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"CGPoint"),".")))),(0,i.kt)("p",null,"Often, you will need to drop down to use C-level APIs. APIs written in C benefit from the speed improvement of bypassing the Objective-C runtime. Of course, more care needs\nto be taken with memory management in those APIs, since ARC is available only to Objective-C objects."),(0,i.kt)("h2",{id:"48-prefer-block-enumeration-to-for-loops"},"48: Prefer Block Enumeration to for Loops"),(0,i.kt)("h2",{id:"49-use-toll-free-bridging-for-collections-with-custom-memory-management-semantics"},"49: Use Toll-Free Bridging for Collections with Custom Memory-Management Semantics"),(0,i.kt)("p",null,"Toll-free bridging allows you to cast between Objective-C classes defined in Foundation and C data structures defined in CoreFoundation and vice versa."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-objc"},'NSArray *anNSArray = @[@1, @2, @3, @4, @5];\nCFArrayRef aCFArray = (__bridge CFArrayRef)anNSArray;\nNSLog(@"Size of array = %li", CFArrayGetCount(aCFArray));\n')),(0,i.kt)("p",null,"CFArray is referenced by a CFArrayRef, which is a pointer to a struct ","_","_","CFArray. This struct is manipulated by using such functions as CFArrayGetCount to obtain the size of the array. This is distinct from its Objective-C counterpart, where you create an NSArray object and call methods, such as count, on that object to obtain the size of the array. \uff08\u51fd\u6570\u5f0f\u7f16\u7a0b\u4e0e\u9762\u5411\u5bf9\u8c61\u65b9\u6cd5\u7684\u533a\u522b\uff09"),(0,i.kt)("p",null,"For example, NSMutableDictionary copies its keys and retains its values by default. What if the objects you want to use as keys cannot be copied? It will result in a runtime error like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Terminating app due to uncaught exception 'NSInvalidArgumentException',\nreason: '-[EOCClass copyWithZone:]: unrecognized selector sent to instance 0x7fd069c080b0'\n")),(0,i.kt)("p",null,"By dropping down to the CoreFoundation level and creating the dictionary there, you can alter the memory-management semantics and create a dictionary that retains rather than copies the keys. Casting this through toll-free bridging allows you to end up with an Objective-C collection that has custom memory-management semantics."),(0,i.kt)("h2",{id:"50-use-nscache-instead-of-nsdictionary-for-caches"},"50: Use NSCache Instead of NSDictionary for Caches"),(0,i.kt)("p",null,"\u5f53\u9047\u5230\u7f13\u5b58\u56fe\u7247\u8fd9\u6837\u7684\u9700\u6c42\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 NSDictionary \u6765\u8fbe\u5230\u76ee\u7684\uff0c\u4f46 NSCache \u662f\u66f4\u597d\u7684\u9009\u62e9\u3002"),(0,i.kt)("p",null,"\u4e00\u3001\u81ea\u52a8\u6e05\u7406\u5185\u5b58\uff0c\u4e14\u91c7\u7528 LRU \u7b56\u7565\u3002The benefit of NSCache over an NSDictionary is that as system memory becomes full, the cache is automatically pruned. An NSCache will also prune the least recently used objects first."),(0,i.kt)("p",null,"\u4e8c\u3001\u6301\u6709 key \u800c\u4e0d\u662f\u62f7\u8d1d\u5b83\u3002Also, an NSCache does not copy keys but rather retains them because often, the key will be an object that does not support copying."),(0,i.kt)("p",null,"\u4e09\u3001\u7ebf\u7a0b\u5b89\u5168\u3002NSCache is thread safe. This is usually useful for a cache because you may want to read from it in one thread, and, if a certain key doesn\u2019t exist, you may download the data for that key. The callbacks for downloading may be in a background thread, so you end up adding to the cache in this other thread."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-objc"},"#import <Foundation/Foundation.h>\n\n// Network fetcher class\ntypedef void(^EOCNetworkFetcherCompletionHandler)(NSData *data);\n\n@interface EOCNetworkFetcher : NSObject\n- (id)initWithURL:(NSURL*)url;\n- (void)startWithCompletionHandler:(EOCNetworkFetcherCompletionHandler)handler;\n@end\n\n// Class that uses the network fetcher and caches results\n@interface EOCClass : NSObject\n@end\n\n@implementation EOCClass {\n    NSCache *_cache;\n}\n\n- (id)init {\n    if (self = [super init]) {\n        _cache = [NSCache new];\n        // Cache a maximum of 100 URLs\n        _cache.countLimit = 100;\n        // The size in bytes of data is used as the cost, * so this sets a cost limit of 5MB.\n        _cache.totalCostLimit = 5 * 1024 * 1024;\n    }\n    return self;\n}\n\n- (void)downloadDataForURL:(NSURL*)url {\n    NSData *cachedData = [_cache objectForKey:url];\n    if (cachedData) {\n        // Cache hit\n        [self useData:cachedData];\n    } else {\n        // Cache miss\n        EOCNetworkFetcher *fetcher =\n        [[EOCNetworkFetcher alloc] initWithURL:url];\n        [fetcher startWithCompletionHandler:^(NSData *data){\n            [_cache setObject:data forKey:url cost:data.length];\n            [self useData:data];\n        }];\n    }\n}\n@end\n")),(0,i.kt)("h2",{id:"51-keep-load-and-initialize-implementations-lean"},"51: Keep load and initialize Implementations Lean"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"+ (void)load"),": is called once and only once for ",(0,i.kt)("strong",{parentName:"p"},"every class and category")," that is added to the runtime."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"+ (void)initialize"),": is called on every class, once and only once, before the class is used."),(0,i.kt)("p",null,"An important thing to note is that ",(0,i.kt)("inlineCode",{parentName:"p"},"load")," does not follow the normal inheritance rules for methods. A class that does not implement ",(0,i.kt)("inlineCode",{parentName:"p"},"load")," is not called, regardless of whether any of its superclasses do. Also, ",(0,i.kt)("inlineCode",{parentName:"p"},"load")," can appear in a category and the class itself. Both implementations will be called, with the class\u2019s coming before the category\u2019s."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"initialize")," is sent just like any other message; if a class doesn\u2019t implement it but its superclass does, that implementation will be run."),(0,i.kt)("h2",{id:"52-remember-that-nstimer-retains-its-target"},"52: Remember that NSTimer Retains Its Target"))}m.isMDXComponent=!0}}]);