<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-frameworks">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Frameworks | yianzhou</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://yianzhou.github.io/docs/apple/frameworks"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Frameworks | yianzhou"><meta data-rh="true" name="description" content="静态库与动态库"><meta data-rh="true" property="og:description" content="静态库与动态库"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yianzhou.github.io/docs/apple/frameworks"><link data-rh="true" rel="alternate" href="https://yianzhou.github.io/docs/apple/frameworks" hreflang="en"><link data-rh="true" rel="alternate" href="https://yianzhou.github.io/docs/apple/frameworks" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6a91212d.css">
<link rel="preload" href="/assets/js/runtime~main.bdd1e9a6.js" as="script">
<link rel="preload" href="/assets/js/main.22616d99.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="yianzhou" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="yianzhou" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">yianzhou</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/apple">Apple</a><a class="navbar__item navbar__link" href="/docs/dev">开发</a><a class="navbar__item navbar__link" href="/docs/language">编程语言</a><a class="navbar__item navbar__link" href="/docs/flutter">Flutter</a><a class="navbar__item navbar__link" href="/docs/insights">Insights</a><a class="navbar__item navbar__link" href="/docs/codes">Codes</a><a class="navbar__item navbar__link" href="/docs/ai">AI</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yianzhou/yianzhou.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/SDWebImage">SDWebImage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/UIKit">UIKit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/afnetworking">AFNetworking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/app-extension">App Extension</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/app-in-the-background">App in the Background</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/app-size">包体大小优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/app-startup">App Startup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/apple-bugs">Apple Bugs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/aspects">Aspects</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/audio-video">音视频基础知识</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/avfoundation">AVFoundation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/cicd">CICD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/cocoapods">Cocoapods</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/core-animation">Core Animation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/crash">崩溃</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple">Debug</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/apple/frameworks">Frameworks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/graphics">图形渲染</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/hls">HTTP Live Streaming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/http">HTTP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/instruments">Instruments</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/lag">卡顿</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/live-streaming">直播</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/llvm">LLVM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/mach-o">Mach-O</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/matrix">Matrix</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/memory">内存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/metal">Metal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/multithread">多线程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/networking">Apple Networking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/performance">性能优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/semaphore">信号量</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/symbolic">符号化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/uiscene">UIScene</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/unified-logging">Unified Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/uniform-type-identifiers">Uniform Type Identifiers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/user-notification">User Notification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/webkit">WebKit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/wwdc">WWDC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/wwdc23">WWDC23</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/xcassets">XCAssets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/xcode">Xcode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/xctest">XCTest</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/项目配置">项目配置</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Frameworks</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Frameworks</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="静态库与动态库">静态库与动态库<a href="#静态库与动态库" class="hash-link" aria-label="Direct link to 静态库与动态库" title="Direct link to 静态库与动态库">​</a></h2><p><a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/OverviewOfDynamicLibraries.html#//apple_ref/doc/uid/TP40001873-SW1" target="_blank" rel="noopener noreferrer">Dynamic Library Programming Topics</a></p><p>When an app is linked with a library using a static linker, the code that the app uses is copied to the generated executable file. A static linker collects compiled source code, known as object code, and library code into one executable file that is loaded into memory in its entirety at runtime. The kind of library that becomes part of an app’s executable file is known as a static library. Static libraries are collections or archives of object files.</p><p>A better approach is for an app to load code into its address space when it’s actually needed, either at launch time or at runtime. The type of library that provides this flexibility is called <strong>dynamic library</strong>. Dynamic libraries are not statically linked into client apps; they don&#x27;t become part of the executable file.</p><p>When an app is launched, the OS X kernel loads the app’s code and data into the address space of a new process. The kernel also loads the dynamic loader (<code>/usr/lib/dyld</code>) into the process and passes control to it. The dynamic loader then loads the app’s dependent libraries. These are the dynamic libraries the app was linked with. The static linker records the filenames of each of the dependent libraries at the time the app is linked. This filename is known as the dynamic library’s <strong>install name</strong>. The dynamic loader uses the app’s dependent libraries’ install names to locate them in the file system.</p><p>The dynamic loader—in addition to automatically loading dynamic libraries at launch time—loads dynamic libraries at runtime, at the app’s request. That is, if an app doesn&#x27;t require that a dynamic library be loaded when it launches, developers can choose to not link the app’s object files with the dynamic library, and, instead, load the dynamic library only in the parts of the app that require it. Using dynamic libraries this way speeds up the launch process. Dynamic libraries loaded at runtime are known as dynamically loaded libraries. To load libraries at runtime, apps can use functions that interact with the dynamic loader for the platform under which they&#x27;re running.</p><p>查看一个库是动态库还是静态库可以用如下方法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">file</span><span class="token plain"> opencv2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">opencv2: Mach-O universal binary with </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> architectures: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x86_64:current ar archive</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">arm64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">opencv2 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">for architecture x86_64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:  current ar archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">opencv2 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">for architecture arm64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:   current ar archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> Flutter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flutter: Mach-O universal binary with </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> architectures: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">arm_v7:Mach-O dynamically linked shared library arm_v7</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">arm64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flutter </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">for architecture armv7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:   Mach-O dynamically linked shared library arm_v7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flutter </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">for architecture arm64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:   Mach-O </span><span class="token number" style="color:#36acaa">64</span><span class="token plain">-bit dynamically linked shared library arm64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>动态库会显示 &quot;dynamically linked shared library&quot;</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="framework">Framework<a href="#framework" class="hash-link" aria-label="Direct link to Framework" title="Direct link to Framework">​</a></h2><p>In iOS, Apple is using <strong>Framework</strong> to package the header files, source files, binary files and resources. Similarly, Framework can be divides into <strong>Static Framework</strong> and <strong>Dynamic Framework</strong>.</p><p>Framework 是一种打包方式。将库的二进制、头文件、资源文件打包到一起，方便管理。相当于 Android 的 AAR (Android ARchive)。</p><p>开发者制作的 Framework 和系统的 UIKit.framework 有什么区别？系统的 Framework 不需要拷贝到应用程序中，是运行时加载的，在不同应用程序之间共享。开发者制作的 Framework，最后是会被拷贝到应用程序中，苹果把这种 Framework 又称为 Embedded Framework。</p><p>开发者制作的 Framework 会被放到 ipa 的 Frameworks 目录下，被严格限制在沙盒中运行。App 打包时会对动态库进行签名，不同的 App，即使使用的是完全相同的动态库，在系统中也会加载多份。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tdb">tdb<a href="#tdb" class="hash-link" aria-label="Direct link to tdb" title="Direct link to tdb">​</a></h2><p><a href="https://opensource.apple.com/source/tapi/tapi-1100.0.11/docs/TBD.rst.auto.html" target="_blank" rel="noopener noreferrer">https://opensource.apple.com/source/tapi/tapi-1100.0.11/docs/TBD.rst.auto.html</a></p><p>Text-based Dynamic Library Stubs (.tbd) are a new representation for dynamic libraries and frameworks in Apple&#x27;s SDKs.</p><p>The new dynamic library stub file format is a <strong>human readable and editable YAML text file</strong>. Those text-based stub files <strong>contain the same exported symbols</strong> as the original dynamic library.</p><p>我们在项目中引入的系统库，都是 tbd 的格式。因为真正的动态库放在手机设备上，Xcode 在链接时只需要描述信息就可以了。</p><p>tbd 里面记录了包括动态库导出的符号、架构、依赖等信息。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="afnetworking-静态库">AFNetworking 静态库<a href="#afnetworking-静态库" class="hash-link" aria-label="Direct link to AFNetworking 静态库" title="Direct link to AFNetworking 静态库">​</a></h2><p>首先找到 AFNetworking 的源码，也就是 <a href="https://github.com/AFNetworking/AFNetworking/tree/master/AFNetworking" target="_blank" rel="noopener noreferrer">https://github.com/AFNetworking/AFNetworking/tree/master/AFNetworking</a> 这个目录下的所有文件。</p><p>新建一个 Xcode Project，平台选择为 macOS（因为后面我们会直接运行程序），模板选择静态库，然后把源码拖进去。构建，然后在 DerivedData 里找到产物，得到 libAFNetworking.a</p><p><code>ar -t libAFNetworking.a</code> 列出静态库里面所有的目标文件。静态库就是 <code>.o</code> 文件的集合，既然它是目标文件的集合，它可以被进一步地链接，从而生成动态库。</p><p>手动创建一个 <code>main.m</code> 文件，并在其中引用 <code>AFNetworking</code>：</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">import</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression" style="color:#36acaa">Foundation</span><span class="token macro property expression operator" style="color:#393A34">/</span><span class="token macro property expression" style="color:#36acaa">Foundation</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">h</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">import</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression" style="color:#36acaa">AFNetworking</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">h</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AFHTTPSessionManager </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">manager </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">AFHTTPSessionManager manager</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%@&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> manager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来把它编译成目标文件：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 编译</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -I: HEADER_SEARCH_PATHS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clang </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-fobjc-arc </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-target arm64-apple-macos </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-mmacos-version-min</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">12.3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-IAFNetworking </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-c main.m -o main.o</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在编译目标文件时，我们不需要 <code>AFHTTPSessionManager</code> 的源码，也不需要 AFNetworking 库，只需要在 HEADER_SEARCH_PATHS 里能找到 AFNetworking.h 头文件就可以了（头文件里有<code>AFHTTPSessionManager</code>符号），这个符号会被放入目标文件的重定位符号表，在之后链接的过程中，会确定符号的地址。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 将目标文件与静态库进行链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -L: library_search_path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -l: 要链接的库的名称，找的时候会自动加 lib 前缀</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clang </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-fobjc-arc </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-target arm64-apple-macos </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-mmacos-version-min</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">12.3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-LProducts/Release </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-lAFNetworking </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.o -o main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在可以通过 <code>./main</code> 直接运行这个二进制，看到 <code>NSLog</code> 的输出了。</p><p>如果需要打包 iOS，则：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-target arm64-apple-ios </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-mios-version-min</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">15.0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk </span><span class="token punctuation" style="color:#393A34">\</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>静态库可以手动组织成 Framework，<code>mkdir AFNetworking.framework</code>，将静态库文件重命名为 <code>AFNetworking</code> 后放入，再将头文件放入 <code>Headers</code> 目录下即可。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 将目标文件与 Framework 进行链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -F 即 framework_search_path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -framework 属于 other_linker_flags</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clang </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-fobjc-arc </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-target arm64-apple-macos </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-mmacos-version-min</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">12.3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-F./Frameworks </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-framework AFNetworking </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.o -o main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>总结，编译链接一个 Framework 的三要素：</p><ol><li>Header Search Paths</li><li>Framework Search Paths</li><li>Other Linker Flags - <code>-framework</code></li></ol><p>静态库中没有用到的代码，会被 Dead Code Stripping 脱掉。objc 的 class 默认会载入，但 category 默认是会被脱掉的。此时，可以通过向链接器传递参数，来控制哪些符号会被载入二进制产物中。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">OTHER_LDFLAGS</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-Xlinker -all_load </span><span class="token comment" style="color:#999988;font-style:italic"># 加载所有符号，clang -Xlinker -all_load</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">OTHER_LDFLAGS</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-Xlinker -ObjC </span><span class="token comment" style="color:#999988;font-style:italic"># 加载所有 objc 符号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">OTHER_LDFLAGS</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-Xlinker -force_load </span><span class="token comment" style="color:#999988;font-style:italic"># 加载指定静态库里面的所有符号</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 <code>clang</code> 命令中使用 Dead Code Stripping：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># -why_load: Log why each object file in a static library is loaded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clang </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-fobjc-arc </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-target arm64-apple-macos </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-mmacos-version-min</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">12.3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-LProducts/Release </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-lAFNetworking </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-Xlinker -dead_strip </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-Xlinker -why_load </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.o -o main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="afnetworking-动态库">AFNetworking 动态库<a href="#afnetworking-动态库" class="hash-link" aria-label="Direct link to AFNetworking 动态库" title="Direct link to AFNetworking 动态库">​</a></h2><p>同样地，新建一个 Xcode Project，平台选择为 macOS（因为后面我们会直接运行二进制），模板选择动态库，然后把源码拖进去。</p><p>动态库是运行时加载的，加载的话就会需要一个路径，这个路径就是 install_name。新建的 Xcode 动态库工程，如果不做修改的话，会是这样的：</p><p><img loading="lazy" alt="img" src="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6NzIzYzliZDY4NTQxZmUyYjEzMWNmYTZlZWE1ODhiYjBmODAwNjE3NzVlZDI4NmUyZGJlMzdjNzQ1NWI0YzEwMwpzaXplIDEyNjA2MAo=" class="img_ev3q"></p><p>我们按照苹果 App 的目录结构，修改为以下配置：</p><p><img loading="lazy" alt="img" src="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6OGM4ZTE4NWNmOWVhMDFlNDdiNjI3MWQ3ODM4YTQyZTYyNTNkMGJhMzVhMWU3MjAwMzYwMzVlODYzMjkwZjc4MwpzaXplIDEzMTI5MQo=" class="img_ev3q"></p><p><code>@rpath</code> 代表 Build Settings - Runpath Search Paths，xcconfig 里的 <code>LD_RUNPATH_SEARCH_PATHS</code>，可保存多个路径，dyld 搜索动态库时会在这些路径下搜索。由于我们这个动态库是给 main 用的，当 main 链接这个动态库时，main 就负责展开 <code>@rpath</code>。</p><p>接下来，构建，然后在 DerivedData 里找到产物。</p><p>动态库的路径是记录在 libAFNetworking.dylib 自己的 load command 里的：</p><p><code>otool -l libAFNetworking.dylib | grep &quot;LC_ID_DYLIB&quot; -A 5</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">          cmd LC_ID_DYLIB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cmdsize 72</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         name @rpath/AFNetworking.framework/AFNetworking (offset 24)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   time stamp 1 Thu Jan  1 08:00:01 1970</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      current version 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compatibility version 1.0.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后手动创建一个 <code>main.m</code> 文件，并在其中引用 <code>AFNetworking</code>，接下来把它编译成目标文件，然后链接。</p><p>在 main 去链接 libAFNetworking.dylib 时，main 会把上面的路径又写到了自己的 load command 里：</p><p><code>otool -l main | grep &#x27;LC_LOAD_DYLIB&#x27; -A 5</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">          cmd LC_LOAD_DYLIB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cmdsize 72</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         name @rpath/AFNetworking.framework/AFNetworking (offset 24)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   time stamp 2 Thu Jan  1 08:00:02 1970</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      current version 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compatibility version 1.0.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当 dyld 去加载 main 依赖的动态库时，就会使用上述路径来加载。</p><p>此时运行 main，会出现 Library not loaded 错误，这是由于在链接时我们没有指定 main 的 rpath，加载动态库时无法展开，于是系统只好到兜底的 <code>/Library/Frameworks</code> 和 <code>/System/Library/Frameworks/</code> 目录去找，但是找不到，于是就发生异常：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dyld[55541]: Library not loaded: &#x27;@rpath/AFNetworking.framework/AFNetworking&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Referenced from: &#x27;/Users/yianzhou/Documents/megabox/examples/macOS/AFNetworking-dylib/main&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Reason: tried: &#x27;/Library/Frameworks/AFNetworking.framework/AFNetworking&#x27; (no such file), &#x27;/System/Library/Frameworks/AFNetworking.framework/AFNetworking&#x27; (no such file)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因此，在链接时，还需额外给链接器传入 <code>rpath</code> 参数，就可以正常运行了。（iOS App 都会把动态库放到 <code>@executable_path/Frameworks</code> 目录下，<code>@excutable_path</code> 代表可执行程序所在目录）</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">clang </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-fobjc-arc </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-target arm64-apple-macos </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-mmacos-version-min</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">12.3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-F./Frameworks </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-framework AFNetworking </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-Xlinker -rpath -Xlinker @executable_path/Frameworks </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.o -o main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当动态库链接动态库时，情况会变得更复杂一些。假设 AFNetworking 还依赖了其它动态库，通常放在 <code>AFNetworking.framework/Frameworks</code> 下面。</p><p>那么，当加载 AFNetworking 用到的动态库时，就要在 AFNetworking 的 rpath 里找。而 AFNetworking 不是可执行程序，它是动态库。因此如果把 AFNetworking 的 rpath 配置为 <code>@executable_path/Frameworks</code> 的话，肯定是找不到的。此时苹果提供了另一个参数 <code>@loader_path</code>，表示被加载的 mach-o 所在目录。当 AFNetworking 被加载时，<code>@loader_path</code> 就被展开为 AFNetworking 所在目录，因此我们将 AFNetworking 的 rpath 配置为 <code>@loader_path/Frameworks</code>，就可以确保动态库依赖动态库的情况也可以找到正确的路径了。</p><p>咱们平时通过 Cocoapods 管理工程配置时，它也是这么给我们配置的：</p><p><img loading="lazy" alt="img" src="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6ZWNmNmFjNGFhMWVlZDgxZDYwZmIyOWNkY2VkYWQ5ZTYyZjJiNGExODI0MThjNDdkNjAyOWQwOWJjMWExMGE0YwpzaXplIDIwNzU4MAo=" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四种链接情况">四种链接情况<a href="#四种链接情况" class="hash-link" aria-label="Direct link to 四种链接情况" title="Direct link to 四种链接情况">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-动态库链接动态库">1. 动态库链接动态库<a href="#1-动态库链接动态库" class="hash-link" aria-label="Direct link to 1. 动态库链接动态库" title="Direct link to 1. 动态库链接动态库">​</a></h3><p>App -&gt; 动态库 A -&gt; 动态库 B，要在 App 内使用动态库 B 的代码：</p><ol><li><code>Demo/Pods/Target Support Files/Pods-Demo/Pods-Demo-frameworks.sh</code> 这个路径下的脚本，已经帮忙把动态库 B 拷贝到 App 沙盒的 Frameworks 目录下，并且写好配置了 <code>Demo/Pods/Target Support Files/Pods-Demo/Pods-Demo-frameworks.sh</code>。</li><li>App 通过 pod 安装动态库 B：<code>pod &#x27;B&#x27;</code></li></ol><p>动态库 A 可以反向使用 App 的代码吗？——可以的，第一，在运行时，App 的符号肯定是载入内存中可以被使用的；第二，动态库编译的时候不需要实现，只需要配置 <code>HEADER_SEARCH_PATHS</code> 能找到头文件即可；第三，在动态库链接的时候，App 的符号会报错找不到，此时可以传链接器参数，告诉链接器允许某些符号未定义：</p><p><code>OTHER_LDFLAGS = $(inherited) -Xlinker -U -Xlinker _OBJC_CLASS_$_AppObject</code></p><p>这样就可以顺利通过链接，并且在运行时，也可以使用到 <code>AppObject</code>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-动态库链接静态库">2. 动态库链接静态库<a href="#2-动态库链接静态库" class="hash-link" aria-label="Direct link to 2. 动态库链接静态库" title="Direct link to 2. 动态库链接静态库">​</a></h3><p>App -&gt; 动态库 A -&gt; 静态库 B，动态库 A 的链接阶段就会把静态库 B 的符号都载入进来，因此，静态库 B 的导出符号也就成为动态库 A 的导出符号，对 App 自然也是可见的，App 使用静态库 B 没有问题。</p><p>如果不想把静态库 B 的符号暴露给 App，可以传链接器参数，告诉链接器隐藏静态库 B 的符号：</p><p><code>OTHER_LDFLAGS = $(inherited) -Xlinker -hidden-l&quot;B&quot;</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-静态库链接静态库">3. 静态库链接静态库<a href="#3-静态库链接静态库" class="hash-link" aria-label="Direct link to 3. 静态库链接静态库" title="Direct link to 3. 静态库链接静态库">​</a></h3><p>App -&gt; 静态库 A -&gt; 静态库 B，需要配置 <code>HEADER_SEARCH_PATHS</code> 和 <code>OTHER_LDFLAGS</code> 让静态库 B 对 App 可见。</p><p>或者直接使用 pod 把静态库 B 装给 App。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-静态库链接动态库">4. 静态库链接动态库<a href="#4-静态库链接动态库" class="hash-link" aria-label="Direct link to 4. 静态库链接动态库" title="Direct link to 4. 静态库链接动态库">​</a></h3><p>App -&gt; 静态库 A -&gt; 动态库 B，配置 <code>FRAMEWORK_SEARCH_PATHS</code> 让动态库 B 对 App 可见，同时参考 1 中的做法，通过脚本拷贝 Framework 或者通过 pod 安装。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cocoapods-集成">Cocoapods 集成<a href="#cocoapods-集成" class="hash-link" aria-label="Direct link to Cocoapods 集成" title="Direct link to Cocoapods 集成">​</a></h2><div class="language-ruby codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ruby codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">target &quot;Runner&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 加上这句就是把下面的pod都用动态库，去掉这句就是都用静态库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  use_frameworks!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 部分使用动态库，其余静态库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dylib_set = Set.new [&quot;bugly&quot;, &quot;sqflite&quot;, &quot;pdf_engine&quot;, &quot;FMDB&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">post_install do |installer|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  installer.pods_project.targets.each do |target|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unless dylib_set.include?(target.name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      target.build_configurations.each do |config|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config.build_settings[&quot;MACH_O_TYPE&quot;] = &quot;staticlib&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="modules">Modules<a href="#modules" class="hash-link" aria-label="Direct link to Modules" title="Direct link to Modules">​</a></h2><p>头文件也要编译，尤其对于 C++ 来说，头文件几乎包含了所有语法特性。</p><p><a href="https://clang.llvm.org/docs/Modules.html" target="_blank" rel="noopener noreferrer">https://clang.llvm.org/docs/Modules.html</a></p><p>Most software is built using a number of software libraries. For each library, one needs to access both its interface (API) and its implementation.</p><p>In the C family of languages, the interface to a library is accessed by including the appropriate header files(s):</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;SomeLib.h&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（用 <code>include</code> 的坏处）The <code>#include</code> mechanism provided by the C preprocessor is a very poor way to access the API of a library, for a number of reasons:</p><ul><li>In a project with N translation units and M headers included in each translation unit, the compiler is performing M x N work even though most of the M headers are shared among multiple translation units.（头文件被重复编译多次）</li><li>When the headers for two different libraries interact due to macro collisions, users are forced to reorder <code>#include</code> directives or introduce <code>#undef</code> directives to break the (unintended) dependency.（宏定义冲突）</li><li>C programmers have adopted a number of conventions to work around the fragility of the C preprocessor model.（用全大写、加下划线等惯用法来避免命名冲突，使代码变得又长又臭）</li><li>The boundaries of the libraries are not clear. Which headers belong to a particular library, and in what order should those headers be included to guarantee that they compile correctly?（说不清楚边界到底在哪）</li></ul><p>（用 Modules 的好处）When the compiler sees the module import <code>@import std.io;</code>, it loads a <strong>binary</strong> representation of the std.io module. Preprocessor definitions that precede the import declaration have no impact on the API provided by std.io, because the module itself was compiled as a separate, standalone module.（每个头文件只会编译一次）</p><p>clang 编译器会自动把 <code>#include &lt;stdio.h&gt;</code> 指令翻译成 <code>@import std.io;</code>。</p><p>The crucial link between modules and headers is described by a <strong>module map</strong>, which describes how a collection of existing headers maps on to the (logical) structure of a module. Having a list of the headers that are part of the <code>std</code> module allows the compiler to build the <code>std</code> module as a standalone entity, and having the mapping from header names to (sub)modules allows the automatic translation of <code>#include</code> directives to module imports.</p><p>The binary representation of modules is persisted in the module cache. Modules maintain references to each of the headers that were part of the module build. If any of those headers changes, or if any of the modules on which a module depends change, then the module will be (automatically) recompiled. The process should never require any user intervention.</p><p>To enable support for using a library as a module, one must write a <code>module.modulemap</code> file for that library. The <code>module.modulemap</code> file is placed alongside the header files themselves.</p><p>先写好 <code>module.modulemap</code> 再编译，才能产生 module cache：<code>clang -fmodules -fmodules-cache-path=prebuilt use.c</code></p><p>查看参数含义：<code>clang --help | grep &quot;\-fmodules&quot; -A 5</code></p><p>参考开源库的 <code>module.modulemap</code> 文件：</p><p><img loading="lazy" alt="img" src="data:image/png;base64,dmVyc2lvbiBodHRwczovL2dpdC1sZnMuZ2l0aHViLmNvbS9zcGVjL3YxCm9pZCBzaGEyNTY6MjhmMzRlYWE1ZDA3ZTMwNjVhYWMzZmViYzg3NDcyYzM0NWJjZjZmMDg3NTE5Njc1NTQxMTcxN2U1NzQ1YzVlNQpzaXplIDE5NDYyOAo=" class="img_ev3q"></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">framework module SDWebImage {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  umbrella header &quot;SDWebImage-umbrella.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  export *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  module * { export * }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>export *</code>: anything included by that submodule will be automatically re-exported</p><p><code>module *</code>: module 里的所有头文件都当作一个子 module</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="swift-library">Swift Library<a href="#swift-library" class="hash-link" aria-label="Direct link to Swift Library" title="Direct link to Swift Library">​</a></h2><p>App 里 Swift 调用 OC 代码，是用 <code>-Bridge-Header.h</code> 桥接文件。但在 Swift 库中无法使用桥接文件，怎么办？可以把 OC 的头文件放到 modulemap 下，即可暴露给 Swift 调用。</p><p>Swift 静态库 A 与 Swift 静态库 B 合并：</p><ul><li>libtool 合并静态库 A、B</li><li>swift 头文件和 modulemap 文件放到一起</li><li>OC 要调用合并后的静态库：<code>OTHER_CFLAGS=&quot;-fmodule-map-file=${SRCROOT}/AGSwiftA.framework/module.modulemap&quot; &quot;-fmodule-map-file=${SRCROOT}/AGSwiftB.framework/module.modulemap&quot;</code></li><li>Swift 要调用合并后的静态库：<code>SWIFT_INCLUDE_PATHS=&quot;${SRCROOT}/AGSwiftC/AGSwiftA.framework&quot; &quot;${SRCROOT}/AGSwiftC/AGSwiftB.framework&quot;</code></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="裁剪">裁剪<a href="#裁剪" class="hash-link" aria-label="Direct link to 裁剪" title="Direct link to 裁剪">​</a></h2><p>查看支持的架构：<code>lipo -info opencv2.framework</code></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 先瘦身，输出单一架构</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ lipo opencv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">framework</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">opencv2 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">thin arm64 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">output opencv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">framework</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">opencv2</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">arm64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ lipo opencv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">framework</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">opencv2 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">thin x86_64 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">output opencv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">framework</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">opencv2</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">x86_64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 再合并</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ lipo </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">create opencv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">framework</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">opencv2</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">arm64 opencv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">framework</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">opencv2</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">x86_64 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">output opencv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">framework</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">opencv2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="查看库里的符号">查看库里的符号<a href="#查看库里的符号" class="hash-link" aria-label="Direct link to 查看库里的符号" title="Direct link to 查看库里的符号">​</a></h2><p><code>otool -tv ./ZWAppApi.framework/ZWAppApi | grep &quot;NSString&quot;</code></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/yianzhou/yianzhou.github.io/docs/apple/frameworks.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/apple"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Debug</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/apple/graphics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">图形渲染</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#静态库与动态库" class="table-of-contents__link toc-highlight">静态库与动态库</a></li><li><a href="#framework" class="table-of-contents__link toc-highlight">Framework</a></li><li><a href="#tdb" class="table-of-contents__link toc-highlight">tdb</a></li><li><a href="#afnetworking-静态库" class="table-of-contents__link toc-highlight">AFNetworking 静态库</a></li><li><a href="#afnetworking-动态库" class="table-of-contents__link toc-highlight">AFNetworking 动态库</a></li><li><a href="#四种链接情况" class="table-of-contents__link toc-highlight">四种链接情况</a><ul><li><a href="#1-动态库链接动态库" class="table-of-contents__link toc-highlight">1. 动态库链接动态库</a></li><li><a href="#2-动态库链接静态库" class="table-of-contents__link toc-highlight">2. 动态库链接静态库</a></li><li><a href="#3-静态库链接静态库" class="table-of-contents__link toc-highlight">3. 静态库链接静态库</a></li><li><a href="#4-静态库链接动态库" class="table-of-contents__link toc-highlight">4. 静态库链接动态库</a></li></ul></li><li><a href="#cocoapods-集成" class="table-of-contents__link toc-highlight">Cocoapods 集成</a></li><li><a href="#modules" class="table-of-contents__link toc-highlight">Modules</a></li><li><a href="#swift-library" class="table-of-contents__link toc-highlight">Swift Library</a></li><li><a href="#裁剪" class="table-of-contents__link toc-highlight">裁剪</a></li><li><a href="#查看库里的符号" class="table-of-contents__link toc-highlight">查看库里的符号</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">粤ICP备15029205号 Copyright © 2024 yianzhou</div></div></div></footer></div>
<script src="/assets/js/runtime~main.bdd1e9a6.js"></script>
<script src="/assets/js/main.22616d99.js"></script>
</body>
</html>