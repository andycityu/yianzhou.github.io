<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-底层原理/app-launch">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">启动时长优化 | yianzhou</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://yianzhou.github.io/docs/apple/底层原理/app-launch"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="启动时长优化 | yianzhou"><meta data-rh="true" name="description" content="Mach-O"><meta data-rh="true" property="og:description" content="Mach-O"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yianzhou.github.io/docs/apple/底层原理/app-launch"><link data-rh="true" rel="alternate" href="https://yianzhou.github.io/docs/apple/底层原理/app-launch" hreflang="en"><link data-rh="true" rel="alternate" href="https://yianzhou.github.io/docs/apple/底层原理/app-launch" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6a91212d.css">
<link rel="preload" href="/assets/js/runtime~main.84f0b66e.js" as="script">
<link rel="preload" href="/assets/js/main.aadb143c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="yianzhou" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="yianzhou" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">yianzhou</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/apple">Apple</a><a class="navbar__item navbar__link" href="/docs/dev">开发</a><a class="navbar__item navbar__link" href="/docs/language">编程语言</a><a class="navbar__item navbar__link" href="/docs/flutter">Flutter</a><a class="navbar__item navbar__link" href="/docs/insights">Insights</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yianzhou/yianzhou.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/Frameworks/SDWebImage">Frameworks</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/apple-bugs">Apple Bugs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple">Debug</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/uniform-type-identifiers">Uniform Type Identifiers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/wwdc">WWDC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/xcode">Xcode</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/代码/file">代码</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/工具/app-size">工具</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/工程/frameworks">工程</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/apple/底层原理/app-launch">底层原理</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/apple/底层原理/app-launch">启动时长优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/crash">崩溃</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/lag">卡顿</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/llvm">LLVM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/memory">内存优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/multithread">多线程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/performance">性能优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/semaphore">信号量</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/网络/afnetworking">网络</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/音视频、图形/audio-video">音视频、图形</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">底层原理</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">启动时长优化</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>启动时长优化</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mach-o">Mach-O<a href="#mach-o" class="hash-link" aria-label="Direct link to Mach-O" title="Direct link to Mach-O">​</a></h2><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2016/406/" target="_blank" rel="noopener noreferrer">WWDC 2016 - Optimizing App Startup Time</a></p></blockquote><p><strong>Image</strong>: An executable, dylib, or bundle.</p><p>A Mach-O image is divided into segments. Each segment is always a multiple of the page size. The page size is determined by the hardware, for arm64, the page size is 16KB.</p><p>The most common segment names are <code>__TEXT</code>, <code>__DATA</code>, <code>__LINKEDIT</code>:</p><ul><li><code>__TEXT</code> contains the Mach header, machine instructions and read-only constants such as C strings</li><li><code>__DATA</code> segment is read-write and contains global variables, static variables, etc</li><li><code>__LINKEDIT</code> contains information about your functions and variables such as their names and addresses, the &quot;meta data&quot; about how to load the program</li></ul><p>You may also heard about Mach-O Universal Files, that&#x27;s merged Mach-O images for different architectures.</p><p>Every process has a logical address space which gets mapped to some physical page of RAM.</p><p>File backed mapping: rather than actually read an entire file into RAM you can tell the VM system through the <code>mmap</code> call, that I want this slice of this file mapped to this address range in my process. Each time you access an address that hasn&#x27;t been accessed before it will cause a <strong>page fault</strong>, the kernel will read just that one page. And that gives you lazy reading of your file.</p><p>The <code>__TEXT</code> segment of any images can be mapped into VM, it will be read lazily, and all those pages can be shared between processes.</p><p>As soon as one process actually tries to write to <code>__DATA</code> segment page, the <strong>Copy-On-Write</strong> (COW) happens. The Copy-On-Write causes the kernel to make a copy of that page into another physical RAM and redirect the mapping to go to that. So that one process now has its own copy of that page, which brings us to clean versus dirty pages. That copy is considered a dirty page.</p><p>A <strong>dirty page</strong> is something that contains process specific information. A <strong>clean page</strong> is something that the kernel could regenerate later if needed such as re-reading from disk. So dirty pages are much more expensive than clean pages.</p><p><code>__LINKEDIT</code> is only needed while dyld is doing its operations. Once it&#x27;s done, it doesn&#x27;t need these <code>__LINKEDIT</code> pages anymore, the kernal can reclaim them when someone else needs RAM.</p><p>You can mark a page readable, writable, or executable, or any combination of those.</p><p><img loading="lazy" alt="img" src="/assets/images/0cd353b5-de0f-4150-88d1-d8ce30f960b4-9f0605eee734eabaead576353fae86d5.png" width="2460" height="1396" class="img_ev3q"></p><p>There are two security things that have impacted dyld, <strong>ASLR</strong> and <strong>code signing</strong>. ASLR is that every time you loaded the images it may be at a different address. Code signing is at <strong>build time</strong>, every single page of your Mach-O file gets its own individual cryptographic hash. And all those hashes are stored in the <code>__LINKEDIT</code>. This allows each page to be validated that it hasn&#x27;t been tampered with.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="exec-to-main">exec to main<a href="#exec-to-main" class="hash-link" aria-label="Direct link to exec to main" title="Direct link to exec to main">​</a></h2><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2016/406/" target="_blank" rel="noopener noreferrer">WWDC 2016 - Optimizing App Startup Time</a></p></blockquote><p><code>exec()</code> is a system call. When you trap into the kernel, you basically say I want to replace this process with this new program. The kernel wipes the entire address space and maps-in your executable.</p><p>For ASLR the system maps your executable in at a random address. From that address, back down to zero, it marks that whole region (<strong>PAGEZERO</strong>) inaccessible. The size of that region is at least 4GB for 64-bit processes. This catches any NULL pointer references and pointer truncation errors.</p><p>When the kernel&#x27;s done mapping a process, it now maps another Mach-O called dyld into that process at another random address, sets the PC (program counter) into dyld and let dyld load all the dylibs and get everything prepared.</p><p><img loading="lazy" alt="img" src="/assets/images/59ab22bd-6bf5-47b8-a758-0f54334aa35c-14b30ca78a805a96a5ae6585e0aff8b3.png" width="2560" height="200" class="img_ev3q"></p><p>First, dyld has to map all the dependent <strong>dylibs</strong>. To find those dylibs, it first reads the header of the main executable that the kernel already mapped in. That header has a list of all the dependent libraries. Once dyld found each dylib, it validate it, register that code signature to the kernel, then mmap each segment in that dylib. Each of the dylibs may depend on something that&#x27;s already loaded or something need to load. Apps typically load 100 to 400 dylibs! Luckily most of those are OS dylibs which load very quickly because the OS do a lot of pre-calculate and pre-cache works.</p><p><img loading="lazy" alt="img-40" src="/assets/images/3def0897-d699-4017-8410-b9bd7676c6b4-92ceff050284c1fd75dbf8bd06b5ae60.png" width="1326" height="1584" class="img_ev3q"></p><p>Eventually, it has everything loaded, but now they&#x27;re all independent of each other, we have to bind them together. But, because of code signing we can&#x27;t actually alter instructions. So how does one dylib call into another dylib if you can&#x27;t change the instructions? Modern code-gen is dynamic PIC (Position Independent Code), means code can run loaded at any address and is never altered. Actually, the co-gen creates pointers in the <code>__DATA</code> segment that point to implementation. The dyld is going to <strong>fix up</strong> pointers and data (in <code>__DATA</code> sengment).</p><p>There&#x27;re two main categories of fix-ups, <strong>rebasing</strong> and <strong>binding</strong>.</p><p>Rebasing is adjusting pointers to within an image. It means going through all your data pointers and adding a slide to them (because of ASLR). Location of those <strong>relocatable addresses</strong> is encoded in <code>__LINKEDIT</code>. When we start doing rebasing, we&#x27;re actually causing page faults to page in all the <code>__DATA</code> pages. And then we cause copy and write as we&#x27;re changing them. So rebasing can sometimes be expensive because of all the I/O.（这就解释了为什么 <code>__DATA</code> sengment 在内存中是脏分页）</p><p>Binding is setting pointers to outside image. All references to something in another dylib are <strong>symbolic</strong>. So dyld needs to find the implementation of that symbol by looking through symbol tables. Once it&#x27;s found, that values is stored in that data pointer. This is more computationally complex than rebasing is. But there&#x27;s very little I/O because rebasing has done most of the I/O already.</p><blockquote><p>To see fix-ups: <code>&gt; xcrun dyldinfo -rebase -bind -lazy_bind myapp.app/myapp</code></p></blockquote><p>Next, a few extra things that <strong>ObjC Runtime</strong> requires:</p><ul><li>All ObjC class definitions are registered with a global table.</li><li>Non-fragile ivars offsets updated.</li><li>Categories are inserted into method lists, including those not in your executable but in other dylibs.</li><li><code>objc_msgSend</code> is based on selectors being unique so we need unique selectors.</li></ul><p>Finally, before jumping to <code>main</code>, we have to run initializers:</p><ul><li>C++ compiler generates initializer for statically allocated objects</li><li>ObjC <code>+load</code> methods</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="measurement">Measurement<a href="#measurement" class="hash-link" aria-label="Direct link to Measurement" title="Direct link to Measurement">​</a></h2><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2016/406/" target="_blank" rel="noopener noreferrer">WWDC 2016 - Optimizing App Startup Time</a></p></blockquote><p>We have a built-in measurement in dyld, you can access it through setting an environment variable. (Xcode - Edit Scheme - Arguments - Environment Variables, <code>DYLD_PRINT_STATISTICS=1</code>, <code>DYLD_PRINT_STATISTICS_DETAILS=1</code>)</p><div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Total pre-main time: 1.3 seconds (100.0%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         dylib loading time: 1.0 seconds (74.7%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rebase/binding time:  95.79 milliseconds (7.1%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ObjC setup time:  41.65 milliseconds (3.0%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           initializer time: 202.46 milliseconds (15.0%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           slowest intializers :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             libSystem.B.dylib :   7.37 milliseconds (0.5%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           libMTLCapture.dylib :  36.40 milliseconds (2.7%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       Flutter :  79.66 milliseconds (5.9%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total time: 2.4 seconds (100.0%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total images loaded:  656 (584 from dyld shared cache)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total segments mapped: 221, into 63664 pages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total images loading time: 2.0 seconds (84.9%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total load time in ObjC:  41.65 milliseconds (1.6%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total debugger pause time: 1.0 seconds (44.1%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total dtrace DOF registration time:   0.00 milliseconds (0.0%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total rebase fixups:  295,165</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total rebase fixups time:  69.41 milliseconds (2.8%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total binding fixups: 29,525</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total binding fixups time:  46.85 milliseconds (1.9%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total weak binding fixups time:  10.28 milliseconds (0.4%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total redo shared cached bindings time:  30.76 milliseconds (1.2%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total bindings lazily fixed up: 0 of 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total time in initializers and ObjC +load: 202.46 milliseconds (8.2%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         libSystem.B.dylib :   7.37 milliseconds (0.2%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               libBacktraceRecording.dylib :   5.82 milliseconds (0.2%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       libMTLCapture.dylib :  36.40 milliseconds (1.4%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 Alamofire :   2.95 milliseconds (0.1%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    Charts :   3.29 milliseconds (0.1%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              FBSDKCoreKit :   6.85 milliseconds (0.2%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   Flutter :  79.66 milliseconds (3.2%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 xxNetwork :   2.85 milliseconds (0.1%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 HandyJSON :   2.61 milliseconds (0.1%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                MoyaMapper :   2.59 milliseconds (0.1%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   RxSwift :   4.43 milliseconds (0.1%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   RxCocoa :   7.06 milliseconds (0.2%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        xx :  18.68 milliseconds (0.7%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total symbol trie searches:    86758</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total symbol table binary searches:    0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total images defining weak symbols:  70</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total images using weak symbols:  157</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>The debugger has to pause launch on every single dylib load in order to parse the symbols from your app and load your break points, over a USB cable that can be very time consuming. But dyld knows about that and it subtracts the debugger time.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="launch-types">Launch Types<a href="#launch-types" class="hash-link" aria-label="Direct link to Launch Types" title="Direct link to Launch Types">​</a></h2><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2016/406/" target="_blank" rel="noopener noreferrer">WWDC 2016 - Optimizing App Startup Time</a></p></blockquote><p>A <strong>warm launch</strong> is an app where the application is already in memory, either because it&#x27;s been launched and quit previously, and it&#x27;s still sitting in the discache in the kernel, or because you just copied it over.</p><p>A <strong>cold launch</strong> is a launch where it&#x27;s not in the discache, when your user is launching an app after rebooting the phone, or for the first time in a long time.</p><p><img loading="lazy" alt="img" src="/assets/images/45cd0914-f19b-4404-a5ea-05fd3c3963f3-fac2c9a2ac65a606c5b439bc02435e10.png" width="2560" height="1101" class="img_ev3q"></p><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2018/407/?time=2086" target="_blank" rel="noopener noreferrer">WWDC 2018 - Practical Approaches to Great App Performance</a></p></blockquote><p>If you kill an app, it might not trigger a cold launch, because the system decides when the resources should be paged out. If you relaunch it a few second later, it&#x27;s almost guaranteed that you&#x27;ll hit a warm launch. We call it warm, because the resources or the dependents are still in the cache, so it&#x27;s faster to launch.</p><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2019/423/" target="_blank" rel="noopener noreferrer">WWDC 2019 - Optimizing App Launch</a></p></blockquote><ul><li>Cold launch: In order to launch your app, we need to bring it from disk into memory, startup system-side services that support your app, and then spawn your process.</li><li>Warm launch: Your app still needs to be spawned, but we&#x27;ve already brought your app into memory and started up some of those system-side services. So, this will be a little bit faster and more consistent.</li><li>Resume (Hot): occurs when a user reenters your app from either the home screen or the app switcher.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="best-practices">Best Practices<a href="#best-practices" class="hash-link" aria-label="Direct link to Best Practices" title="Direct link to Best Practices">​</a></h2><p>400 milliseconds is a good launch time. Don’t ever take longer than 20 seconds, in that case app will get killed.</p><p>After call <code>main</code>, we have to call <code>UIApplicationMain</code>, that does some other things including running the framework initializers and loading your nibs. And then finally you&#x27;ll get a call back <code>applicationWillFinishLaunching</code>, which is also counted in that 400 milliseconds.</p><p>Use fewer dylibs, a good target is about 6:</p><ul><li>you can merge existing dylibs</li><li>use static libraries</li></ul><p>I/O is for both of rebasing and binding. So fixing up fewer pointers can help:</p><ul><li>Reduce Objective-C metadata (classes, selectors, and categories). There are a number of coding styles that are encouraging very small classes, that maybe only have one or two functions. Those particular patterns may result in gradual slowdowns of your applications. Having 100 or 1,000 classes isn&#x27;t a problem, but 10,000 or 20,000 classes is.</li><li>Reduce C++ virtual functions which create V-tables, that are the same as ObjC metadata. They create structures in the <code>__DATA</code> section that have to be fixed up.</li><li>Use Swift structs. Swift tends to use less data that has pointers for fixing up. Swift is more inlinable and can better co-gen to avoid a lot of that, so migrating to Swift is a great way to improve this.</li><li>Be careful about machine generated codes. You may describe some structures in terms of a DSL (domain-specific language) and then have a program that generates other code from it. And if those generated programs have a lot of pointers in them, they can become very expensive.</li></ul><p>For ObjC setup, we solved by less fix-ups before.</p><p>Initilizers:</p><ul><li>Replacing <code>+load</code> with <code>+initialize</code>, which will cause the ObjC runtime to initialize your code when the classes were substantiated instead of when the file is loaded.</li><li>Don&#x27;t use C/C++ <code>__attribute__((constructor))</code>. Replace with call site initializers, means things like <code>dispatch_once()</code>.</li><li>C++ statics with non-trivial constructors:<ul><li>replace those with call site initilizers</li><li>Only set simple values (PODs, plain old data)</li><li>Use <code>-Wglobal-constructors</code> compiler flag to identify those initilizers</li><li>Rewrite in Swift</li></ul></li><li>Do not call <code>dlopen</code> in initializers</li><li>Do not create threads in initializers</li></ul><p>New in iOS 11, we&#x27;ve added Static Initializer Tracing to Instruments. This is pretty exciting stuff because initializers are code that have to run before main to setup objects for you, and you haven&#x27;t had much visibility into what happens before main. See <a href="https://developer.apple.com/videos/play/wwdc2017/413" target="_blank" rel="noopener noreferrer">WWDC 2017 - App Startup Time: Past, Present, and Future</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dyld3">dyld3<a href="#dyld3" class="hash-link" aria-label="Direct link to dyld3" title="Direct link to dyld3">​</a></h2><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2017/413" target="_blank" rel="noopener noreferrer">WWDC 2017 - App Startup Time: Past, Present, and Future</a></p></blockquote><p>dyld 3 has 3 components:</p><ul><li>An out-of-process Mach-O parser/compiler</li><li>An in-process engine that runs launch closures</li><li>A launch closure caching service</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="instruments-app-launch-template">Instruments: App Launch Template<a href="#instruments-app-launch-template" class="hash-link" aria-label="Direct link to Instruments: App Launch Template" title="Direct link to Instruments: App Launch Template">​</a></h2><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2019/423/" target="_blank" rel="noopener noreferrer">WWDC 2019 - Optimizing App Launch</a></p></blockquote><p><img loading="lazy" alt="img" src="/assets/images/c603c294-5ef9-4077-baa2-013f7d9d439c-dc18217288f989c4cf46ae2622342082.png" width="2560" height="256" class="img_ev3q"></p><p>These six phases came from the new App Launch template in Instruments since Xcode 11. They cover everything from system initialization to the app initialization to view creation and layout, and then depending on your app, potentially a asynchronous loading phase for your data, the extended phase.</p><p>The first half of system interface is dyld. A <strong>dynamic linker</strong> (dyld) loads your shared libraries and frameworks. DYLD3 introduces caching of runtime dependencies to improve warm launch.</p><ul><li>Avoid linking unused frameworks</li><li>Avoid dynamic library loading during launch, e.g. <code>dlopen</code>, <code>-[NSBundle load]</code></li><li>Hard link all your dependencies</li></ul><p>The second half of system interface is libSystem Init. This is when we initialize the low-level system components within your application. This is mostly system-side work with a fixed cost.
Developers don&#x27;t need to focus on the section.</p><p>Runtime initialization: This is when the system initializes your Objective-C and Swift runtimes and invokes all class static load methods.</p><ul><li>Don&#x27;t use static initialization. If you own a framework which uses static initialization, consider exposing API to initialize your stack early.</li><li>Reduce impact to launch by avoiding <code>+[Class load]</code>.</li><li>Use <code>+[Class initialize]</code> to lazily conduct static initialization.</li></ul><p>UIKit Initialization: This is when the system instantiates your <code>UIApplication</code> and <code>UIApplicationDelegate</code>.</p><ul><li>Minimize work in <code>UIApplication</code> subclass</li><li>Minimize work in <code>UIApplicationDelegate</code> initialization</li></ul><p>Application Initialization: This is where you get callbacks of the delegate methods.</p><p><img loading="lazy" alt="img" src="/assets/images/d3ddf60d-93c9-4b23-9eb2-ef64298eccf7-da1be2e9df2d56fdf08b446f3c0d6a21.png" width="2560" height="473" class="img_ev3q"></p><ul><li>You should be deferring any unrelated work not necessary to commit your first frame, by either pushing it to the background queues or just doing it later entirely.</li><li>If you did adopt <code>UIScene</code>, make sure that you&#x27;re sharing resources between scenes.</li></ul><p>First Frame Render: Creates, performs layout for, and draws views. <code>loadView</code>, <code>viewDidLoad</code>, <code>layoutSubviews</code>.</p><ul><li>Flatten view hierarchies and lazily load views</li><li>Optimize auto layout usage, reduce the number of constraints you&#x27;re using</li></ul><p>Extended phase: This is the app-specific period from the first frame to the final frame. To displays asynchronously loaded data.</p><ul><li>Leverage <code>os_signpost</code> to measure work</li></ul><p>In summary: <strong>Minimize, Prioritize, Optimize</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="xctest-metrics">XCTest Metrics<a href="#xctest-metrics" class="hash-link" aria-label="Direct link to XCTest Metrics" title="Direct link to XCTest Metrics">​</a></h2><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2019/417/" target="_blank" rel="noopener noreferrer">WWDC 2019 - Improving Battery Life and Performance</a></p><p><a href="https://developer.apple.com/videos/play/wwdc2019/423/" target="_blank" rel="noopener noreferrer">WWDC 2019 - Optimizing App Launch</a></p></blockquote><p>Utilize the new XCTest app launch measurements on a variety of devices and possibly integrate this with <strong>continuous integration</strong>.</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">testApplicationLaunchTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">measure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">metrics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">applicationLaunch</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">XCUIApplication</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bundleIdentifier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;com.yianzhou.demo&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">launch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="实战">实战<a href="#实战" class="hash-link" aria-label="Direct link to 实战" title="Direct link to 实战">​</a></h2><p><code>main</code> 函数执行后：指的是从 <code>main</code> 函数执行开始，到 <code>application(_:didFinishLaunchingWithOptions:)</code> 方法里首屏渲染相关方法执行完成。主要包括了：首屏初始化所需配置文件的读写操作、首屏数据模型的读取、首屏渲染的计算等。优化方式是，排查业务代码，与首屏渲染无关的代码全部延后执行，例如类的初始化、监听注册等；首屏视图根据功能逻辑，暂时不需显示的采用懒加载；涉及文件或路径的操作，如检查文件夹是否存在，新建、复制、移动、删除文件等等操作，不要放在主线程。</p><p>首屏渲染完成后：从函数上来看，这个阶段指的是 <code>application(_:didFinishLaunchingWithOptions:)</code> 方法作用域内，执行首屏渲染之后的所有方法执行完成。这个阶段用户已经能够看到 App 的首页了，所以优化的优先级排在最后。但是，那些会卡住主线程的方法还是需要最优先处理的，不然还是会影响到用户的交互。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二进制重排">二进制重排<a href="#二进制重排" class="hash-link" aria-label="Direct link to 二进制重排" title="Direct link to 二进制重排">​</a></h2><p>传统的启动优化是基于减少不必要代码、懒加载、利用多线程、延后执行与首屏渲染无关的代码来做的，主要是从减少主线程任务的角度来出发，此类相关优化的策略已经很普遍了，很难再做出大的提升。今天，我们从另一个角度去思考启动优化——内存加载机制。</p><p>APP 启动时，dyld 会把程序的二进制 mmap 到虚拟内存里，当执行代码需要使用到具体的物理内存时，再通过 page fault 触发物理内存加载，然后才能访问。</p><p>page fault 在较差的情况下耗时超过 1ms，在较正常的情况下也要耗时 0.3-0.6ms 左右。那么 App 启动期间大概需要发生多少次 page fault 呢？在我们应用中的数据如下：一次冷启动触发了 2000 多次 page fault，总耗时达到了 300+ms。(Instruments - System Trace - Virtual Memory Trace - File Backed Page In)</p><p>如果我们能让启动期间需要执行的指令，都紧凑地排列在相邻的内存分页，那么就能尽可能地减少 page fault 的次数，这就是二进制重排的目的。</p><p>Xcode 对二进制重排提供了支持，只需要在编译设置里指定一个 Order File 即可 (Build Settings - Linking - Order File)，例如 objc 的源码就使用了这项技术（源码文件夹下的 libobjc.order 文件）。编译器会按照这个文件指定的符号顺序来排列二进制代码段，达到优化的目的。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/yianzhou/yianzhou.github.io/docs/apple/底层原理/app-launch.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/apple/工程/项目配置"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">项目配置</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/apple/底层原理/crash"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">崩溃</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#mach-o" class="table-of-contents__link toc-highlight">Mach-O</a></li><li><a href="#exec-to-main" class="table-of-contents__link toc-highlight">exec to main</a></li><li><a href="#measurement" class="table-of-contents__link toc-highlight">Measurement</a></li><li><a href="#launch-types" class="table-of-contents__link toc-highlight">Launch Types</a></li><li><a href="#best-practices" class="table-of-contents__link toc-highlight">Best Practices</a></li><li><a href="#dyld3" class="table-of-contents__link toc-highlight">dyld3</a></li><li><a href="#instruments-app-launch-template" class="table-of-contents__link toc-highlight">Instruments: App Launch Template</a></li><li><a href="#xctest-metrics" class="table-of-contents__link toc-highlight">XCTest Metrics</a></li><li><a href="#实战" class="table-of-contents__link toc-highlight">实战</a></li><li><a href="#二进制重排" class="table-of-contents__link toc-highlight">二进制重排</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">粤ICP备15029205号 Copyright © 2023 yianzhou</div></div></div></footer></div>
<script src="/assets/js/runtime~main.84f0b66e.js"></script>
<script src="/assets/js/main.aadb143c.js"></script>
</body>
</html>