<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-底层原理/multithread">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">多线程 | yianzhou</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://yianzhou.github.io/docs/apple/底层原理/multithread"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="多线程 | yianzhou"><meta data-rh="true" name="description" content="Parallelism and Concurrency"><meta data-rh="true" property="og:description" content="Parallelism and Concurrency"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yianzhou.github.io/docs/apple/底层原理/multithread"><link data-rh="true" rel="alternate" href="https://yianzhou.github.io/docs/apple/底层原理/multithread" hreflang="en"><link data-rh="true" rel="alternate" href="https://yianzhou.github.io/docs/apple/底层原理/multithread" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6a91212d.css">
<link rel="preload" href="/assets/js/runtime~main.1044df96.js" as="script">
<link rel="preload" href="/assets/js/main.76ae18e3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="yianzhou" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="yianzhou" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">yianzhou</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/apple">Apple</a><a class="navbar__item navbar__link" href="/docs/dev">开发</a><a class="navbar__item navbar__link" href="/docs/language">编程语言</a><a class="navbar__item navbar__link" href="/docs/flutter">Flutter</a><a class="navbar__item navbar__link" href="/docs/insights">Insights</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yianzhou/yianzhou.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/Frameworks/SDWebImage">Frameworks</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/apple-bugs">Apple Bugs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple">Debug</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/uniform-type-identifiers">Uniform Type Identifiers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/wwdc">WWDC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/xcode">Xcode</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/代码/file">代码</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/工具/app-size">工具</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/工程/frameworks">工程</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/apple/底层原理/app-launch">底层原理</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/app-launch">启动时长优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/crash">崩溃</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/lag">卡顿</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/llvm">LLVM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/memory">内存优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/apple/底层原理/multithread">多线程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/performance">性能优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/底层原理/semaphore">信号量</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/网络/afnetworking">网络</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/音视频、图形/audio-video">音视频、图形</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">底层原理</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">多线程</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>多线程</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="parallelism-and-concurrency">Parallelism and Concurrency<a href="#parallelism-and-concurrency" class="hash-link" aria-label="Direct link to Parallelism and Concurrency" title="Direct link to Parallelism and Concurrency">​</a></h2><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2017/706" target="_blank" rel="noopener noreferrer">WWDC 2017 - Modernizing Grand Central Dispatch Usage</a></p></blockquote><p>Concurrency 并发: A condition that exists when at least two threads are making progress. Single-core devices can achieve concurrency through time-slicing.</p><p>Parallelism 并行: A condition that arises when at least two threads are executing simultaneously. Multi-core devices execute multiple threads at the same time via parallelism.</p><p>Efficient parallel for-loop doing parallel computation across all CPU cores:</p><ul><li><p>Objective-C: <a href="https://developer.apple.com/documentation/dispatch/1453050-dispatch_apply" target="_blank" rel="noopener noreferrer"><code>dispatch_apply(DISPATCH_APPLY_AUTO, 1000, ^(size_t) { ... }</code></a></p></li><li><p>Swift: <a href="https://developer.apple.com/documentation/dispatch/dispatchqueue/2016088-concurrentperform" target="_blank" rel="noopener noreferrer"><code>DispatchQueue.concurrentPerform(1000) { i in ... }</code></a></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="context-switching">Context Switching<a href="#context-switching" class="hash-link" aria-label="Direct link to Context Switching" title="Direct link to Context Switching">​</a></h3><p>A context switch is when the CPU switches between these different subsystems or threads that make up your application.</p><p>Let&#x27;s image that we only have one CPU remaining, the others are busy for some reason. At any time only one threads can run on that CPU. When the user touches the app, because the database is run off the main thread, the OS can immediately switch the CPU to work on the main thread, so it can respond immediately to the user without having to wait for the database thread to complete. When the user interface is done responding, the CPU can then switch back to the database thread, and then finish the networking task as well. These white lines below show the context switches.</p><p><img loading="lazy" alt="img" src="/assets/images/b58785de-d2af-4c8b-9d76-638f9df52be3-6b5a0c72f0ce8a9847eaa75c33580ada.png" width="1924" height="1142" class="img_ev3q"></p><p>Context switches might happen when:</p><ul><li>A higher priority thread needs the CPU</li><li>A thread finishes its current work</li><li>Waiting to acquire a resource</li><li>Waiting for an asynchronous request to complete</li></ul><p>Excessive Context Switching: Context switch is good thing, it&#x27;s where the power of concurrency comes from. However, if you&#x27;re doing this thousands of times in really rapid succession, the costs start to add up and you run into trouble.</p><ul><li>Lock Contention: See below.</li><li>Having too many serial queue: See below.</li><li>Too many thread-blocking work items submiited to concurrent queue:<ul><li>Do not block thread;</li><li>Choose the right amount of concurrency in your application;</li><li>Size your work items appropriately.</li></ul></li></ul><p>Debug tool: Instruments - Template: Blank - Add Library: GCD Performance.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lock-contention">Lock Contention<a href="#lock-contention" class="hash-link" aria-label="Direct link to Lock Contention" title="Direct link to Lock Contention">​</a></h3><p>The primary case of excessive context switching is <strong>lock contention</strong>, that happens when you have a lock and a bunch of threads are all trying to acquire that lock.</p><p>Let&#x27;s see a <strong>fair lock</strong> case. Here we&#x27;re focusing on two threads, and we have a CPU on top. We&#x27;ve added a lock track view that shows the state of the lock and what thread owns it.</p><p><img loading="lazy" alt="img" src="/assets/images/d809255e-282d-440c-8394-eb16d795ccd0-a100e07549e23b8625804efdad0ad803.png" width="2362" height="1428" class="img_ev3q"></p><p>At the beginninbg, the blue thread owns the lock, and the green thread is waiting. Then, when the blue thread unlocks, the ownership of that lock is transferred to the green thread, because it&#x27;s next in line, However, the CPU is still running the blue thread, and suppose, the blue thread grabs the lock again, it can&#x27;t because the lock is <strong>reserved</strong> for the green thread. It forces a context switch at this point to the green thread.</p><p>The fair lock is useful. You want every thread that&#x27;s waiting on the lock to get a chance to acquire the resource.</p><p>And the <strong>unfair lock</strong> case. This time, when blue thread unlocks, the lock isn&#x27;t reserved. The ownership of the lock is up for grabs. Blue can take the lock again, and it can immediately reacquire and stay on CPU without forcing a context switch.</p><p><img loading="lazy" alt="img" src="/assets/images/7a56c617-f8d6-434f-983e-7cbac7cbb0bc-e93e3635b825d75444b13d96e8a8a08e.png" width="2362" height="1418" class="img_ev3q"></p><p>This might make it difficult for the green thread to actually get a chance at the lock, but it reduces the number of context switches the blue thread has to have in order to reacquire the lock.</p><p>You actually need to measure your application in &quot;Instruments - System Trace&quot; and see if you have an excessive context switching issue. If you do, often the unfair lock works best for these cases.</p><p><img loading="lazy" alt="img" src="/assets/images/ba464317-1f0c-42e3-af18-ef5b84cc3982-bea306ff311562ef187135d77dca98b5.png" width="2560" height="657" class="img_ev3q"></p><p>As you see the lock track view above, the runtime actually knows which thread will unlock the lock next. We can take advantage of that power to automatically resolve <strong>priority inversions</strong> between the waiters and the owners of the lock, and even enable other optimizations, like directed CPU handoff to the owning thread. Primitives with a single known owner have this power, but the others don&#x27;t have.</p><p><img loading="lazy" alt="img" src="/assets/images/a07fb769-61e6-4059-b70d-6c4f62b700f7-0c90e0aa7aaae18ed634e421a66fb28f.png" width="2560" height="813" class="img_ev3q"></p><p>So when you&#x27;re picking a primitive (lock), consider whether or not your use case involves threads of different priorities interacting, like a high priority UI thread with a lower priority background thread. If so, you might want to take advantage of a primitive with ownership that ensures that your UI thread doesn&#x27;t get delayed by waiting on a lower priority background thread.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="target-queue-hirerachy">Target Queue Hirerachy<a href="#target-queue-hirerachy" class="hash-link" aria-label="Direct link to Target Queue Hirerachy" title="Direct link to Target Queue Hirerachy">​</a></h3><p>Set your serial queues targeting one queue per subsystem, use a fixed number of serial queue hierarchies.</p><p><img loading="lazy" alt="img" src="/assets/images/1677795a-5cf6-4118-ac0e-d87439dbf510-12f1cbe5c82956bd6977a655e5ae1d99.png" width="2560" height="1059" class="img_ev3q"></p><p>We have completely reinvented the internals of GCD this year to eliminate some unwanted context switches and execute single queue hierarchies on the single thread. You, as the developer, need to <strong>protect the target queue hierarchy</strong> so your code can be benefited from these optimizations.</p><p><img loading="lazy" alt="img" src="/assets/images/3a460ef9-2b43-4de7-96a9-e9b622bd201a-266d38de24db852ced4781c85c152c95.png" width="2540" height="1374" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="operation">Operation<a href="#operation" class="hash-link" aria-label="Direct link to Operation" title="Direct link to Operation">​</a></h2><blockquote><p><a href="https://developer.apple.com/videos/play/wwdc2015/226/" target="_blank" rel="noopener noreferrer">WWDC 2015 - Advanced NSOperations</a></p></blockquote><p><code>OperationQueue</code>:</p><ul><li>High-level <code>dispatch_queue_t</code></li><li>Cancellation</li><li><code>maxConcurrentOperationCount</code>, 1 means <strong>serial queue</strong></li></ul><p><code>Operation</code>:</p><ul><li>High-level <code>dispatch_block_t</code></li><li>Long-running task</li><li>Subclassable</li></ul><p><code>@property(readonly, getter=isCancelled) BOOL cancelled;</code> Cancellation on <code>Operation</code> only flipped the boolean value of <code>cancelled</code>. So as you subclass <code>Operation</code>, it is up to you to decide what it means for your <code>Operation</code> to be canceled.</p><p><code>@property(readonly, getter=isReady) BOOL ready;</code> By default, an operation will become ready if all of its <strong>dependencies</strong> have finished executing. If you have two operation queues in your application, operations in the first queue can be dependent on the operations in the second queue. 先进入 ready 状态的任务先出列执行、不管其在队列中的哪个位置。<code>OperationQueue</code> 并不是 FIFO 的队列！</p><p><img loading="lazy" alt="img" src="/assets/images/328be38f-19c3-4a69-969c-5c405da382f6-b7fa1221dc9ed392dcf85682f7b21c10.png" width="2560" height="1286" class="img_ev3q"></p><p>Use operations to <strong>abstract the logic</strong> in your app. By putting your logic inside of operations, it becomes very easy to change it later. Use <strong>dependencies</strong> to express the relationships between your operations. Next, operations allow you to describe complex behaviors, such as <strong>mutual exclusivity</strong> or <strong>composition</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="synchronization">Synchronization<a href="#synchronization" class="hash-link" aria-label="Direct link to Synchronization" title="Direct link to Synchronization">​</a></h2><p>多个进程同时操作同一份数据、并且执行结果取决于操作发生的特定顺序的情况，称为<strong>竞争情况</strong> (race condition)。为了防止出现竞争情况，我们要求以某种方式同步 (synchronized) 进程。</p><p>每个线程会有自己的栈内存空间，栈空间相互隔离、互不影响；但有时多个线程要访问到共享的堆区内存，此时如果不进行同步，就会出现内存不一致问题。设想这样一个场景，用户的银行账户里有 100 元，此时有 3 个柜员机同时进行存、取、查操作，它们之间就需要进行同步。</p><p>程序可以声明称为临界区 (critical section) 的代码。在临界区中，线程可能正在访问或更新与至少一个其他线程共享的数据。当一个线程在临界区执行时，不允许其他线程在临界区执行。多个线程必须互斥地对临界资源进行访问。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="公平锁与非公平锁">公平锁与非公平锁<a href="#公平锁与非公平锁" class="hash-link" aria-label="Direct link to 公平锁与非公平锁" title="Direct link to 公平锁与非公平锁">​</a></h3><p>多个线程同时到达临界区，先到的线程会获得锁，后到的线程会在一个 FIFO 队列里等待。</p><p>公平锁：在竞争情况下，锁被释放后，即被等待队列头部的线程保留。优点是每个线程都有机会得到锁，不会饿死；缺点是由于上下文切换次数更多、相对来说吞吐量没有非公平锁大。</p><p>非公平锁：在竞争情况下，锁被释放后不会被保留，无须考虑等待队列里的线程。优点是提高了重获锁的效率和整体的吞吐量；缺点是可能导致别的线程一直获取不到锁、甚至饿死。</p><p>iOS 中日常使用到的锁，除了 <code>os_unfair_lock</code> 是非公平锁，其余都是公平锁。</p><p>为什么要进入队列等待呢？一直尝试获取锁可以吗？——可以，一直尝试获取的叫自旋锁，与互斥锁类似，只是自旋锁被某线程占用时，其他线程不会挂起，而是一直运行（自旋/空转）直到锁被释放。由于不涉及用户态与内核态之间的切换，它的效率高于互斥锁。但相应地，会一直占用 CPU，如果不能在很短的时间内获得锁，无疑会使 CPU 整体效率降低。</p><p>非公平锁/自旋锁适用于：预计临界区执行的时间很短，等待的线程能很快获得锁；临界区的代码经常被调用，但竞争情况很少发生。</p><p>公平锁/互斥锁适用于：预计临界区执行的时间较长，线程等待锁的时间较长；临界区竞争情况经常发生。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="os_unfair_lock">os_unfair_lock<a href="#os_unfair_lock" class="hash-link" aria-label="Direct link to os_unfair_lock" title="Direct link to os_unfair_lock">​</a></h3><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">import</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression" style="color:#36acaa">os</span><span class="token macro property expression operator" style="color:#393A34">/</span><span class="token macro property expression" style="color:#36acaa">lock</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">h</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os_unfair_lock lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> OS_UNFAIR_LOCK_INIT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">os_unfair_lock_lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 加锁和解锁必须对称，重复加锁会直接崩溃！</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;safe here ...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">os_unfair_lock_unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A lock must be unlocked only from the same thread in which it was locked. Attempting to unlock from a different thread causes a runtime error.</p><p>This is a replacement for the deprecated <code>OSSpinLock</code>. This function doesn&#x27;t spin on contention, but instead waits in the kernel to be awoken by an unlock. Like <code>OSSpinLock</code>, this function does not enforce fairness or lock ordering—for example, an unlocker could potentially reacquire the lock immediately, before an awoken waiter gets an opportunity to attempt to acquire the lock. This may be advantageous for performance reasons, but also makes starvation of waiters a possibility.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="互斥锁">互斥锁<a href="#互斥锁" class="hash-link" aria-label="Direct link to 互斥锁" title="Direct link to 互斥锁">​</a></h3><p><code>pthread_mutex_t</code>，pthread 中的互斥锁，具有跨平台性质，有普通锁、检错锁、递归锁三种。当锁处于占用状态时，其他线程会挂起；当锁被释放时，所有等待的线程都将被唤醒，再次对锁进行竞争。在挂起与唤醒过程中，涉及用户态与内核态之间的上下文切换，这种切换是比较消耗性能的。</p><p><code>NSLock</code> 是对 <code>pthread_mutex_lock</code> 的封装，是普通类型的互斥锁；如果用在需要递归嵌套加锁的场景时，需要使用其子类 <code>NSRecursiveLock</code>。</p><p><code>@synchronized</code> 是对 <code>pthread_mutex_t</code> 的封装，是递归类型的互斥锁。</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">@</span><span class="token function" style="color:#d73a49">synchronized</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callbacks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">callbackBlocks valueForKey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> mutableCopy</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>pthread_rwlock_t</code> 读写锁是用于“多线程读、单线程写”这一种读写互斥的场景，读操作可并发重入，写操作是互斥的。</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">import</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression" style="color:#36acaa">pthread</span><span class="token macro property expression operator" style="color:#393A34">/</span><span class="token macro property expression" style="color:#36acaa">pthread</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">h</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instancetype</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">init </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">self</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">super</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">pthread_rwlock_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_lock</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">queryMoney </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">pthread_rwlock_rdlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">super</span><span class="token plain"> queryMoney</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">pthread_rwlock_unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">saveMoney </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">pthread_rwlock_wrlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">super</span><span class="token plain"> saveMoney</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">pthread_rwlock_unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="信号量">信号量<a href="#信号量" class="hash-link" aria-label="Direct link to 信号量" title="Direct link to 信号量">​</a></h3><p>信号量主要用于控制临界区的资源最多可以被多少个线程并发访问。</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dispatch_semaphore_t lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dispatch_semaphore_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dispatch_semaphore_wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DISPATCH_TIME_FOREVER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 等待和发出信号必须对称！重复调用 wait 不会崩溃，但会造成无限的等待……</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;safe here ...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dispatch_semaphore_signal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="osspinlock-deprecated">OSSpinLock (deprecated)<a href="#osspinlock-deprecated" class="hash-link" aria-label="Direct link to OSSpinLock (deprecated)" title="Direct link to OSSpinLock (deprecated)">​</a></h3><p>在罕见的情况下，低优先级的线程先获得了锁，这时一个高优先级的线程也尝试获得这个锁，它会处于空转状态并持续占用 CPU。但与此同时，低优先级线程在 CPU 时间的分配上远远少于高、中优先级线程，这就导致任务迟迟完不成、无法释放锁。除非开发者能保证访问锁的线程全部处于同一优先级，否则 iOS 系统中所有类型的自旋锁都不能再使用了。</p><p>过去 <code>atomic</code> 修饰的属性在底层也是使用自旋锁的，随着自旋锁被废弃，现在改用了 <code>os_unfair_lock</code>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="原子操作">原子操作<a href="#原子操作" class="hash-link" aria-label="Direct link to 原子操作" title="Direct link to 原子操作">​</a></h2><p>某些简单的表达式例如 <code>i += 1</code>，其实编译之后的得到的汇编指令，不止一条，所以他们并不是原子操作。</p><p>原子操作一定是在同一个 CPU 时间片中完成，这样即使线程被切换，多个线程也不会看到同一块内存中不完整的数据。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ipc-跨进程通信">IPC 跨进程通信<a href="#ipc-跨进程通信" class="hash-link" aria-label="Direct link to IPC 跨进程通信" title="Direct link to IPC 跨进程通信">​</a></h2><p>由于 iOS 的沙盒机制，每个进程都在独立的沙盒中运行，与其它进程的通信相对受限，主要是通过系统的接口。例如：</p><p><code>UIDocumentInteractionController</code> 可以传输文档、预览、打印、发邮件等，参考 <a href="https://code.tutsplus.com/tutorials/ios-sdk-previewing-and-opening-documents--mobile-15130" target="_blank" rel="noopener noreferrer">iOS SDK: Previewing and Opening Documents</a>。</p><p><code>UIActivityViewController</code> 提供了分享内容的方法，包括 AirDrop 等。</p><p><code>UIPasteboard</code> 可以访问剪贴板。</p><p><code>Keychain</code> 提供钥匙串访问。</p><p>访问 Application Group 共享的文件夹：<code>FileManager.default.containerURL(forSecurityApplicationGroupIdentifier: kAppGroupIdentifier)</code>。</p><p>在共享区存储 UserDefaults：<code>UserDefaults(suiteName: kAppGroupIdentifier)</code>。</p><p>URLScheme 和 Universal Links 通过深链接 URL 传递信息。</p><p>macOS 上还可以通过 local socket，进程 A 对某一个端口进行绑定、监听，进程 B 进行 TCP 连接。参考：<a href="https://nshipster.com/inter-process-communication/" target="_blank" rel="noopener noreferrer">Inter-Process Communication</a>（不仅是 iOS，也有 macOS，针对整个苹果生态）。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="死锁">死锁<a href="#死锁" class="hash-link" aria-label="Direct link to 死锁" title="Direct link to 死锁">​</a></h2><p>简单的死锁例子：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token class-name">Foundation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">NSLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">methodA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">methodB</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">methodB</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">&quot;B&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">methodA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="img" src="/assets/images/6f90086b-9eee-4de0-a7ec-2e7f3c7c1c0c-8487ba7aba7979b79ecd3cab5797e059.png" width="1316" height="1016" class="img_ev3q"></p><p>NSLock 是非递归锁，当同一线程重复获取同一非递归锁时，就会发生死锁。</p><p>递归锁：它允许<strong>同一线程</strong>多次加锁，而不会造成死锁。所以上面的代码改成 <code>NSRecursiveLock</code> 后不会死锁。</p><p>但如果错误地在两个线程中使用了递归锁，则很容易导致死锁：两个线程同时对同一个锁进行加锁，同时发现该锁已经锁定，彼此等待对方解锁，导致两个线程都无法执行下去。尤其是有一方是主线程的情况下，主线程被阻塞，UI 呈现假死状态。</p><p>递归锁专门用于循环或递归中需要同步的代码，但它却不能避免两个线程同时访问锁中代码的情况。而 <code>NSLock</code> 却恰恰相反，它能避免两个线程同时访问锁中的代码，却不能避免在同一线程中，同步代码中嵌套加锁的情况。</p><p>如果因为代码中既没有递归也没有循环，则用 <code>NSLock</code>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="单例与线程安全">单例与线程安全<a href="#单例与线程安全" class="hash-link" aria-label="Direct link to 单例与线程安全" title="Direct link to 单例与线程安全">​</a></h2><p>单例中读写静态变量，不安全。</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> bool hasDone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> NO</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">hasDone</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// do something</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hasDone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> YES</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上写法不安全，有可能多个线程同时通过非空检查，导致 <code>if</code> 内的代码执行多次。</p><p>懒加载在单例中不安全。</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NSArray </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">myArray </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_myArray</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _myArray </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NSArray alloc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> _myArray</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这种判断在多线程下不安全的。多线程下尽量别使用懒加载，即使使用，也要加相应的保护，比如在 <code>_myArray</code> 不会被重新置为 <code>nil</code> 的前提下可以使用 <code>dispatch_once</code>。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/yianzhou/yianzhou.github.io/docs/apple/底层原理/multithread.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/apple/底层原理/memory"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">内存优化</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/apple/底层原理/performance"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">性能优化</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#parallelism-and-concurrency" class="table-of-contents__link toc-highlight">Parallelism and Concurrency</a><ul><li><a href="#context-switching" class="table-of-contents__link toc-highlight">Context Switching</a></li><li><a href="#lock-contention" class="table-of-contents__link toc-highlight">Lock Contention</a></li><li><a href="#target-queue-hirerachy" class="table-of-contents__link toc-highlight">Target Queue Hirerachy</a></li></ul></li><li><a href="#operation" class="table-of-contents__link toc-highlight">Operation</a></li><li><a href="#synchronization" class="table-of-contents__link toc-highlight">Synchronization</a><ul><li><a href="#公平锁与非公平锁" class="table-of-contents__link toc-highlight">公平锁与非公平锁</a></li><li><a href="#os_unfair_lock" class="table-of-contents__link toc-highlight">os_unfair_lock</a></li><li><a href="#互斥锁" class="table-of-contents__link toc-highlight">互斥锁</a></li><li><a href="#信号量" class="table-of-contents__link toc-highlight">信号量</a></li><li><a href="#osspinlock-deprecated" class="table-of-contents__link toc-highlight">OSSpinLock (deprecated)</a></li></ul></li><li><a href="#原子操作" class="table-of-contents__link toc-highlight">原子操作</a></li><li><a href="#ipc-跨进程通信" class="table-of-contents__link toc-highlight">IPC 跨进程通信</a></li><li><a href="#死锁" class="table-of-contents__link toc-highlight">死锁</a></li><li><a href="#单例与线程安全" class="table-of-contents__link toc-highlight">单例与线程安全</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">粤ICP备15029205号 Copyright © 2023 yianzhou</div></div></div></footer></div>
<script src="/assets/js/runtime~main.1044df96.js"></script>
<script src="/assets/js/main.76ae18e3.js"></script>
</body>
</html>