<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-音视频、图形/graphics">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">图形渲染 | yianzhou</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://yianzhou.github.io/docs/apple/音视频、图形/graphics"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="图形渲染 | yianzhou"><meta data-rh="true" name="description" content="GUI 框架"><meta data-rh="true" property="og:description" content="GUI 框架"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yianzhou.github.io/docs/apple/音视频、图形/graphics"><link data-rh="true" rel="alternate" href="https://yianzhou.github.io/docs/apple/音视频、图形/graphics" hreflang="en"><link data-rh="true" rel="alternate" href="https://yianzhou.github.io/docs/apple/音视频、图形/graphics" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6a91212d.css">
<link rel="preload" href="/assets/js/runtime~main.141ec53f.js" as="script">
<link rel="preload" href="/assets/js/main.80ea6a95.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="yianzhou" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="yianzhou" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">yianzhou</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/apple">Apple</a><a class="navbar__item navbar__link" href="/docs/dev">开发</a><a class="navbar__item navbar__link" href="/docs/language">编程语言</a><a class="navbar__item navbar__link" href="/docs/flutter">Flutter</a><a class="navbar__item navbar__link" href="/docs/insights">Insights</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yianzhou/yianzhou.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/Frameworks/SDWebImage">Frameworks</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/apple-bugs">Apple Bugs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple">Debug</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/uniform-type-identifiers">Uniform Type Identifiers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/wwdc">WWDC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/apple/xcode">Xcode</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/代码/file">代码</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/工具/app-size">工具</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/工程/frameworks">工程</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/底层原理/app-launch">底层原理</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/apple/网络/afnetworking">网络</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/apple/音视频、图形/audio-video">音视频、图形</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/音视频、图形/audio-video">音视频基础知识</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/音视频、图形/avfoundation">AVFoundation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/音视频、图形/core-animation">Core Animation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/apple/音视频、图形/graphics">图形渲染</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/音视频、图形/live-streaming">直播</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apple/音视频、图形/metal">Metal</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">音视频、图形</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">图形渲染</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>图形渲染</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gui-框架">GUI 框架<a href="#gui-框架" class="hash-link" aria-label="Direct link to GUI 框架" title="Direct link to GUI 框架">​</a></h2><p>可以用于 iOS 开发的 GUI 框架：</p><p><img loading="lazy" alt="img" src="/assets/images/FE2B5E00-D1A9-43A2-85E0-0B7091F224F7-26d6e2f4c98852cb60cd68fd40321ff2.png" width="1920" height="1080" class="img_ev3q"></p><p>注：还有 SwiftUI</p><p>使用 WebKit 的网页显示慢，主要是由于 CSS 和 JavaScript 资源加载方式导致的。同时，解析时 HTML、CSS、JavaScript 需要兼容老版本，JavaScript 类型推断失败会重来，列表缺少重用机制等原因，导致 WebKit 框架的整体性能没有其他框架好。</p><p>我们看到屏幕上的图像，要经过布局、绘制、渲染、显示这几个阶段。</p><ul><li>布局：更新视图树，计算出控件的大小和位置。</li><li>绘制：视图创建，计算每个控件的内容，图像解码等。</li><li>渲染：将 CPU 计算好的内容交给 GPU 渲染，生成 bitmap 放到帧缓冲区。</li><li>显示：视频控制器按照 VSync 信号读取帧缓冲区，传递给显示器显示。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="原理">原理<a href="#原理" class="hash-link" aria-label="Direct link to 原理" title="Direct link to 原理">​</a></h2><p>我们看到的 App 界面，是由 CPU 和 GPU 共同计算处理的。CPU 处理渲染内容的计算，比如视图创建、布局、图片解码等，内容计算完成后，再传输给 GPU 进行渲染。如果计算、渲染一帧的时间超过屏幕刷新频率要求的时间，界面就会出现卡顿。</p><p>原生界面更新渲染的流程，可以分为四步。</p><ul><li>第一步，更新视图树，同步更新图层树。</li><li>第二步，CPU 计算要显示的内容，包括视图创建（设置 Layer 的属性）、布局计算、视图绘制（创建 Layer 的 Backing Image）、图像解码。当 RunLoop 在 BeforeWaiting 和 Exit 时，会通知注册的监听，然后对图层打包，打完包后，将打包数据发送给一个独立负责渲染的进程 Render Server。</li><li>第三步，数据到达 Render Server 后会被反序列化，得到图层树，按照图层树中图层顺序、RGBA 值、图层 frame 过滤图层中被遮挡的部分，过滤后将图层树转成渲染树，渲染树的信息会转给 OpenGL ES/Metal。前面 CPU 所处理的这些事情统称为 Commit Transaction。</li><li>第四步，Render Server 会调用 GPU，GPU 的主要工作是将 3D 坐标转化成 2D 坐标，然后再把 2D 坐标转成实际像素，具体实现可以分为顶点着色器（确定形状的点）、形状装配（确定形状的线）、几何着色器（确定三角形个数）、光栅化（确定屏幕像素点）、片段着色器（对像素点着色）、测试与混合（检查深度和透明度进行混合）六个阶段。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="离屏渲染">离屏渲染<a href="#离屏渲染" class="hash-link" aria-label="Direct link to 离屏渲染" title="Direct link to 离屏渲染">​</a></h2><p><a href="https://objccn.io/issue-3-1/" target="_blank" rel="noopener noreferrer">objc.io - 绘制像素到屏幕上</a></p><p><a href="https://github.com/seedante/iOS-Note/wiki/Mastering-Offscreen-Render" target="_blank" rel="noopener noreferrer">Mastering Offscreen Render</a></p><p>要讲清楚离屏渲染这个问题，首先要了解计算机图形的渲染过程。CPU 处理好图片解码等工作、将计算好的图形内容交给 GPU 渲染，GPU 经过顶点着色、光栅化、片元着色，将渲染好的结果写入到帧缓冲区，随后视频控制器会根据 VSync 信号读取帧缓冲区的数据，输出到显示器显示。</p><p>如果有时因为一些限制，渲染服务无法<strong>一次性</strong>地把图形渲染到 frame buffer，而是需要分步骤完成——先开辟额外的缓冲空间，也称为离屏缓冲区，最后再将结果合成到 frame buffer，那么这个过程就称为离屏渲染。</p><p>一般情况下，你需要避免离屏渲染，因为这是很大的性能消耗，其中涉及两次昂贵的环境转换（转换环境到屏幕外缓冲区，然后转换环境到帧缓冲区）。</p><p>Instruments 的 Core Animation 工具有一个叫做 Color Offscreen-Rendered Yellow 的选项，它会将离屏渲染的区域标注为黄色（在模拟器中可以直接用）。同时记得检查 Color Hits Green and Misses Red 选项。绿色代表屏幕外缓冲区被复用，红色代表屏幕外缓冲区被重新创建。</p><p>代码示例：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 触发离屏渲染</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> button1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIButton</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CGRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setImage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UIImage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">named</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;unnamed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">normal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cornerRadius </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// iOS 9 的优化，设置单个图层的圆角不会触发离屏渲染</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> button2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIButton</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CGRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">150</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setImage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UIImage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">named</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;unnamed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">normal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imageView</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cornerRadius </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imageView</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 设置这一层 masksToBounds 为 true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 背景色+图片，触发离屏渲染</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> imageView1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIImageView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CGRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">210</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIImage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">named</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;unnamed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backgroundColor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIColor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cornerRadius </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 只有图片、没有背景色，不会触发离屏渲染</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> imageView2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIImageView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CGRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">150</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">210</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIImage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">named</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;unnamed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cornerRadius </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 图片+边框一起，触发离屏渲染</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> imageView3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIImageView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CGRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">320</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIImage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">named</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;unnamed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cornerRadius </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borderColor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIColor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">systemPink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cgColor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borderWidth </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 不会触发离屏渲染</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 背景颜色、边框圆角不用设置 masksToBounds，也有圆角效果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> emptyView </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CGRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">150</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">320</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emptyView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backgroundColor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIColor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cgColor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emptyView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cornerRadius </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emptyView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borderColor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIColor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">systemPink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cgColor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emptyView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borderWidth </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emptyView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 文字+背景色一起，触发离屏渲染</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> label </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UILabel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CGRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">430</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;Hello world!Hello world!Hello world!Hello world!Hello world!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backgroundColor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIColor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">systemPink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cgColor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">numberOfLines </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cornerRadius </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// iOS 9 的优化，设置单个图层的圆角不会触发离屏渲染（content 层，文字）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> label2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UILabel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CGRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">150</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">430</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">label2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;Hello world!Hello world!Hello world!Hello world!Hello world!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">label2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">numberOfLines </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">label2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cornerRadius </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">label2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// addSubview，父 view 和子 view 都没有离屏渲染，叠加也不会触发离屏渲染</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> containerView </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CGRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">150</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">540</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containerView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backgroundColor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIColor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">systemPurple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containerView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cornerRadius </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containerView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> imageView4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIImageView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CGRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIImage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">named</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;unnamed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cornerRadius </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageView4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">masksToBounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containerView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addSubview</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imageView4</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在同等数量的规模下，对性能的影响等级：Shadow &gt; RoundedCorner &gt; Mask &gt; GroupOpacity。</p><p>任何时候优先考虑避免触发离屏渲染，无法避免时优化方案有几种：</p><ul><li>AsyncDisplayKit（现已更名为 Texture）</li><li>CoreGraphics 绘制，尤其对于部分圆角的图片。</li><li>设置 layer.opache = true</li><li>用叠加图层的方式来达到效果。如果图片大小固定，设计同学配合出图，直接 addSubview 盖住；视频也可以用这个办法。</li><li>阴影用 shadowPath</li><li>模糊效果可以自己计算，不用 UIBlurEffectView。</li><li>最后，打开 shouldRasterize：适用于静态内容的视图，也就是不做动画、内部结构和内容不发生变化的视图。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="圆角">圆角<a href="#圆角" class="hash-link" aria-label="Direct link to 圆角" title="Direct link to 圆角">​</a></h2><p><code>cornerRadius</code> 的官方解释： By default, the corner radius does not apply to the image in the layer’s contents property; it applies only to the background color and border of the layer.</p><p>因此，对于背景色、边框，只需要 <code>view.layer.cornerRadius = 10.0;</code> 就可以设置圆角，只设置 <code>cornerRadius</code> 不会引发离屏渲染。</p><p><code>UIImageView</code> 的 <code>image</code>、<code>UILabel</code> 的 <code>text</code> 等，都属于 content 层的东西，对 content 层做圆角，除了 <code>cornerRadius</code> 还要设置 <code>layer.maskToBounds = true</code> 才有效。iOS 9 的优化，对单个图层做圆角是不会触发离屏渲染的，但如果 content 层再加上 backgroundColor 或 border 任意一个一起做圆角，就会触发离屏渲染！</p><p><code>UIImageView</code> 添加圆角：</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">@implementation</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UIImageView</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CornerRadius</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">addCornersWithRadius</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CGFloat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">radius </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">UIGraphicsBeginImageContextWithOptions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UIScreen</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mainScreen</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scale</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CGContextRef context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UIGraphicsGetCurrentContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UIBezierPath </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">UIBezierPath bezierPathWithRoundedRect</span><span class="token punctuation" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounds byRoundingCorners</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">UIRectCornerAllCorners cornerRadii</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">CGSizeMake</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">radius</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> radius</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CGContextAddPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CGPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CGContextClip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image drawInRect</span><span class="token punctuation" style="color:#393A34">:</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounds</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UIImage </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UIGraphicsGetImageFromCurrentImageContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">UIGraphicsEndImageContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> output</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="core-graphics">Core Graphics<a href="#core-graphics" class="hash-link" aria-label="Direct link to Core Graphics" title="Direct link to Core Graphics">​</a></h2><p>Core Graphics, also known as Quartz 2D, is an advanced, two-dimensional drawing engine available for iOS, tvOS and macOS application development. Quartz 2D provides low-level, lightweight 2D rendering with unmatched output fidelity regardless of display or printing device. Quartz 2D is resolution- and device-independent.</p><p>A bitmap image (or sampled image) is an array of pixels (or samples). Each pixel represents a single point in the image. JPEG, TIFF, and PNG graphics files are examples of bitmap images. Each sample in a bitmap contains one or more color components in a specified color space, plus one additional component that specifies the alpha value to indicate transparency. Each component can be from 1 to as many as 32 bits.</p><p>UIImage (UIKit): An object that manages image data in your app.</p><p>CIImage (Core Image): A representation of an image to be processed or produced by Core Image filters. You use <code>CIImage</code> objects in conjunction with other Core Image classes—such as <code>CIFilter</code>, <code>CIContext</code>, <code>CIVector</code>, and <code>CIColor</code>—to take advantage of the built-in Core Image filters when processing images. You can create <code>CIImage</code> objects with data supplied from a variety of sources, including Quartz 2D images, Core Video image buffers (<code>CVImageBuffer</code>), URL-based objects, and <code>NSData</code> objects.</p><p>CGImage (Core Graphics): A bitmap image or image mask.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="uiimagenamed-vs-uiimagecontentsoffile">UIImage(named:) vs UIImage(contentsOfFile:)<a href="#uiimagenamed-vs-uiimagecontentsoffile" class="hash-link" aria-label="Direct link to UIImage(named:) vs UIImage(contentsOfFile:)" title="Direct link to UIImage(named:) vs UIImage(contentsOfFile:)">​</a></h2><p><code>UIImage(named:)</code> This method checks the system caches for an image object with the specified name and returns the variant of that image that is best suited for the main screen. If a matching image object is not already in the cache, this method creates the image from an available asset catalog or loads it from disk. The system may purge cached image data at any time to free up memory.</p><p><code>UIImage(contentsOfFile:)</code> This method loads the image data into memory and marks it as purgeable. If the data is purged and needs to be reloaded, the image object loads that data again from the specified path.</p><p>官方文档明确说了，用 <code>UIImage(named:)</code> 加载图片后会缓存在内存中，即使 <code>UIImage *</code> 对象被自动释放池释放了，这份缓存也不会释放（缓存在系统需要的时候释放，时机不可预计）。因为缓存的原因，渲染效率会更高，但如果图像很大、数量很多，则会消耗较多的内存。加载很大的图片并一次性地使用，是没有必要做缓存的，这种情况下用 <code>UIImage(contentsOfFile:)</code> 更好。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/yianzhou/yianzhou.github.io/docs/apple/音视频、图形/graphics.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/apple/音视频、图形/core-animation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Core Animation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/apple/音视频、图形/live-streaming"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">直播</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#gui-框架" class="table-of-contents__link toc-highlight">GUI 框架</a></li><li><a href="#原理" class="table-of-contents__link toc-highlight">原理</a></li><li><a href="#离屏渲染" class="table-of-contents__link toc-highlight">离屏渲染</a></li><li><a href="#圆角" class="table-of-contents__link toc-highlight">圆角</a></li><li><a href="#core-graphics" class="table-of-contents__link toc-highlight">Core Graphics</a></li><li><a href="#uiimagenamed-vs-uiimagecontentsoffile" class="table-of-contents__link toc-highlight">UIImage(named:) vs UIImage(contentsOfFile:)</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">粤ICP备15029205号 Copyright © 2023 yianzhou</div></div></div></footer></div>
<script src="/assets/js/runtime~main.141ec53f.js"></script>
<script src="/assets/js/main.80ea6a95.js"></script>
</body>
</html>