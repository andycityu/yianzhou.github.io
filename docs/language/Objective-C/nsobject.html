<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-language docs-doc-id-Objective-C/nsobject">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">NSObject | yianzhou</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://yianzhou.github.io/docs/language/Objective-C/nsobject"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-language-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-language-current"><meta data-rh="true" property="og:title" content="NSObject | yianzhou"><meta data-rh="true" name="description" content="NSObject 内存布局"><meta data-rh="true" property="og:description" content="NSObject 内存布局"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yianzhou.github.io/docs/language/Objective-C/nsobject"><link data-rh="true" rel="alternate" href="https://yianzhou.github.io/docs/language/Objective-C/nsobject" hreflang="en"><link data-rh="true" rel="alternate" href="https://yianzhou.github.io/docs/language/Objective-C/nsobject" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.6a91212d.css">
<link rel="preload" href="/assets/js/runtime~main.9304b96e.js" as="script">
<link rel="preload" href="/assets/js/main.829980c8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="yianzhou" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="yianzhou" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">yianzhou</b></a><a class="navbar__item navbar__link" href="/docs/apple">Apple</a><a class="navbar__item navbar__link" href="/docs/dev">开发</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/language">编程语言</a><a class="navbar__item navbar__link" href="/docs/flutter">Flutter</a><a class="navbar__item navbar__link" href="/docs/insights">Insights</a><a class="navbar__item navbar__link" href="/docs/codes">Codes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yianzhou/yianzhou.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/language/Effective Objective-C/effective-oc-1">Effective Objective-C</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/language/JavaScript">JavaScript</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/language/Objective-C/nsobject">Objective-C</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/language/Objective-C/nsobject">NSObject</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/language/Objective-C/kvo">KVO</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/language/Objective-C/category">Category</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/language/Objective-C/block">Block</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/language/Objective-C/runtime">Runtime</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/language/Objective-C/runloop">RunLoop</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/language/Objective-C/gcd">GCD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/language/Objective-C/code-review">Code Review</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/language/Swift">Swift</a><button aria-label="Toggle the collapsible sidebar category &#x27;Swift&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/language">C</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/language/cmake">CMake</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/language/cpp">C++</a><button aria-label="Toggle the collapsible sidebar category &#x27;C++&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/language/dart">Dart</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/language/linux-cmd-line">The Linux Command Line</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/language/python">Python</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/language/regex">Regex</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/language/ruby">Ruby</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/language/sql">SQL</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Objective-C</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">NSObject</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>NSObject</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nsobject-内存布局">NSObject 内存布局<a href="#nsobject-内存布局" class="hash-link" aria-label="Direct link to NSObject 内存布局" title="Direct link to NSObject 内存布局">​</a></h2><p>下载 objc 源码：<a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener noreferrer">https://opensource.apple.com/tarballs/objc4/</a>，github 仓库：<a href="https://github.com/opensource-apple/objc4" target="_blank" rel="noopener noreferrer">https://github.com/opensource-apple/objc4</a></p><p>下载 CoreFoundation 源码：<a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener noreferrer">https://opensource.apple.com/tarballs/CF/</a>，github 仓库：<a href="https://github.com/opensource-apple/CF" target="_blank" rel="noopener noreferrer">https://github.com/opensource-apple/CF</a></p><p>OC 代码经过编译器的 rewrite 后，会变成 C/C++代码，这是 OC 的底层。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重写 <code>main.m</code> 文件：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NSObject </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NSObject alloc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>产出 <code>main.cpp</code> 文件：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NSObject </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NSObject </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SEL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">objc_msgSend</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NSObject </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SEL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">objc_msgSend</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">objc_getClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;NSObject&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sel_registerName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;alloc&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sel_registerName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;init&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>OC 的面向对象是基于 C/C++ 的数据结构实现的，在上面 <code>main.cpp</code> 文件中，找到的重写后的 <code>NSObject</code>：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">NSObject_IMPL</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class isa</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Class</code> 是什么？找到它的定义：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// An opaque type that represents an Objective-C class.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">objc_class</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Class</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>发现它是一个指针，指针在 64 位系统所占内存空间是 8 个字节。</p><p>结构体的地址，就是它里面第一个成员的地址。<code>isa</code> 指针的地址，也就是 <code>NSObject_IMPL</code> 结构体的地址。<code>isa</code> 存储的值，就是 <code>NSObject</code> 类对象的地址。</p><blockquote><p>指针存储的值是别人的内存地址。指针存储了谁的内存地址，就称为指针指向了谁。此时访问这个指针，就等同于访问指针指向的那块内存。</p></blockquote><p>下面探究 <code>NSObject</code> 占用多少内存：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">import</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression" style="color:#36acaa">malloc</span><span class="token macro property expression operator" style="color:#393A34">/</span><span class="token macro property expression" style="color:#36acaa">malloc</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">h</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">import</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression" style="color:#36acaa">objc</span><span class="token macro property expression operator" style="color:#393A34">/</span><span class="token macro property expression" style="color:#36acaa">runtime</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">h</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token string" style="color:#e3116c">&quot;%zd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">class_getInstanceSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NSObject class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// `sizeof(type)` yields the size in bytes of the object representation of type.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token string" style="color:#e3116c">&quot;%zd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NSObject class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Returns size of given ptr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NSObject </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NSObject alloc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token string" style="color:#e3116c">&quot;%zd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__bridge </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 objc 源码中找到 <code>class_getInstanceSize</code> 的实现：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">objc-class.mm</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">size_t </span><span class="token function" style="color:#d73a49">class_getInstanceSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Class cls</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">cls</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cls</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">alignedInstanceSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Class&#x27;s ivar size rounded up to a pointer-size boundary.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alignedInstanceSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">word_align</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">unalignedInstanceSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 传入未对齐的内存大小，返回对齐后的内存大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">word_align</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> WORD_MASK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">WORD_MASK</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>class_getInstanceSize</code> 得到的值是一个对象的所有实例变量<strong>经过内存对齐后</strong>所需的内存。</li><li><code>sizeof</code> 是编译期的运算符，在编译期计算出操作数的所需内存。</li><li><code>malloc_size</code> 得到的值是运行时系统实际分配的值。</li></ul><p>下面看看对象是怎么分配内存的，<code>alloc</code> 方法的描述：For historical reasons, <code>alloc</code> invokes <code>allocWithZone:</code>.</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">NSObject.mm</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">allocWithZone</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_NSZone</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">zone </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_objc_rootAllocWithZone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">malloc_zone_t </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">zone</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">objc-runtime-new.mm</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NEVER_INLINE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id </span><span class="token function" style="color:#d73a49">_objc_rootAllocWithZone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Class cls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> malloc_zone_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">zone __unused</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// allocWithZone under __OBJC2__ ignores the zone parameter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_class_createInstanceFromZone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         OBJECT_CONSTRUCT_CALL_BADALLOC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> ALWAYS_INLINE id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">_class_createInstanceFromZone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Class cls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size_t extraBytes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">zone</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> construct_flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> OBJECT_CONSTRUCT_NONE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> cxxConstruct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              size_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">outAllocatedSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cls</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">instanceSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">extraBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 获取应该分配的内存大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">calloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 分配内存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">objc-runtime-new.h</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> size_t </span><span class="token function" style="color:#d73a49">instanceSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size_t extraBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alignedInstanceSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> extraBytes</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// CF requires all objects be at least 16 bytes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过阅读源码得知，<code>CoreFoundation</code> 要求所有对象至少分配 16 个字节，属于框架的硬性规定。因此，64 位系统上， <code>NSObject</code> 分配了 16 字节内存，但其内部只用了 8 字节。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="查看内存">查看内存<a href="#查看内存" class="hash-link" aria-label="Direct link to 查看内存" title="Direct link to 查看内存">​</a></h2><p><img loading="lazy" alt="img" src="/assets/images/6A9EF225-BA47-474F-A185-D30A64F8F36D-e84fc9fbf00dbb0f4d3ff116849bd0ac.png" width="2312" height="1354" class="img_ev3q"></p><p><img loading="lazy" alt="img" src="/assets/images/9F200769-7F69-42BC-8E10-A82A1D66A8AB-d9e7ebdf325e7038ca0290f0872eb0a6.png" width="2832" height="1024" class="img_ev3q"></p><p>这里显示的数字是 16 进制，<code>16 * 16 = 2 ^ 8 = 256</code>，<strong>两个 16 进制数表示一个字节</strong>，可以看到前 8 个字节是对象的内容，后 8 个字节没有内容、全是 0。</p><p>lldb 指令 <code>memory read</code> 可以读取内存中的数据，简写 <code>x</code>：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Printing description of obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">NSObject</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x600002764480</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lldb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> x </span><span class="token number" style="color:#36acaa">0x600002764480</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x600002764480</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> e8 b6 </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">b </span><span class="token number" style="color:#36acaa">86</span><span class="token plain"> ff </span><span class="token number" style="color:#36acaa">7f</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">K</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x600002764490</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">90</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">44</span><span class="token plain"> ac </span><span class="token number" style="color:#36acaa">54</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">b </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">49</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">D</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">1.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">K</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">I</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>x/nuf &lt;addr&gt;</code>:</p><ul><li>n 表示要显示的内存单元的个数</li><li>u 表示一个内存单元的长度，g 对应 8 个字节</li><li>f 表示显示方式，x 代表 16 进制</li></ul><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Printing description of obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">NSObject</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1060ac280</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lldb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> x</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">g </span><span class="token number" style="color:#36acaa">0x1060ac280</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x1060ac280</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x010000021de7e331</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0000000000000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x1060ac290</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6b636950534e5b2d</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x426863756f547265</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="person-内存布局">Person 内存布局<a href="#person-内存布局" class="hash-link" aria-label="Direct link to Person 内存布局" title="Direct link to Person 内存布局">​</a></h2><p>现扩展到 <code>Person</code> 类，</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">@interface</span><span class="token plain"> Person </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NSObject </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">@public</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> _age</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">@end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同样地将 <code>main.cpp</code> 重写为 C++ 代码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Person_IMPL</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">NSObject_IMPL</span><span class="token plain"> NSObject_IVARS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 8个字节</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> _age</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 4个字节</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>明明只需要 12 个字节，为什么获取实例大小返回 16 呢？这是因为内存对齐。内存对齐要求，结构体的内存大小必须是其<strong>最大成员的大小的整数倍</strong>。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token string" style="color:#e3116c">&quot;%zd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">class_getInstanceSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Person class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>给 <code>_age</code> 赋值为 4，然后查看内存，</p><p><img loading="lazy" alt="img" src="/assets/images/3B570F72-51B6-4EE3-B919-07E824EBE6AC-23227e647cd619d006a8e138cea88a6b.png" width="2220" height="974" class="img_ev3q"></p><p>现代计算机都是<strong>小端序</strong> (Little-Endian)，即，一个多位数的低位放在较小的地址处，高位放在较大的地址处。</p><p>所以这里的内存读取出来不是 <code>0x40000000</code>，而是 <code>0x00000004</code>。</p><p>将 <code>Person</code> 里的实例变量改为属性：</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">@interface</span><span class="token plain"> Person </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NSObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">@property</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nonatomic</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> assign</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> age</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">@end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它重写后的结构体还是和上面的 <code>Person_IMPL</code> 一样，不会有变化。而 <code>getter</code> 和 <code>setter</code> 则变成了函数，这些函数会存在类对象的方法列表里面，以供调用：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_I_Person_age</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Person </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SEL _cmd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">self </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> OBJC_IVAR_$_Person$_age</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// self 指针偏移 8 个字节</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_I_Person_setAge_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Person </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SEL _cmd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> age</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">self </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> OBJC_IVAR_$_Person$_age</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> age</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>类可以被实例化成无数对象，因此结构体里面只存成员变量，实例方法在内存中有一份就够了，实例方法是不可能放在结构体里存的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="self-是什么">self 是什么<a href="#self-是什么" class="hash-link" aria-label="Direct link to self 是什么" title="Direct link to self 是什么">​</a></h2><p>从上面重写后的 <code>getAge</code> 和 <code>setAge</code> 函数可以看到，函数的参数有两个，分别是 <code>self</code> 和 <code>_cmd</code>。所有的 OC 方法，其底层函数都有这两个参数。</p><ul><li><code>self</code> 实际上就是一个<strong>局部变量</strong>，它是指向当前对象的指针。</li><li><code>_cmd</code> 表示当前方法的 selector，即 <code>_cmd == @selector(age)</code></li></ul><blockquote><p>现代计算机，函数的实参并不是放在栈空间，而是放在 CPU 的寄存器，这样效率更高，这点要注意。</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="student-内存布局">Student 内存布局<a href="#student-内存布局" class="hash-link" aria-label="Direct link to Student 内存布局" title="Direct link to Student 内存布局">​</a></h2><p>再扩展到 <code>Student</code> 类，</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">@interface</span><span class="token plain"> Student </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Person </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">@public</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> _no</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">@end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其底层实现为：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Student_IMPL</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Person_IMPL</span><span class="token plain"> Person_IVARS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 12个字节</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> _no</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 4个字节</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时 <code>Student</code> 占用 16 个字节，</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Student </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">stu </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Student alloc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%zd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__bridge </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">stu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>题外话：我们可以将 oc 对象的指针转为其底层结构体的指针，因为内存布局相同。</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Student </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">stu </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Student alloc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stu</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">_no </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> Student_IMPL </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">stuIMP </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__bridge </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> Student_IMPL </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">stu</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stuIMP</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">_no</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果给 <code>Student</code> 再增加一个成员变量 <code>int _gender</code>，那么我们会发现：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Student </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">stu </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Student alloc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token string" style="color:#e3116c">&quot;%zd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">class_getInstanceSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Student class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 24</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token string" style="color:#e3116c">&quot;%zd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Student class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 24</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">@</span><span class="token string" style="color:#e3116c">&quot;%zd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__bridge </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">stu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 32</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于内存对齐，<code>Student_IMPL</code> 结构体的大小是它的最大的成员变量大小，即 <code>struct Person_IMPL</code> 12 个字节的整数倍，因此是 24 个字节。</p><p>但实际上系统为其分配了 32 个字节，这是为什么呢？要到 <code>calloc</code> 的源码里找答案。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="内存分配">内存分配<a href="#内存分配" class="hash-link" aria-label="Direct link to 内存分配" title="Direct link to 内存分配">​</a></h2><p>下载 libmalloc 源码：<a href="https://opensource.apple.com/tarballs/libmalloc/" target="_blank" rel="noopener noreferrer">https://opensource.apple.com/tarballs/libmalloc/</a></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">malloc.c</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token function" style="color:#d73a49">calloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">size_t</span><span class="token plain"> num_items</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_malloc_zone_calloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default_zone</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num_items</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MZ_POSIX</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里的 <code>size</code>，调用方传多少，系统就给多少吗？例如调用方传 17，系统就会分配 17 个字节的连续内存吗？显然不是的。在 64 位系统里，指针的地址是 64 位即 8 个字节，CPU 在寻址的时候，自然是按照 8 的倍数来寻址比较方便。也就是说，系统在分配内存时，也会考虑内存对齐。</p><p>由于源码比较复杂，这里只说结论，看这段代码：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">nano_zone_common.h</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">NANO_MAX_SIZE</span><span class="token macro property" style="color:#36acaa">           </span><span class="token macro property expression number" style="color:#36acaa">256</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* Buckets sized {16, 32, 48, ..., 256} */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里我们可以把系统管理的<strong>堆区内存</strong>，想象成一个个的桶 (bucket)，每个桶的大小都是 16 的倍数，当向系统申请内存时，系统会找一个能装下你申请的 size 的最小的桶分配给你。</p><p>并且，我们筛选 &quot;malloc.c&quot; 文件，会发现有好多个这样的文件，其实是在不同的情况下，系统会调用不同的 <code>malloc</code> 方法分配内存：</p><p><img loading="lazy" alt="img" src="/assets/images/F8BD3EE3-32E7-41B9-B57F-9687E0DBEAEE-9b2b85ce00f600575f45d8a6c4d0659b.png" width="596" height="450" class="img_ev3q"></p><p>实际上 &quot;nano&quot; 这种分配方式最大能分配的内存大小就是 <code>NANO_MAX_SIZE</code>，即 256 字节，超出这个大小的，就用其它的分配方式。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="isa-和-superclass-指针">isa 和 superclass 指针<a href="#isa-和-superclass-指针" class="hash-link" aria-label="Direct link to isa 和 superclass 指针" title="Direct link to isa 和 superclass 指针">​</a></h2><p><img loading="lazy" alt="img" src="/assets/images/F8FDE1E6-025F-4A14-8464-2B6561648EE4-ab3f5b060669be8ad819d0f004eeee28.png" width="1638" height="1692" class="img_ev3q"></p><p>任何类的元类对象的 <code>isa</code> 指针，都指向 <code>NSObject</code> 的元类对象。</p><p><code>superclass</code> 指针向上指向父类，除了 <code>NSObject</code> 的元类对象指向 <code>NSObject</code> 的类对象。</p><p><img loading="lazy" alt="img" src="/assets/images/F757D5D0-06D2-43CE-B18C-882384B98C7E-2183f6c9d348ac5853716f94b902f5dc.png" width="2288" height="416" class="img_ev3q"></p><blockquote><p><code>p/x</code> 表示按十六进制输出</p></blockquote><p>看上图，<code>obj</code> 实例对象的 <code>isa</code> 指针，应该存放类对象的内存地址 <code>0x1da9a6710</code>，但实际上它的值却是 <code>0x01000001da9a6711</code>，这是为什么呢？</p><p>注意，在 64 位机器上，isa 需要进行一次位运算，才能得到真实的地址。打开 objc 源码可以找到这个 <code>ISA_MASK</code>：</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">isa.h</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">__arm64__</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa">   </span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">__has_feature</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">ptrauth_calls</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">||</span><span class="token macro property expression" style="color:#36acaa"> TARGET_OS_SIMULATOR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa">     </span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">ISA_MASK</span><span class="token macro property" style="color:#36acaa">        </span><span class="token macro property expression number" style="color:#36acaa">0x007ffffffffffff8ULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa">   </span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa">     </span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">ISA_MASK</span><span class="token macro property" style="color:#36acaa">        </span><span class="token macro property expression number" style="color:#36acaa">0x0000000ffffffff8ULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">elif</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">__x86_64__</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa">   </span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">ISA_MASK</span><span class="token macro property" style="color:#36acaa">        </span><span class="token macro property expression number" style="color:#36acaa">0x00007ffffffffff8ULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa">   </span><span class="token macro property directive keyword" style="color:#00009f">error</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">unknown architecture </span><span class="token macro property expression keyword" style="color:#00009f">for</span><span class="token macro property expression" style="color:#36acaa"> packed isa</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>即，需要将 <code>isa</code> 指针的地址，<code>&amp; ISA_MASK</code> 运算之后，才能得到真正的类对象的地址：</p><div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(lldb) expr 0x01000001da9a6711 &amp; 0x007ffffffffffff8ULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(unsigned long long) $1 = 7962519312</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(lldb) p/x 7962519312</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(long) $2 = 0x00000001da9a6710</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>super_class</code> 指针的地址则不用进行这样的位运算转换。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="内存对齐">内存对齐<a href="#内存对齐" class="hash-link" aria-label="Direct link to 内存对齐" title="Direct link to 内存对齐">​</a></h2><p>内存是一个巨大的字节数组，理论上，对变量的访问可以从任何地址开始。但是实际上，计算机并不能直接按任意地址来读写内存，而是以 4 字节、8 字节、16 字节这样的单位来读写内存，称为<strong>内存存取粒度</strong>。</p><p>以 4 字节的粒度为例，如果我们存放了一个 4 字节的数据在地址 0，那么计算机只需一次访问就能读取到；但如果我们存放一个 4 字节的数据在地址 1，计算机就需要两次读取、再移位、合并，才能读取到这个数据，计算量增加了很多。</p><p><img loading="lazy" alt="img" src="data:image/jpeg;base64,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" width="377" height="133" class="img_ev3q"></p><p><img loading="lazy" alt="img" src="/assets/images/C7C02E5C-4CC5-427D-AC3A-74BE99496B63-7d290ba8808587ea29f65fcf5c9e5bc3.jpeg" width="378" height="207" class="img_ev3q"></p><p>因此，编译器会对基本数据类型的合法地址作出一些限制，即内存地址必须是 4、8、16 的倍数，称为<strong>内存对齐</strong>，这个倍数称为<strong>对齐系数</strong>。</p><p>为了学习内存对齐，除了苹果系统，我们也可以看看 Linux 系统的实现。Linux 系统使用的是 GNU 开源的代码，GNU 这个组织开源了大量优秀的代码。</p><blockquote><p>GNU is a recursive acronym for &quot;GNU&#x27;s Not Unix!&quot;, chosen because GNU&#x27;s design is Unix-like, but differs from Unix by being free software and containing no Unix code.</p></blockquote><p>下载 glibc 源码：<a href="https://www.gnu.org/software/libc/sources.html" target="_blank" rel="noopener noreferrer">https://www.gnu.org/software/libc/sources.html</a></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">sysdeps/i386/malloc-alignment.h</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 在 i386 架构下，内存对齐系数是 16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">MALLOC_ALIGNMENT</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">sysdeps/generic/malloc-alignment.h</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* MALLOC_ALIGNMENT is the minimum alignment for malloc&#x27;ed chunks.  It</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   must be a power of two at least 2 * SIZE_SZ, even on machines for</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   which smaller alignments would suffice. It may be defined as larger</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   than this though. Note however that code and data structures are</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   optimized for the case of 8-byte alignment.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">MALLOC_ALIGNMENT</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">2</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression" style="color:#36acaa"> SIZE_SZ </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">__alignof__</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression keyword" style="color:#00009f">long</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">double</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">              </span><span class="token macro property expression operator" style="color:#393A34">?</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">__alignof__</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression keyword" style="color:#00009f">long</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">double</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">:</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">2</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression" style="color:#36acaa"> SIZE_SZ</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">sysdeps/generic/malloc-size.h</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifndef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">INTERNAL_SIZE_T</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">INTERNAL_SIZE_T</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">size_t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* The corresponding word size.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">SIZE_SZ</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression keyword" style="color:#00009f">sizeof</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">INTERNAL_SIZE_T</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>虽然 glibc 的源码我们没法跑，但我们可以放到 Xcode 里尝试跑一下：</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%zd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%zd&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__alignof__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>基本可以肯定，在通用架构下，内存对齐系数都是 16。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="类对象与元类对象">类对象与元类对象<a href="#类对象与元类对象" class="hash-link" aria-label="Direct link to 类对象与元类对象" title="Direct link to 类对象与元类对象">​</a></h2><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">NSObject.mm</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">object_getClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从 objc 源码实现可知，无论是 <code>-class</code> 还是 <code>+class</code>，返回的都是类对象，它不会返回元类对象，所以不管你怎么调、调多少次，结果都一样的。</p><div class="language-objc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">import</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;</span><span class="token macro property expression" style="color:#36acaa">objc</span><span class="token macro property expression operator" style="color:#393A34">/</span><span class="token macro property expression" style="color:#36acaa">runtime</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">h</span><span class="token macro property expression operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">@implementation</span><span class="token plain"> ViewController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">load </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%p&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 0x10468c4c0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%p&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">self</span><span class="token plain"> class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 0x10468c4c0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">viewDidLoad </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">super</span><span class="token plain"> viewDidLoad</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class classObj1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">self</span><span class="token plain"> class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class classObj2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ViewController class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class classObj3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ViewController class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class classObj4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">object_getClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class classObj5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NSClassFromString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;ViewController&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%p %p %p %p %p&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classObj1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classObj2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classObj3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classObj4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classObj5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 0x1040992d0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 要取到元类对象，需调用 object_getClass 并传入类对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class meta_class_obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">object_getClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classObj1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%p&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> meta_class_obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">class_isMetaClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classObj1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">@&quot;%d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">class_isMetaClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meta_class_obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">@end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>instance object: 实例对象。实例对象的 <code>isa</code> 指针，指向类对象。</p><p>class object: 类对象，实例方法存放在这。类对象的 <code>isa</code> 指针，指向元类对象。</p><p>meta-class object: 元类对象，类方法存放在这。<strong>元类对象是一种特殊的类对象</strong>。</p><p>class object 和 meta-class object 的内存结构是一样的，它们都是 <code>struct objc_class</code>，但是两者用途不一样。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">objc.h</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">objc_class</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Class</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">objc_object</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">objc_object</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>旧的 <code>objc_class</code> 结构体在 <code>runtime.h</code> 文件，在 objc2 之后已经废弃了，新的会复杂很多：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">objc-runtime-new.h</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">objc_class</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">objc_object</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// cpp的语法，结构体继承</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Class ISA; // isa 指针，继承自父类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class superclass</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// superclass 指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache_t cache</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// formerly cache pointer and vtable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    class_data_bits_t bits</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// class_rw_t * plus custom rr/alloc flags</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    class_rw_t </span><span class="token operator" style="color:#393A34">*</span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// class read-write table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> bits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">class_rw_t</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> class_ro_t </span><span class="token operator" style="color:#393A34">*</span><span class="token function" style="color:#d73a49">ro</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// class readonly table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> method_array_t </span><span class="token function" style="color:#d73a49">methods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 方法列表（二维数组）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> property_array_t </span><span class="token function" style="color:#d73a49">properties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 属性列表（二维数组）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> protocol_array_t </span><span class="token function" style="color:#d73a49">protocols</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 协议列表（二维数组）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// 在这个只读的结构体中存了一份类本身的、未经过 Runtime 附加各种分类方法的原始方法列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">class_ro_t</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> instanceSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 实例对象大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    explicit_atomic</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 类名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">baseMethodList</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol_list_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> baseProtocols</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ivar_list_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ivars</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    property_list_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">baseProperties</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">class_data_bits_t</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uintptr_t bits</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    class_rw_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">class_rw_t </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bits </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> FAST_DATA_MASK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>类编译好了之后，其成员变量、属性、协议、方法信息存储在只读的 <code>class_ro_t</code> 里，运行时取出 <code>class_ro_t</code> 的信息，与分类、动态添加方法等信息合并，变成 <code>class_rw_t</code>。</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">objc-runtime-new.mm</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> Class </span><span class="token function" style="color:#d73a49">realizeClassWithoutSwift</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Class cls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Class previously</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> ro </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> class_ro_t </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">cls</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Normal class. Allocate writeable class data.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> objc</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#d73a49">zalloc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">class_rw_t</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">set_ro</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ro</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rw</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RW_REALIZED</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">RW_REALIZING</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">isMeta</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cls</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">setData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rw</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/language/JavaScript"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">JavaScript</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/language/Objective-C/kvo"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">KVO</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#nsobject-内存布局" class="table-of-contents__link toc-highlight">NSObject 内存布局</a></li><li><a href="#查看内存" class="table-of-contents__link toc-highlight">查看内存</a></li><li><a href="#person-内存布局" class="table-of-contents__link toc-highlight">Person 内存布局</a></li><li><a href="#self-是什么" class="table-of-contents__link toc-highlight">self 是什么</a></li><li><a href="#student-内存布局" class="table-of-contents__link toc-highlight">Student 内存布局</a></li><li><a href="#内存分配" class="table-of-contents__link toc-highlight">内存分配</a></li><li><a href="#isa-和-superclass-指针" class="table-of-contents__link toc-highlight">isa 和 superclass 指针</a></li><li><a href="#内存对齐" class="table-of-contents__link toc-highlight">内存对齐</a></li><li><a href="#类对象与元类对象" class="table-of-contents__link toc-highlight">类对象与元类对象</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">粤ICP备15029205号 Copyright © 2023 yianzhou</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9304b96e.js"></script>
<script src="/assets/js/main.829980c8.js"></script>
</body>
</html>